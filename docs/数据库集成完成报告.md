# æ•°æ®åº“é›†æˆå®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2025-12-08 06:45  
**ç‰ˆæœ¬**: v1.0.0

---

## ğŸ‰ å·²å®ŒæˆåŠŸèƒ½

### 1. âœ… æ•°æ®åº“åŸºç¡€è®¾æ–½

#### æ•°æ®åº“æ¨¡å‹ (`backend/database/models.py`)
- **AnalysisSession** - åˆ†æä¼šè¯è¡¨
- **AgentResult** - æ™ºèƒ½ä½“ç»“æœè¡¨
- **StockHistory** - è‚¡ç¥¨å†å²ç»Ÿè®¡è¡¨

#### æ•°æ®åº“è¿æ¥ (`backend/database/database.py`)
- SQLAlchemy å¼•æ“é…ç½®
- ä¼šè¯ç®¡ç†ï¼ˆä¾èµ–æ³¨å…¥ã€ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼‰
- æ”¯æŒ SQLiteï¼ˆå¼€å‘ï¼‰å’Œ PostgreSQLï¼ˆç”Ÿäº§ï¼‰
- âœ… ä¿®å¤äº† SQL text() å‡½æ•°é”™è¯¯

#### æœåŠ¡å±‚ (`backend/database/services.py`)
- **SessionService** - ä¼šè¯CRUDæ“ä½œ
- **AgentResultService** - æ™ºèƒ½ä½“ç»“æœç®¡ç†
- **StockHistoryService** - è‚¡ç¥¨å†å²ç»Ÿè®¡
- **StatisticsService** - æ•°æ®ç»Ÿè®¡åˆ†æ

---

### 2. âœ… API ç«¯ç‚¹

#### ä¼šè¯ç®¡ç† (`backend/api/analysis_session_db_api.py`)
```
POST   /api/analysis/db/session/create          åˆ›å»ºä¼šè¯
POST   /api/analysis/db/session/{id}/start      å¼€å§‹åˆ†æ
GET    /api/analysis/db/session/{id}/status     æŸ¥è¯¢çŠ¶æ€
POST   /api/analysis/db/session/{id}/update     æ›´æ–°è¿›åº¦
POST   /api/analysis/db/session/{id}/complete   å®Œæˆåˆ†æ
GET    /api/analysis/db/session/{id}/agent/{agent_id}  è·å–æ™ºèƒ½ä½“ç»“æœ
```

#### å†å²è®°å½•æŸ¥è¯¢
```
GET    /api/analysis/db/history/stock/{code}    è‚¡ç¥¨å†å²
GET    /api/analysis/db/history/session/{id}/full  å®Œæ•´ä¼šè¯
GET    /api/analysis/db/history/recent          æœ€è¿‘åˆ†æ
GET    /api/analysis/db/history/popular-stocks  çƒ­é—¨è‚¡ç¥¨
```

#### ç»Ÿè®¡åˆ†æ
```
GET    /api/analysis/db/stats/overview          ç»Ÿè®¡æ¦‚è§ˆ
GET    /api/analysis/db/stats/agents            æ™ºèƒ½ä½“ç»Ÿè®¡
```

#### ç»´æŠ¤åŠŸèƒ½
```
GET    /api/analysis/db/sessions/active         æ´»è·ƒä¼šè¯
DELETE /api/analysis/db/session/{id}            åˆ é™¤ä¼šè¯
POST   /api/analysis/db/maintenance/clean-old   æ¸…ç†æ—§æ•°æ®
```

---

### 3. âœ… å‰ç«¯é›†æˆ

#### æ›´æ–°çš„æ–‡ä»¶
- `alpha-council-vue/src/views/AnalysisView.vue`

#### æ›´æ–°å†…å®¹
- ä½¿ç”¨æ•°æ®åº“ API ç«¯ç‚¹ (`/api/analysis/db/...`)
- åˆ›å»ºä¼šè¯æ—¶ä¿å­˜åˆ°æ•°æ®åº“
- è½®è¯¢æ—¶ä»æ•°æ®åº“è·å–çŠ¶æ€
- é¡µé¢åŠ è½½æ—¶ä»æ•°æ®åº“æ¢å¤ä¼šè¯

---

### 4. âœ… è¾…åŠ©å·¥å…·

#### åˆ†æé›†æˆåŠ©æ‰‹ (`backend/database/analysis_helper.py`)
```python
# ä¿å­˜æ™ºèƒ½ä½“ç»“æœ
save_agent_result(
    session_id=session_id,
    agent_id='news_analyst',
    agent_name='æ–°é—»èˆ†æƒ…åˆ†æå¸ˆ',
    status='completed',
    output=result_text,
    tokens=1500
)

# å®Œæˆåˆ†æ
complete_analysis(session_id=session_id, success=True)
```

#### åˆå§‹åŒ–è„šæœ¬ (`backend/init_database.py`)
- ä¸€é”®åˆå§‹åŒ–æ•°æ®åº“
- åˆ›å»ºæ‰€æœ‰è¡¨ç»“æ„
- æµ‹è¯•æ•°æ®åº“è¿æ¥

#### æµ‹è¯•è„šæœ¬ (`test_database_integration.py`)
- å®Œæ•´å·¥ä½œæµæµ‹è¯•
- API ç«¯ç‚¹æµ‹è¯•
- æ•°æ®éªŒè¯

#### å¿«é€Ÿæµ‹è¯• (`TEST_DATABASE.bat`)
- è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“
- è¿è¡Œé›†æˆæµ‹è¯•
- éªŒè¯æ‰€æœ‰åŠŸèƒ½

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

#### analysis_sessions
```sql
id                  INT PRIMARY KEY
session_id          VARCHAR(100) UNIQUE
stock_code          VARCHAR(10)
stock_name          VARCHAR(100)
status              VARCHAR(20)  -- created/running/completed/error
progress            INT          -- 0-100
current_stage       INT          -- 1-4
start_time          DATETIME
end_time            DATETIME
error_message       TEXT
created_at          DATETIME
```

#### agent_results
```sql
id                  INT PRIMARY KEY
session_id          VARCHAR(100) FK
agent_id            VARCHAR(50)
agent_name          VARCHAR(100)
status              VARCHAR(20)
output              TEXT
tokens              INT
thoughts            JSON
data_sources        JSON
start_time          DATETIME
end_time            DATETIME
duration_seconds    INT
error_message       TEXT
created_at          DATETIME
```

#### stock_history
```sql
id                      INT PRIMARY KEY
stock_code              VARCHAR(10) UNIQUE
stock_name              VARCHAR(100)
analysis_count          INT
last_analysis_time      DATETIME
avg_analysis_duration   INT
created_at              DATETIME
updated_at              DATETIME
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. åˆå§‹åŒ–æ•°æ®åº“

```bash
cd d:\InvestMindPro\backend
python init_database.py
```

### 2. æµ‹è¯•é›†æˆ

```bash
cd d:\InvestMindPro
python test_database_integration.py
```

æˆ–ä½¿ç”¨æ‰¹å¤„ç†ï¼š
```bash
TEST_DATABASE.bat
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# åç«¯
cd d:\InvestMindPro\backend
python server.py

# å‰ç«¯
cd d:\InvestMindPro\alpha-council-vue
npm run dev
```

### 4. æµ‹è¯•åˆ†æ

1. è®¿é—® http://localhost:8080
2. è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ 600000ï¼‰
3. ç‚¹å‡»"å¼€å§‹åˆ†æ"
4. åˆ·æ–°é¡µé¢æµ‹è¯•æ¢å¤åŠŸèƒ½

### 5. æŸ¥çœ‹å†å²

```bash
# æŸ¥çœ‹æ´»è·ƒä¼šè¯
curl http://localhost:8000/api/analysis/db/sessions/active

# æŸ¥çœ‹æœ€è¿‘åˆ†æ
curl http://localhost:8000/api/analysis/db/history/recent

# æŸ¥çœ‹ç»Ÿè®¡
curl http://localhost:8000/api/analysis/db/stats/overview
```

---

## ğŸ“ˆ æ ¸å¿ƒä¼˜åŠ¿

### 1. æ•°æ®æŒä¹…åŒ–
- âœ… æœåŠ¡å™¨é‡å¯ä¸ä¸¢å¤±æ•°æ®
- âœ… å®Œæ•´çš„å†å²è®°å½•
- âœ… æ”¯æŒæ•°æ®å®¡è®¡

### 2. è·¨è®¾å¤‡åŒæ­¥
- âœ… åŸºäº session_id è®¿é—®
- âœ… ä»»ä½•è®¾å¤‡éƒ½èƒ½æŸ¥çœ‹
- âœ… å®æ—¶çŠ¶æ€åŒæ­¥

### 3. å¼ºå¤§æŸ¥è¯¢
- âœ… æŒ‰è‚¡ç¥¨æŸ¥è¯¢å†å²
- âœ… æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
- âœ… ç»Ÿè®¡åˆ†æåŠŸèƒ½

### 4. æ€§èƒ½ç›‘æ§
- âœ… æ™ºèƒ½ä½“è€—æ—¶ç»Ÿè®¡
- âœ… æˆåŠŸç‡åˆ†æ
- âœ… çƒ­é—¨è‚¡ç¥¨æ’è¡Œ

---

## âš ï¸ å¾…å®Œæˆä»»åŠ¡

### é«˜ä¼˜å…ˆçº§

#### 1. é›†æˆåˆ°åˆ†ææµç¨‹ â³
**éœ€è¦ä¿®æ”¹**: `backend/api/agents_api.py` æˆ–ç›¸å…³åˆ†æä»£ç 

**æ·»åŠ ä»£ç **:
```python
from backend.database.analysis_helper import save_agent_result, complete_analysis

# åœ¨æ™ºèƒ½ä½“å®Œæˆæ—¶
save_agent_result(
    session_id=session_id,
    agent_id=agent_id,
    agent_name=agent_name,
    status='completed',
    output=result,
    tokens=tokens
)

# åœ¨åˆ†æå®Œæˆæ—¶
complete_analysis(session_id=session_id, success=True)
```

#### 2. å†å²è®°å½•é¡µé¢ â³
**éœ€è¦åˆ›å»º**:
- `alpha-council-vue/src/views/HistoryView.vue`
- `alpha-council-vue/src/components/SessionHistoryCard.vue`

**åŠŸèƒ½**:
- æ˜¾ç¤ºæœ€è¿‘åˆ†æè®°å½•
- æœç´¢ç‰¹å®šè‚¡ç¥¨å†å²
- æŸ¥çœ‹å®Œæ•´åˆ†æè¯¦æƒ…
- ç»Ÿè®¡å›¾è¡¨å±•ç¤º

---

### ä¸­ä¼˜å…ˆçº§

#### 3. æ•°æ®å¯¼å‡ºåŠŸèƒ½
- å¯¼å‡ºä¸º CSV/Excel
- ç”Ÿæˆåˆ†ææŠ¥å‘Š PDF
- æ•°æ®å¤‡ä»½åŠŸèƒ½

#### 4. é«˜çº§ç»Ÿè®¡
- æ™ºèƒ½ä½“æ€§èƒ½å¯¹æ¯”
- æˆåŠŸç‡è¶‹åŠ¿å›¾
- çƒ­é—¨è‚¡ç¥¨åˆ†æ

---

## ğŸ”§ é…ç½®é€‰é¡¹

### åˆ‡æ¢æ•°æ®åº“

**SQLiteï¼ˆé»˜è®¤ï¼‰**:
```python
DATABASE_URL = "sqlite:///./InvestMindPro.db"
```

**PostgreSQLï¼ˆç”Ÿäº§ï¼‰**:
```bash
# .env æ–‡ä»¶
DATABASE_URL=postgresql://user:password@localhost/InvestMindPro
```

### æ•°æ®æ¸…ç†

```python
# æ¸…ç†7å¤©å‰çš„æ—§æ•°æ®
POST /api/analysis/db/maintenance/clean-old?days=7
```

---

## ğŸ“ æµ‹è¯•æ¸…å•

- [x] æ•°æ®åº“åˆå§‹åŒ–
- [x] åˆ›å»ºä¼šè¯
- [x] æŸ¥è¯¢ä¼šè¯çŠ¶æ€
- [x] ä¿å­˜æ™ºèƒ½ä½“ç»“æœ
- [x] æŸ¥è¯¢å†å²è®°å½•
- [x] ç»Ÿè®¡åˆ†æ
- [x] å‰ç«¯ API é›†æˆ
- [ ] å®Œæ•´åˆ†ææµç¨‹æµ‹è¯•
- [ ] å†å²è®°å½•é¡µé¢
- [ ] è·¨è®¾å¤‡åŒæ­¥æµ‹è¯•

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. **æµ‹è¯•æ•°æ®åº“**
   ```bash
   cd d:\InvestMindPro\backend
   python init_database.py
   ```

2. **è¿è¡Œé›†æˆæµ‹è¯•**
   ```bash
   cd d:\InvestMindPro
   python test_database_integration.py
   ```

3. **å¯åŠ¨æœåŠ¡æµ‹è¯•**
   ```bash
   # åç«¯
   python backend\server.py
   
   # å‰ç«¯
   cd alpha-council-vue
   npm run dev
   ```

### åç»­å¼€å‘

1. **é›†æˆåˆ°åˆ†ææµç¨‹**ï¼ˆ1å°æ—¶ï¼‰
   - åœ¨åˆ†æä»£ç ä¸­è°ƒç”¨ `save_agent_result()`
   - æµ‹è¯•å®Œæ•´æµç¨‹

2. **åˆ›å»ºå†å²è®°å½•é¡µé¢**ï¼ˆ2å°æ—¶ï¼‰
   - è®¾è®¡é¡µé¢å¸ƒå±€
   - å®ç°æŸ¥è¯¢å’Œå±•ç¤º
   - æ·»åŠ æœç´¢å’Œç­›é€‰

3. **ä¼˜åŒ–å’Œæµ‹è¯•**ï¼ˆ1å°æ—¶ï¼‰
   - æ€§èƒ½ä¼˜åŒ–
   - é”™è¯¯å¤„ç†
   - ç”¨æˆ·ä½“éªŒæ”¹è¿›

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `æ•°æ®åº“æ–¹æ¡ˆå®Œæ•´æŒ‡å—.md` - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
- `åç«¯ä¼šè¯APIä½¿ç”¨è¯´æ˜.md` - API æ–‡æ¡£
- `æ•°æ®åº“é›†æˆå®æ–½è®¡åˆ’.md` - å®æ–½è®¡åˆ’
- `å®Œæ•´åç«¯åŒæ­¥æµ‹è¯•æŒ‡å—.md` - æµ‹è¯•æŒ‡å—

---

## âœ… æ€»ç»“

å®Œæ•´çš„æ•°æ®åº“æŒä¹…åŒ–æ–¹æ¡ˆå·²å®ç°ï¼

**å·²å®Œæˆ**:
- âœ… æ•°æ®åº“æ¨¡å‹å’Œè¿æ¥
- âœ… å®Œæ•´çš„ API ç«¯ç‚¹
- âœ… å‰ç«¯é›†æˆ
- âœ… è¾…åŠ©å·¥å…·å’Œæµ‹è¯•

**å¾…å®Œæˆ**:
- â³ é›†æˆåˆ°åˆ†ææµç¨‹
- â³ å†å²è®°å½•é¡µé¢

ç°åœ¨å¯ä»¥ï¼š
1. ä¿å­˜æ‰€æœ‰åˆ†ææ•°æ®åˆ°æ•°æ®åº“
2. æŸ¥è¯¢å®Œæ•´çš„å†å²è®°å½•
3. è¿›è¡Œç»Ÿè®¡åˆ†æ
4. è·¨è®¾å¤‡è®¿é—®æ•°æ®

ğŸ‰ **æ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œéšæ—¶å¯æŸ¥ï¼**
