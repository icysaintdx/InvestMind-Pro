# å®æ—¶æ—¥å¿—æµåŠŸèƒ½è®¾è®¡

**éœ€æ±‚**: åœ¨æ™ºèƒ½ä½“å¡ç‰‡å†…æ˜¾ç¤ºåç«¯æ•°æ®è·å–çš„å®æ—¶æ—¥å¿—  
**åˆ›å»ºæ—¶é—´**: 2025-12-08 03:11  

---

## ğŸ“‹ éœ€æ±‚æè¿°

### å½“å‰é—®é¢˜
- æ™ºèƒ½ä½“å¡ç‰‡æ˜¾ç¤º"ç­‰å¾…åˆ†æ..."æˆ–éª¨æ¶å±
- ç”¨æˆ·ä¸çŸ¥é“åç«¯åœ¨åšä»€ä¹ˆ
- æ•°æ®è·å–è€—æ—¶é•¿ï¼ˆ3-30ç§’ï¼‰ï¼Œç”¨æˆ·ä½“éªŒå·®

### æœŸæœ›æ•ˆæœ
åœ¨æ™ºèƒ½ä½“å¡ç‰‡å†…å®æ—¶æ˜¾ç¤ºåç«¯æ—¥å¿—ï¼š
```
ğŸ“¡ æ”¶åˆ°è‚¡ç¥¨æ–°é—»è¯·æ±‚: 603211
ğŸ” å¼€å§‹è·å–603211çš„ç»¼åˆæ–°é—»æ•°æ®...
ğŸ“° [æ•°æ®æº1] å®æ—¶æ–°é—»èšåˆå™¨...
âœ… å®æ—¶æ–°é—»èšåˆå™¨æˆåŠŸ: 10æ¡
ğŸ“° [æ•°æ®æº2] AKShareä¸ªè‚¡æ–°é—»...
âœ… AKShareä¸ªè‚¡æ–°é—»æˆåŠŸ: 10æ¡
...
âœ… ç»¼åˆæ–°é—»æ•°æ®è·å–å®Œæˆ: 9/9 ä¸ªæ•°æ®æºæˆåŠŸ
```

---

## ğŸ—ï¸ æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: SSE (Server-Sent Events) â­â­â­â­â­ æ¨è

#### ä¼˜ç‚¹
- å•å‘æ¨é€ï¼Œé€‚åˆæ—¥å¿—æµ
- åŸç”Ÿæ”¯æŒæ–­çº¿é‡è¿
- å®ç°ç®€å•ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒ
- è½»é‡çº§ï¼Œæ€§èƒ½å¥½

#### å®ç°æ­¥éª¤

**åç«¯ (FastAPI)**:
```python
# backend/api/agent_logs_api.py
from fastapi import APIRouter
from fastapi.responses import StreamingResponse
import asyncio
import json

router = APIRouter(prefix="/api/agent-logs", tags=["Agent Logs"])

# å…¨å±€æ—¥å¿—é˜Ÿåˆ—ï¼ˆæ¯ä¸ªæ™ºèƒ½ä½“ä¸€ä¸ªé˜Ÿåˆ—ï¼‰
agent_log_queues = {}

async def log_stream(agent_id: str):
    """SSE æ—¥å¿—æµç”Ÿæˆå™¨"""
    # åˆ›å»ºè¯¥æ™ºèƒ½ä½“çš„æ—¥å¿—é˜Ÿåˆ—
    if agent_id not in agent_log_queues:
        agent_log_queues[agent_id] = asyncio.Queue()
    
    queue = agent_log_queues[agent_id]
    
    try:
        while True:
            # ç­‰å¾…æ–°æ—¥å¿—
            log_entry = await queue.get()
            
            # å¦‚æœæ”¶åˆ°ç»“æŸä¿¡å·ï¼Œé€€å‡º
            if log_entry == "STREAM_END":
                yield f"data: {json.dumps({'type': 'end'})}\n\n"
                break
            
            # å‘é€æ—¥å¿—åˆ°å‰ç«¯
            yield f"data: {json.dumps(log_entry)}\n\n"
            
    except asyncio.CancelledError:
        # å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
        pass
    finally:
        # æ¸…ç†é˜Ÿåˆ—
        if agent_id in agent_log_queues:
            del agent_log_queues[agent_id]

@router.get("/stream/{agent_id}")
async def stream_agent_logs(agent_id: str):
    """SSE ç«¯ç‚¹ï¼šå®æ—¶æ¨é€æ™ºèƒ½ä½“æ—¥å¿—"""
    return StreamingResponse(
        log_stream(agent_id),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no"  # ç¦ç”¨ Nginx ç¼“å†²
        }
    )

def push_agent_log(agent_id: str, log_type: str, message: str):
    """æ¨é€æ—¥å¿—åˆ°æŒ‡å®šæ™ºèƒ½ä½“çš„é˜Ÿåˆ—"""
    if agent_id in agent_log_queues:
        log_entry = {
            "type": log_type,  # "info", "success", "error", "progress"
            "message": message,
            "timestamp": datetime.now().isoformat()
        }
        agent_log_queues[agent_id].put_nowait(log_entry)
```

**å‰ç«¯ (Vue3)**:
```javascript
// AgentCard.vue
const logMessages = ref([])
const eventSource = ref(null)

const connectLogStream = (agentId) => {
  // å»ºç«‹ SSE è¿æ¥
  eventSource.value = new EventSource(`http://localhost:8000/api/agent-logs/stream/${agentId}`)
  
  eventSource.value.onmessage = (event) => {
    const data = JSON.parse(event.data)
    
    if (data.type === 'end') {
      // æ—¥å¿—æµç»“æŸï¼Œå…³é—­è¿æ¥
      eventSource.value.close()
      return
    }
    
    // æ·»åŠ æ—¥å¿—åˆ°åˆ—è¡¨
    logMessages.value.push({
      type: data.type,
      message: data.message,
      timestamp: data.timestamp
    })
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    nextTick(() => {
      scrollToBottom()
    })
  }
  
  eventSource.value.onerror = (error) => {
    console.error('SSE è¿æ¥é”™è¯¯:', error)
    eventSource.value.close()
  }
}

onBeforeUnmount(() => {
  if (eventSource.value) {
    eventSource.value.close()
  }
})
```

---

### æ–¹æ¡ˆ2: WebSocket â­â­â­

#### ä¼˜ç‚¹
- åŒå‘é€šä¿¡
- å®æ—¶æ€§æ›´å¥½
- æ”¯æŒäºŒè¿›åˆ¶æ•°æ®

#### ç¼ºç‚¹
- å®ç°å¤æ‚
- éœ€è¦é¢å¤–çš„ WebSocket æœåŠ¡å™¨
- å¯¹äºå•å‘æ—¥å¿—æµæ¥è¯´è¿‡äºå¤æ‚

---

### æ–¹æ¡ˆ3: è½®è¯¢ (Polling) â­â­

#### ä¼˜ç‚¹
- å®ç°ç®€å•
- å…¼å®¹æ€§å¥½

#### ç¼ºç‚¹
- å®æ—¶æ€§å·®
- æœåŠ¡å™¨å‹åŠ›å¤§
- æµªè´¹å¸¦å®½

---

## ğŸ¨ å‰ç«¯UIè®¾è®¡

### AgentCard æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ

```vue
<template>
  <div class="agent-card">
    <!-- å¡ç‰‡å¤´éƒ¨ -->
    <div class="card-header">...</div>
    
    <!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸï¼ˆæ•°æ®è·å–é˜¶æ®µï¼‰ -->
    <div v-if="status === 'fetching'" class="log-container">
      <div class="log-header">
        <span class="log-icon">ğŸ“¡</span>
        <span class="log-title">æ•°æ®è·å–ä¸­...</span>
      </div>
      <div class="log-messages" ref="logMessagesRef">
        <div 
          v-for="(log, index) in logMessages" 
          :key="index"
          :class="['log-message', `log-${log.type}`]"
        >
          <span class="log-icon">{{ getLogIcon(log.type) }}</span>
          <span class="log-text">{{ log.message }}</span>
        </div>
      </div>
    </div>
    
    <!-- éª¨æ¶å±ï¼ˆLLMåˆ†æé˜¶æ®µï¼‰ -->
    <div v-if="status === 'analyzing'" class="skeleton">
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
    </div>
    
    <!-- åˆ†æç»“æœ -->
    <div v-if="status === 'completed'" class="result">
      {{ output }}
    </div>
  </div>
</template>

<style scoped>
.log-container {
  background: rgba(15, 23, 42, 0.5);
  border-radius: 0.5rem;
  padding: 1rem;
  margin: 1rem 0;
  max-height: 300px;
  overflow-y: auto;
}

.log-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  font-weight: 600;
  color: #60a5fa;
}

.log-messages {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.log-message {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  padding: 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.875rem;
  line-height: 1.4;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.log-info {
  background: rgba(59, 130, 246, 0.1);
  color: #93c5fd;
}

.log-success {
  background: rgba(34, 197, 94, 0.1);
  color: #86efac;
}

.log-error {
  background: rgba(239, 68, 68, 0.1);
  color: #fca5a5;
}

.log-progress {
  background: rgba(251, 191, 36, 0.1);
  color: #fde047;
}

.log-icon {
  flex-shrink: 0;
  font-size: 1rem;
}

.log-text {
  flex: 1;
  word-break: break-word;
}
</style>
```

---

## ğŸ”§ åç«¯æ—¥å¿—æ‹¦æˆª

### æ–¹æ¡ˆ1: è‡ªå®šä¹‰ Logger Handler

```python
# backend/utils/log_stream_handler.py
import logging
from typing import Dict, Optional
import asyncio

class AgentLogStreamHandler(logging.Handler):
    """è‡ªå®šä¹‰æ—¥å¿—å¤„ç†å™¨ï¼Œå°†æ—¥å¿—æ¨é€åˆ° SSE æµ"""
    
    def __init__(self, agent_id: str):
        super().__init__()
        self.agent_id = agent_id
        
    def emit(self, record: logging.LogRecord):
        """æ‹¦æˆªæ—¥å¿—å¹¶æ¨é€åˆ°å‰ç«¯"""
        try:
            # åªå¤„ç† INFO çº§åˆ«çš„æ—¥å¿—
            if record.levelno != logging.INFO:
                return
            
            # æå–æ—¥å¿—æ¶ˆæ¯
            message = self.format(record)
            
            # è§£ææ—¥å¿—ç±»å‹
            log_type = self._parse_log_type(message)
            
            # æ¨é€åˆ°å‰ç«¯
            from backend.api.agent_logs_api import push_agent_log
            push_agent_log(self.agent_id, log_type, message)
            
        except Exception as e:
            # é¿å…æ—¥å¿—å¤„ç†å™¨æœ¬èº«å‡ºé”™
            print(f"æ—¥å¿—æ¨é€å¤±è´¥: {e}")
    
    def _parse_log_type(self, message: str) -> str:
        """æ ¹æ®æ—¥å¿—å†…å®¹åˆ¤æ–­ç±»å‹"""
        if "âœ…" in message or "æˆåŠŸ" in message:
            return "success"
        elif "âŒ" in message or "å¤±è´¥" in message or "é”™è¯¯" in message:
            return "error"
        elif "è·å–" in message or "å¼€å§‹" in message:
            return "progress"
        else:
            return "info"
```

### ä½¿ç”¨æ–¹å¼

```python
# backend/agents/news_analyst.py
import logging

def analyze_news(stock_code: str, agent_id: str):
    # ä¸ºè¯¥æ™ºèƒ½ä½“æ·»åŠ æ—¥å¿—æµå¤„ç†å™¨
    logger = logging.getLogger("news_analyst")
    stream_handler = AgentLogStreamHandler(agent_id)
    logger.addHandler(stream_handler)
    
    try:
        logger.info(f"æ”¶åˆ°è‚¡ç¥¨æ–°é—»è¯·æ±‚: {stock_code}")
        logger.info(f"å¼€å§‹è·å–{stock_code}çš„ç»¼åˆæ–°é—»æ•°æ®...")
        
        # ... æ•°æ®è·å–é€»è¾‘ ...
        
        logger.info("âœ… ç»¼åˆæ–°é—»æ•°æ®è·å–å®Œæˆ: 9/9 ä¸ªæ•°æ®æºæˆåŠŸ")
        
    finally:
        # ç§»é™¤å¤„ç†å™¨
        logger.removeHandler(stream_handler)
```

---

## ğŸ“Š æ—¥å¿—æ ¼å¼åŒ–

### æå–å…³é”®ä¿¡æ¯

```python
def format_log_message(raw_message: str) -> str:
    """æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯ï¼Œåªä¿ç•™å…³é”®ä¿¡æ¯"""
    # ç§»é™¤æ—¶é—´æˆ³
    message = raw_message.split("|")[-1].strip()
    
    # ç§»é™¤æ—¥å¿—çº§åˆ«
    if message.startswith("INFO"):
        message = message[4:].strip()
    
    # ç§»é™¤æ¨¡å—å
    if "]" in message:
        message = message.split("]", 1)[-1].strip()
    
    return message

# ç¤ºä¾‹
raw = "2025-12-08 02:44:18,022 | unified_news_endpoint | INFO | æ”¶åˆ°è‚¡ç¥¨æ–°é—»è¯·æ±‚: 603211"
formatted = format_log_message(raw)
# è¾“å‡º: "æ”¶åˆ°è‚¡ç¥¨æ–°é—»è¯·æ±‚: 603211"
```

### æ·»åŠ å›¾æ ‡

```python
def add_emoji_icon(message: str) -> str:
    """æ ¹æ®æ¶ˆæ¯å†…å®¹æ·»åŠ å›¾æ ‡"""
    if "æ”¶åˆ°" in message or "è¯·æ±‚" in message:
        return f"ğŸ“¡ {message}"
    elif "å¼€å§‹è·å–" in message:
        return f"ğŸ” {message}"
    elif "æ•°æ®æº" in message:
        return f"ğŸ“° {message}"
    elif "âœ…" in message or "æˆåŠŸ" in message:
        return f"âœ… {message}"
    elif "âŒ" in message or "å¤±è´¥" in message:
        return f"âŒ {message}"
    else:
        return f"â„¹ï¸ {message}"
```

---

## ğŸ¯ å®ç°æ­¥éª¤

### Phase 1: åç«¯åŸºç¡€è®¾æ–½
1. âœ… åˆ›å»º `backend/api/agent_logs_api.py`
2. âœ… å®ç° SSE æ—¥å¿—æµç«¯ç‚¹
3. âœ… åˆ›å»º `AgentLogStreamHandler`
4. âœ… é›†æˆåˆ°ç°æœ‰æ—¥å¿—ç³»ç»Ÿ

### Phase 2: å‰ç«¯æ—¥å¿—æ˜¾ç¤º
1. âœ… ä¿®æ”¹ `AgentCard.vue`ï¼Œæ·»åŠ æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ
2. âœ… å®ç° SSE è¿æ¥å’Œæ—¥å¿—æ¥æ”¶
3. âœ… æ·»åŠ æ—¥å¿—æ ·å¼å’ŒåŠ¨ç”»
4. âœ… å®ç°è‡ªåŠ¨æ»šåŠ¨

### Phase 3: æ™ºèƒ½ä½“é›†æˆ
1. âœ… æ–°é—»èˆ†æƒ…åˆ†æå¸ˆ
2. âœ… èµ„é‡‘æµå‘åˆ†æå¸ˆ
3. âœ… è¡Œä¸šè½®åŠ¨åˆ†æå¸ˆ
4. âœ… å®è§‚æ”¿ç­–åˆ†æå¸ˆ
5. âœ… å…¶ä»–æ™ºèƒ½ä½“...

### Phase 4: ä¼˜åŒ–å’Œæµ‹è¯•
1. âœ… æ—¥å¿—è¿‡æ»¤å’Œæ ¼å¼åŒ–
2. âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆæ—¥å¿—ç¼“å†²ï¼‰
3. âœ… é”™è¯¯å¤„ç†å’Œé‡è¿
4. âœ… ç”¨æˆ·ä½“éªŒä¼˜åŒ–

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æ–°é—»èˆ†æƒ…åˆ†æå¸ˆ

**åç«¯æ—¥å¿—**:
```python
logger.info("æ”¶åˆ°è‚¡ç¥¨æ–°é—»è¯·æ±‚: 603211")
logger.info("å¼€å§‹è·å–603211çš„ç»¼åˆæ–°é—»æ•°æ®...")
logger.info("[æ•°æ®æº1] å®æ—¶æ–°é—»èšåˆå™¨...")
logger.info("âœ… å®æ—¶æ–°é—»èšåˆå™¨æˆåŠŸ: 10æ¡")
logger.info("[æ•°æ®æº2] AKShareä¸ªè‚¡æ–°é—»...")
logger.info("âœ… AKShareä¸ªè‚¡æ–°é—»æˆåŠŸ: 10æ¡")
# ... æ›´å¤šæ•°æ®æº ...
logger.info("âœ… ç»¼åˆæ–°é—»æ•°æ®è·å–å®Œæˆ: 9/9 ä¸ªæ•°æ®æºæˆåŠŸ")
```

**å‰ç«¯æ˜¾ç¤º**:
```
ğŸ“¡ æ”¶åˆ°è‚¡ç¥¨æ–°é—»è¯·æ±‚: 603211
ğŸ” å¼€å§‹è·å–603211çš„ç»¼åˆæ–°é—»æ•°æ®...
ğŸ“° [æ•°æ®æº1] å®æ—¶æ–°é—»èšåˆå™¨...
âœ… å®æ—¶æ–°é—»èšåˆå™¨æˆåŠŸ: 10æ¡
ğŸ“° [æ•°æ®æº2] AKShareä¸ªè‚¡æ–°é—»...
âœ… AKShareä¸ªè‚¡æ–°é—»æˆåŠŸ: 10æ¡
...
âœ… ç»¼åˆæ–°é—»æ•°æ®è·å–å®Œæˆ: 9/9 ä¸ªæ•°æ®æºæˆåŠŸ
```

### èµ„é‡‘æµå‘åˆ†æå¸ˆ

**åç«¯æ—¥å¿—**:
```python
logger.info("è·å–åŒ—å‘èµ„é‡‘å®æ—¶èµ„é‡‘æµå‘...")
logger.info("âœ… è·å–åˆ°241æ¡åŒ—å‘èµ„é‡‘å®æ—¶æ•°æ®")
logger.info("è·å–åŒ—å‘èµ„é‡‘å†å²èµ„é‡‘æµå‘...")
logger.info("âœ… è·å–åˆ°2570æ¡åŒ—å‘èµ„é‡‘å†å²æ•°æ®")
# ... æ›´å¤šæ•°æ® ...
```

**å‰ç«¯æ˜¾ç¤º**:
```
ğŸ” è·å–åŒ—å‘èµ„é‡‘å®æ—¶èµ„é‡‘æµå‘...
âœ… è·å–åˆ°241æ¡åŒ—å‘èµ„é‡‘å®æ—¶æ•°æ®
ğŸ” è·å–åŒ—å‘èµ„é‡‘å†å²èµ„é‡‘æµå‘...
âœ… è·å–åˆ°2570æ¡åŒ—å‘èµ„é‡‘å†å²æ•°æ®
...
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘
- æ—¥å¿—æ¶ˆæ¯ä¸è¦å¤ªé¢‘ç¹ï¼ˆå»ºè®®é—´éš” > 100msï¼‰
- å‰ç«¯æ—¥å¿—åˆ—è¡¨é™åˆ¶æœ€å¤§æ¡æ•°ï¼ˆå¦‚ 50 æ¡ï¼‰
- ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–é•¿åˆ—è¡¨

### 2. é”™è¯¯å¤„ç†
- SSE è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿
- åç«¯å¼‚å¸¸æ—¶å‘é€é”™è¯¯æ—¥å¿—
- å‰ç«¯æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

### 3. ç”¨æˆ·ä½“éªŒ
- æ—¥å¿—æ»šåŠ¨è¦æµç•…
- é‡è¦æ—¥å¿—é«˜äº®æ˜¾ç¤º
- æ”¯æŒæš‚åœ/ç»§ç»­æ—¥å¿—æµ

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

ç”¨æˆ·åœ¨ç­‰å¾…æ™ºèƒ½ä½“åˆ†ææ—¶ï¼Œä¸å†çœ‹åˆ°å•è°ƒçš„"ç­‰å¾…åˆ†æ..."ï¼Œè€Œæ˜¯çœ‹åˆ°ï¼š

1. **å®æ—¶è¿›åº¦**: çŸ¥é“åç«¯åœ¨åšä»€ä¹ˆ
2. **æ•°æ®æ¥æº**: çœ‹åˆ°å…·ä½“è·å–äº†å“ªäº›æ•°æ®
3. **æˆåŠŸ/å¤±è´¥**: æ¸…æ¥šçŸ¥é“æ¯ä¸ªæ­¥éª¤çš„ç»“æœ
4. **è€—æ—¶ä¿¡æ¯**: äº†è§£æ•´ä½“è¿›åº¦

è¿™å°†**å¤§å¹…æå‡ç”¨æˆ·ä½“éªŒ**ï¼Œè®©ç­‰å¾…è¿‡ç¨‹å˜å¾—é€æ˜å’Œå¯æ§ï¼

---

**åˆ›å»ºæ—¶é—´**: 2025-12-08 03:11  
**é¢„è®¡å®ç°æ—¶é—´**: 2-3 å¤©  
**ä¼˜å…ˆçº§**: é«˜
