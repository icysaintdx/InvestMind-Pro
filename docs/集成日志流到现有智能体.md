# é›†æˆæ—¥å¿—æµåˆ°ç°æœ‰æ™ºèƒ½ä½“

**ç›®æ ‡**: å°†å®æ—¶æ—¥å¿—æµåŠŸèƒ½é›†æˆåˆ° InvestMindPro çš„ç°æœ‰æ™ºèƒ½ä½“ä¸­  
**åˆ›å»ºæ—¶é—´**: 2025-12-08 03:26  

---

## ğŸ“‹ å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
1. **åç«¯ SSE API** - `backend/api/agent_logs_api.py`
2. **æ—¥å¿—å¤„ç†å™¨** - `backend/utils/log_stream_handler.py`
3. **å‰ç«¯æ—¥å¿—æ˜¾ç¤º** - `AgentCard.vue` å·²æ”¯æŒ `fetching` çŠ¶æ€
4. **æµ‹è¯•ç¤ºä¾‹** - `backend/examples/agent_with_log_stream.py`

### ğŸ”„ å½“å‰æµç¨‹
```
AnalysisView.vue (runAgentAnalysis)
  â†“
agentStatus.value[agent.id] = 'fetching'  â† å·²æœ‰ï¼Œä¼šè§¦å‘æ—¥å¿—æ˜¾ç¤º
  â†“
fetchNewsData() / fetchFundFlowData()  â† éœ€è¦æ·»åŠ æ—¥å¿—æµ
  â†“
agentStatus.value[agent.id] = 'analyzing'  â† åˆ‡æ¢åˆ°éª¨æ¶å±
  â†“
è°ƒç”¨ LLM API
  â†“
agentStatus.value[agent.id] = 'success'
```

---

## ğŸ¯ é›†æˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®æ”¹ç°æœ‰ API ç«¯ç‚¹ï¼ˆæ¨èï¼‰â­â­â­â­â­

åœ¨ç°æœ‰çš„æ•°æ®è·å– API ä¸­æ·»åŠ æ—¥å¿—æ¨é€ã€‚

#### ä¼˜ç‚¹
- æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç 
- æ—¥å¿—è‡ªåŠ¨æ¨é€
- ä¸ç°æœ‰æµç¨‹å®Œç¾é›†æˆ

#### ç¤ºä¾‹ï¼šä¿®æ”¹ç»Ÿä¸€æ–°é—» API

**æ–‡ä»¶**: `backend/api/unified_news_api_endpoint.py`

```python
from backend.utils.log_stream_handler import attach_log_stream, detach_log_stream
from backend.api.agent_logs_api import end_agent_log_stream
import logging

logger = logging.getLogger(__name__)

@router.post("/stock")
async def get_stock_news(request: StockNewsRequest):
    """è·å–è‚¡ç¥¨æ–°é—»ï¼ˆå¸¦æ—¥å¿—æµï¼‰"""
    stock_code = request.stock_code
    agent_id = request.agent_id or "news_analyst"  # æ–°å¢å‚æ•°
    
    # é™„åŠ æ—¥å¿—æµå¤„ç†å™¨
    handler = attach_log_stream(__name__, agent_id)
    
    try:
        logger.info(f"æ”¶åˆ°è‚¡ç¥¨æ–°é—»è¯·æ±‚: {stock_code}")
        logger.info(f"å¼€å§‹è·å–{stock_code}çš„ç»¼åˆæ–°é—»æ•°æ®...")
        
        # åŸæœ‰çš„æ•°æ®è·å–é€»è¾‘
        result = await unified_news_api.get_comprehensive_news(stock_code)
        
        # æ•°æ®è·å–è¿‡ç¨‹ä¸­çš„æ—¥å¿—ä¼šè‡ªåŠ¨æ¨é€
        
        logger.info("âœ… ç»¼åˆæ–°é—»æ•°æ®è·å–å®Œæˆ")
        
        # ç»“æŸæ—¥å¿—æµ
        end_agent_log_stream(agent_id)
        
        return {"success": True, "data": result}
        
    except Exception as e:
        logger.error(f"âŒ è·å–æ–°é—»å¤±è´¥: {str(e)}")
        end_agent_log_stream(agent_id)
        raise
    finally:
        detach_log_stream(__name__, handler)
```

**å‰ç«¯è°ƒç”¨**ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰:
```javascript
// AnalysisView.vue - runAgentAnalysis()
agentStatus.value[agent.id] = 'fetching'  // è§¦å‘ SSE è¿æ¥

const newsResult = await fetchNewsData(data.symbol)  // åç«¯è‡ªåŠ¨æ¨é€æ—¥å¿—

agentStatus.value[agent.id] = 'analyzing'  // æ–­å¼€ SSEï¼Œæ˜¾ç¤ºéª¨æ¶å±
```

---

### æ–¹æ¡ˆ2: å‰ç«¯ä¸»åŠ¨å»ºç«‹è¿æ¥ï¼ˆå¤‡é€‰ï¼‰â­â­â­

å‰ç«¯åœ¨è°ƒç”¨ API å‰ä¸»åŠ¨å»ºç«‹ SSE è¿æ¥ã€‚

#### ä¼˜ç‚¹
- åç«¯æ— éœ€ä¿®æ”¹
- çµæ´»æ§åˆ¶

#### ç¼ºç‚¹
- éœ€è¦ä¿®æ”¹å‰ç«¯ä»£ç 
- éœ€è¦æ‰‹åŠ¨ç®¡ç†è¿æ¥

#### ç¤ºä¾‹

```javascript
// AnalysisView.vue
const runAgentAnalysis = async (agent, data) => {
  agentStatus.value[agent.id] = 'fetching'
  
  // å‰ç«¯ä¸»åŠ¨å»ºç«‹ SSE è¿æ¥
  // AgentCard ä¼šè‡ªåŠ¨ç›‘å¬ status å˜åŒ–å¹¶å»ºç«‹è¿æ¥
  
  try {
    // è°ƒç”¨ API
    const newsResult = await fetchNewsData(data.symbol)
    
    // åˆ‡æ¢çŠ¶æ€
    agentStatus.value[agent.id] = 'analyzing'
    
    // ... LLM è°ƒç”¨ ...
    
  } catch (e) {
    console.error(e)
  }
}
```

---

## ğŸ”§ å…·ä½“å®ç°æ­¥éª¤

### æ­¥éª¤1: ä¿®æ”¹ç»Ÿä¸€æ–°é—» API

<function_calls>
<invoke name="read_file">
<parameter name="file_path">d:\InvestMindPro\backend\api\unified_news_api_endpoint.py
