# 实时日志流使用指南

**功能**: 在智能体卡片内显示后端数据获取的实时日志  
**创建时间**: 2025-12-08 03:16  
**状态**: ✅ 已完成实现  

---

## 📋 功能概述

实时日志流功能允许前端智能体卡片显示后端数据获取的实时进度，让用户清楚地看到：
- 正在获取哪些数据源
- 每个数据源获取了多少条数据
- 数据获取是否成功
- 整体进度如何

---

## 🏗️ 架构设计

### 技术栈
- **后端**: FastAPI + SSE (Server-Sent Events)
- **前端**: Vue 3 + EventSource API
- **通信**: 单向推送（后端 → 前端）

### 核心组件

#### 后端
1. **`backend/api/agent_logs_api.py`** - SSE 日志流 API
2. **`backend/utils/log_stream_handler.py`** - 自定义日志处理器
3. **`backend/server.py`** - 注册 API 路由

#### 前端
1. **`AgentCard.vue`** - 增加日志显示区域
2. **SSE 连接管理** - 自动建立/断开连接
3. **日志样式** - 不同类型的日志有不同颜色

---

## 🚀 快速开始

### 1. 后端集成

在你的智能体函数中添加日志流支持：

```python
import logging
from backend.utils.log_stream_handler import attach_log_stream, detach_log_stream
from backend.api.agent_logs_api import end_agent_log_stream

logger = logging.getLogger(__name__)

def your_agent_function(stock_code: str, agent_id: str):
    """你的智能体函数"""
    # 1. 附加日志流处理器
    handler = attach_log_stream(__name__, agent_id)
    
    try:
        # 2. 正常使用 logger，日志会自动推送到前端
        logger.info(f"收到股票请求: {stock_code}")
        logger.info("开始获取数据...")
        
        # 你的数据获取逻辑
        logger.info("[数据源1] 获取中...")
        # ... 数据获取代码 ...
        logger.info("✅ 数据源1成功: 100条")
        
        logger.info("[数据源2] 获取中...")
        # ... 数据获取代码 ...
        logger.info("✅ 数据源2成功: 200条")
        
        logger.info("✅ 所有数据获取完成")
        
        # 3. 结束日志流
        end_agent_log_stream(agent_id)
        
        return {"success": True}
        
    except Exception as e:
        logger.error(f"❌ 错误: {str(e)}")
        end_agent_log_stream(agent_id)
        raise
    finally:
        # 4. 移除日志流处理器
        detach_log_stream(__name__, handler)
```

### 2. 前端使用

前端 `AgentCard` 已经自动集成，只需确保：

1. **智能体状态管理**: 添加 `fetching` 状态
```javascript
// AnalysisView.vue
agents.value[0].status = 'fetching'  // 数据获取阶段
// ... 数据获取完成后 ...
agents.value[0].status = 'analyzing'  // LLM 分析阶段
```

2. **智能体 ID 匹配**: 确保前后端使用相同的 `agent_id`
```javascript
// 前端
agent.id = 'news_analyst'

// 后端
agent_id = 'news_analyst'
```

---

## 📊 日志类型

### 支持的日志类型

| 类型 | 图标 | 颜色 | 用途 |
|------|------|------|------|
| `info` | ℹ️ | 蓝色 | 一般信息 |
| `success` | ✅ | 绿色 | 成功消息 |
| `error` | ❌ | 红色 | 错误消息 |
| `progress` | 🔍 | 黄色 | 进度信息 |
| `warning` | ⚠️ | 橙色 | 警告信息 |

### 自动识别规则

日志处理器会根据消息内容自动判断类型：

```python
# 自动识别为 success
logger.info("✅ 数据获取成功")
logger.info("成功获取100条数据")

# 自动识别为 error
logger.info("❌ 数据获取失败")
logger.error("错误: 连接超时")

# 自动识别为 progress
logger.info("获取数据中...")
logger.info("开始处理...")

# 自动识别为 warning
logger.warning("⚠️ 数据不完整")
```

---

## 🎨 前端显示效果

### 数据获取阶段 (fetching)
```
📡 数据获取中...                    5条日志

ℹ️ 收到股票新闻请求: 603211
🔍 开始获取603211的综合新闻数据...
📰 [数据源1] 实时新闻聚合器...
✅ 实时新闻聚合器成功: 10条
📰 [数据源2] AKShare个股新闻...
```

### LLM 分析阶段 (analyzing)
```
[骨架屏动画]
▬▬▬▬▬▬▬▬▬▬▬▬▬▬▬
▬▬▬▬▬▬▬▬▬▬▬
▬▬▬▬▬▬▬▬▬▬▬▬▬
```

### 完成阶段 (completed)
```
[显示分析结果]
根据最新的新闻数据分析...
```

---

## 🔧 API 端点

### 1. SSE 日志流
```
GET /api/agent-logs/stream/{agent_id}
```

**响应**: SSE 流
```
data: {"type": "connected", "message": "日志流已连接"}

data: {"type": "info", "message": "收到股票请求: 603211", "timestamp": "2025-12-08T03:16:00"}

data: {"type": "success", "message": "✅ 数据获取成功: 10条", "timestamp": "2025-12-08T03:16:01"}

data: {"type": "end", "message": "日志流已结束"}
```

### 2. 测试推送
```
POST /api/agent-logs/test/{agent_id}?message=测试消息
```

**响应**:
```json
{
  "success": true,
  "message": "日志已推送到 news_analyst"
}
```

### 3. 获取状态
```
GET /api/agent-logs/status
```

**响应**:
```json
{
  "active_streams": ["news_analyst", "funds"],
  "count": 2
}
```

---

## 📝 使用示例

### 示例1: 新闻舆情分析师

**后端日志**:
```python
logger.info("收到股票新闻请求: 603211")
logger.info("开始获取603211的综合新闻数据...")
logger.info("[数据源1] 实时新闻聚合器...")
logger.info("✅ 实时新闻聚合器成功: 10条")
logger.info("[数据源2] AKShare个股新闻...")
logger.info("✅ AKShare个股新闻成功: 10条")
logger.info("[数据源3] 财联社快讯...")
logger.info("✅ 财联社快讯成功: 10条")
logger.info("[数据源4] 微博热议...")
logger.info("✅ 微博热议成功: 50条")
logger.info("[数据源5] 财经早餐...")
logger.info("✅ 财经早餐成功: 400条")
logger.info("[情绪分析] 开始分析...")
logger.info("✅ 情绪分析完成: 偏积极")
logger.info("✅ 综合新闻数据获取完成: 5/5 个数据源成功")
```

**前端显示**:
```
📡 数据获取中...                    13条日志

ℹ️ 收到股票新闻请求: 603211
🔍 开始获取603211的综合新闻数据...
📰 [数据源1] 实时新闻聚合器...
✅ 实时新闻聚合器成功: 10条
📰 [数据源2] AKShare个股新闻...
✅ AKShare个股新闻成功: 10条
📰 [数据源3] 财联社快讯...
✅ 财联社快讯成功: 10条
📰 [数据源4] 微博热议...
✅ 微博热议成功: 50条
📰 [数据源5] 财经早餐...
✅ 财经早餐成功: 400条
🔍 [情绪分析] 开始分析...
✅ 情绪分析完成: 偏积极
✅ 综合新闻数据获取完成: 5/5 个数据源成功
```

### 示例2: 资金流向分析师

**后端日志**:
```python
logger.info("获取北向资金实时资金流向...")
logger.info("✅ 获取到241条北向资金实时数据")
logger.info("获取北向资金历史资金流向...")
logger.info("✅ 获取到2570条北向资金历史数据")
logger.info("获取北向持股排名(今日排行)...")
logger.info("✅ 获取到2767条持股排名")
logger.info("获取行业资金流向(即时)...")
logger.info("✅ 获取到90条行业资金流向")
logger.info("获取概念资金流向(即时)...")
logger.info("✅ 获取到386条概念资金流向")
logger.info("获取个股资金流向(即时)...")
logger.info("✅ 获取到5153条个股资金流向")
logger.info("获取融资融券汇总...")
logger.info("✅ 获取到20条融资融券汇总")
logger.info(f"获取603211的资金流向详情...")
logger.info(f"✅ 找到603211的资金流向")
```

**前端显示**:
```
📡 数据获取中...                    16条日志

🔍 获取北向资金实时资金流向...
✅ 获取到241条北向资金实时数据
🔍 获取北向资金历史资金流向...
✅ 获取到2570条北向资金历史数据
🔍 获取北向持股排名(今日排行)...
✅ 获取到2767条持股排名
🔍 获取行业资金流向(即时)...
✅ 获取到90条行业资金流向
🔍 获取概念资金流向(即时)...
✅ 获取到386条概念资金流向
🔍 获取个股资金流向(即时)...
✅ 获取到5153条个股资金流向
🔍 获取融资融券汇总...
✅ 获取到20条融资融券汇总
🔍 获取603211的资金流向详情...
✅ 找到603211的资金流向
```

---

## 🧪 测试

### 1. 运行测试脚本
```bash
python test_log_stream.py
```

### 2. 手动测试

**启动后端**:
```bash
python backend/server.py
```

**测试 SSE 连接**:
```bash
curl -N http://localhost:8000/api/agent-logs/stream/news_analyst
```

**推送测试日志**:
```bash
curl -X POST "http://localhost:8000/api/agent-logs/test/news_analyst?message=测试消息"
```

---

## ⚠️ 注意事项

### 1. 性能考虑
- 日志消息不要太频繁（建议间隔 > 100ms）
- 前端日志列表限制最大 50 条
- 使用虚拟滚动优化长列表（可选）

### 2. 错误处理
- SSE 连接断开时自动重连（浏览器原生支持）
- 后端异常时发送错误日志
- 前端显示友好的错误提示

### 3. 用户体验
- 日志滚动要流畅（自动滚动到底部）
- 重要日志高亮显示（成功/错误）
- 支持暂停/继续日志流（可选）

### 4. 清理资源
- 组件销毁时自动断开 SSE 连接
- 后端自动清理过期的日志队列
- 避免内存泄漏

---

## 🎯 下一步计划

### v1.6.0 (计划中)
1. **日志过滤**: 支持按类型过滤日志
2. **日志搜索**: 支持搜索日志内容
3. **日志导出**: 支持导出日志到文件
4. **日志回放**: 支持回放历史日志
5. **日志统计**: 显示日志统计信息

---

## 📚 相关文档

- `实时日志流功能设计.md` - 详细设计文档
- `backend/api/agent_logs_api.py` - API 实现
- `backend/utils/log_stream_handler.py` - 日志处理器
- `backend/examples/agent_with_log_stream.py` - 使用示例

---

**创建时间**: 2025-12-08 03:16  
**最后更新**: 2025-12-08 03:16  
**维护人员**: Cascade AI
