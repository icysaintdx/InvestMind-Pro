# æ•°æ®åº“æ–¹æ¡ˆå®Œæ•´æŒ‡å—

## ğŸ‰ å·²å®ŒæˆåŠŸèƒ½

å®Œæ•´çš„æ•°æ®åº“æŒä¹…åŒ–æ–¹æ¡ˆå·²å®ç°ï¼

### âœ… æ ¸å¿ƒåŠŸèƒ½

1. **æ•°æ®æŒä¹…åŒ–** - SQLite/PostgreSQL å­˜å‚¨
2. **å†å²è®°å½•** - å®Œæ•´çš„åˆ†æå†å²æŸ¥è¯¢
3. **ç»Ÿè®¡åˆ†æ** - æ™ºèƒ½ä½“æ€§èƒ½ã€è‚¡ç¥¨çƒ­åº¦ç»Ÿè®¡
4. **è·¨è®¾å¤‡åŒæ­¥** - åŸºäºæ•°æ®åº“çš„çŠ¶æ€åŒæ­¥

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

#### 1. `analysis_sessions` - åˆ†æä¼šè¯è¡¨
```sql
- id: ä¸»é”®
- session_id: ä¼šè¯IDï¼ˆå”¯ä¸€ï¼‰
- stock_code: è‚¡ç¥¨ä»£ç 
- stock_name: è‚¡ç¥¨åç§°
- status: çŠ¶æ€ï¼ˆcreated/running/completed/errorï¼‰
- progress: è¿›åº¦ï¼ˆ0-100ï¼‰
- current_stage: å½“å‰é˜¶æ®µï¼ˆ1-4ï¼‰
- start_time: å¼€å§‹æ—¶é—´
- end_time: ç»“æŸæ—¶é—´
- error_message: é”™è¯¯ä¿¡æ¯
- created_at: åˆ›å»ºæ—¶é—´
```

#### 2. `agent_results` - æ™ºèƒ½ä½“ç»“æœè¡¨
```sql
- id: ä¸»é”®
- session_id: ä¼šè¯IDï¼ˆå¤–é”®ï¼‰
- agent_id: æ™ºèƒ½ä½“ID
- agent_name: æ™ºèƒ½ä½“åç§°
- status: çŠ¶æ€
- output: è¾“å‡ºç»“æœ
- tokens: Tokenæ•°é‡
- thoughts: æ€ç»´é“¾ï¼ˆJSONï¼‰
- data_sources: æ•°æ®æºï¼ˆJSONï¼‰
- start_time: å¼€å§‹æ—¶é—´
- end_time: ç»“æŸæ—¶é—´
- duration_seconds: è€—æ—¶ï¼ˆç§’ï¼‰
- error_message: é”™è¯¯ä¿¡æ¯
- created_at: åˆ›å»ºæ—¶é—´
```

#### 3. `stock_history` - è‚¡ç¥¨å†å²ç»Ÿè®¡è¡¨
```sql
- id: ä¸»é”®
- stock_code: è‚¡ç¥¨ä»£ç ï¼ˆå”¯ä¸€ï¼‰
- stock_name: è‚¡ç¥¨åç§°
- analysis_count: åˆ†ææ¬¡æ•°
- last_analysis_time: æœ€ååˆ†ææ—¶é—´
- avg_analysis_duration: å¹³å‡åˆ†ææ—¶é•¿
- created_at: åˆ›å»ºæ—¶é—´
- updated_at: æ›´æ–°æ—¶é—´
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ•°æ®åº“

```bash
cd d:\InvestMindPro\backend
python init_database.py
```

**è¾“å‡º**ï¼š
```
============================================================
InvestMindPro æ•°æ®åº“åˆå§‹åŒ–
============================================================

1. æµ‹è¯•æ•°æ®åº“è¿æ¥...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

2. æ˜¯å¦éœ€è¦é‡å»ºæ‰€æœ‰è¡¨ï¼Ÿ
   è¾“å…¥ 'yes' ç¡®è®¤é‡å»ºï¼Œå…¶ä»–é”®è·³è¿‡: no

3. åˆ›å»ºæ•°æ®åº“è¡¨...
âœ… æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ

4. æ•°æ®åº“è¡¨ç»“æ„:
   - analysis_sessions: åˆ†æä¼šè¯è¡¨
   - agent_results: æ™ºèƒ½ä½“ç»“æœè¡¨
   - stock_history: è‚¡ç¥¨å†å²ç»Ÿè®¡è¡¨

============================================================
âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼
============================================================
```

### 2. å¯åŠ¨æœåŠ¡å™¨

```bash
python server.py
```

### 3. æµ‹è¯• API

```bash
# æŸ¥çœ‹æ´»è·ƒä¼šè¯
curl http://localhost:8000/api/analysis/db/sessions/active

# æŸ¥çœ‹çƒ­é—¨è‚¡ç¥¨
curl http://localhost:8000/api/analysis/db/history/popular-stocks

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:8000/api/analysis/db/stats/overview
```

---

## ğŸ“¡ API ç«¯ç‚¹

### ä¼šè¯ç®¡ç†

#### åˆ›å»ºä¼šè¯
```http
POST /api/analysis/db/session/create
Content-Type: application/json

{
  "stock_code": "600000",
  "stock_name": "æµ¦å‘é“¶è¡Œ"
}
```

#### æŸ¥è¯¢ä¼šè¯çŠ¶æ€
```http
GET /api/analysis/db/session/{session_id}/status
```

#### æ›´æ–°ä¼šè¯è¿›åº¦
```http
POST /api/analysis/db/session/{session_id}/update
Content-Type: application/json

{
  "agent_id": "news_analyst",
  "agent_name": "æ–°é—»èˆ†æƒ…åˆ†æå¸ˆ",
  "status": "completed",
  "output": "åˆ†æç»“æœ...",
  "tokens": 1500,
  "thoughts": [...],
  "data_sources": [...]
}
```

---

### å†å²è®°å½•æŸ¥è¯¢

#### æŸ¥è¯¢è‚¡ç¥¨å†å²
```http
GET /api/analysis/db/history/stock/600000?limit=10
```

**å“åº”**ï¼š
```json
{
  "stock_code": "600000",
  "total": 5,
  "sessions": [
    {
      "session_id": "session_xxx",
      "stock_code": "600000",
      "status": "completed",
      "progress": 100,
      "created_at": "2025-12-08T06:30:00"
    }
  ]
}
```

#### æŸ¥è¯¢å®Œæ•´ä¼šè¯å†å²
```http
GET /api/analysis/db/history/session/{session_id}/full
```

**å“åº”**ï¼š
```json
{
  "session": {
    "session_id": "session_xxx",
    "stock_code": "600000",
    "status": "completed",
    "progress": 100
  },
  "agent_results": [
    {
      "agent_id": "news_analyst",
      "status": "completed",
      "output": "...",
      "tokens": 1500,
      "duration_seconds": 15
    }
  ]
}
```

#### æŸ¥è¯¢æœ€è¿‘åˆ†æ
```http
GET /api/analysis/db/history/recent?limit=20
```

#### æŸ¥è¯¢çƒ­é—¨è‚¡ç¥¨
```http
GET /api/analysis/db/history/popular-stocks?limit=10
```

---

### ç»Ÿè®¡åˆ†æ

#### ç»Ÿè®¡æ¦‚è§ˆ
```http
GET /api/analysis/db/stats/overview?days=7
```

**å“åº”**ï¼š
```json
{
  "analysis": {
    "total_count": 50,
    "status_distribution": {
      "completed": 45,
      "error": 3,
      "running": 2
    },
    "avg_duration_seconds": 180,
    "period_days": 7
  },
  "agents": [
    {
      "agent_id": "news_analyst",
      "total_runs": 50,
      "avg_duration": 15,
      "max_duration": 30,
      "total_tokens": 75000
    }
  ]
}
```

#### æ™ºèƒ½ä½“ç»Ÿè®¡
```http
GET /api/analysis/db/stats/agents?days=7
```

---

## ğŸ’» å‰ç«¯é›†æˆ

### ä½¿ç”¨æ•°æ®åº“ API

åªéœ€å°†å‰ç«¯çš„ API ç«¯ç‚¹ä» `/api/analysis/session/` æ”¹ä¸º `/api/analysis/db/session/`ï¼š

```javascript
// åˆ›å»ºä¼šè¯
const response = await fetch('http://localhost:8000/api/analysis/db/session/create', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    stock_code: '600000',
    stock_name: 'æµ¦å‘é“¶è¡Œ'
  })
})
```

### æŸ¥è¯¢å†å²è®°å½•

```javascript
// æŸ¥è¯¢æŸè‚¡ç¥¨çš„å†å²
const history = await fetch(
  'http://localhost:8000/api/analysis/db/history/stock/600000'
).then(r => r.json())

console.log(`${history.stock_code} è¢«åˆ†æäº† ${history.total} æ¬¡`)

// æŸ¥è¯¢çƒ­é—¨è‚¡ç¥¨
const popular = await fetch(
  'http://localhost:8000/api/analysis/db/history/popular-stocks'
).then(r => r.json())

console.log('çƒ­é—¨è‚¡ç¥¨:', popular.stocks)
```

---

## ğŸ”§ é…ç½®

### åˆ‡æ¢æ•°æ®åº“

é»˜è®¤ä½¿ç”¨ SQLiteï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡åˆ‡æ¢åˆ° PostgreSQLï¼š

```bash
# .env æ–‡ä»¶
DATABASE_URL=postgresql://user:password@localhost/InvestMindPro
```

### æ•°æ®åº“ä½ç½®

- **SQLite**: `./InvestMindPro.db`
- **PostgreSQL**: é…ç½®çš„æœåŠ¡å™¨åœ°å€

---

## ğŸ“ˆ ä½¿ç”¨åœºæ™¯

### 1. æŸ¥çœ‹å†å²åˆ†æ

```python
# æŸ¥çœ‹æŸè‚¡ç¥¨çš„æ‰€æœ‰å†å²åˆ†æ
GET /api/analysis/db/history/stock/600000

# æŸ¥çœ‹æŸæ¬¡åˆ†æçš„å®Œæ•´è¯¦æƒ…
GET /api/analysis/db/history/session/session_xxx/full
```

### 2. æ€§èƒ½åˆ†æ

```python
# æŸ¥çœ‹æ™ºèƒ½ä½“æ€§èƒ½ç»Ÿè®¡
GET /api/analysis/db/stats/agents?days=30

# æ‰¾å‡ºæœ€æ…¢çš„æ™ºèƒ½ä½“
# æŸ¥çœ‹å¹³å‡è€—æ—¶ã€æœ€å¤§è€—æ—¶
```

### 3. çƒ­åº¦åˆ†æ

```python
# æŸ¥çœ‹æœ€çƒ­é—¨çš„è‚¡ç¥¨
GET /api/analysis/db/history/popular-stocks

# æŸ¥çœ‹æœ€è¿‘åˆ†æçš„è‚¡ç¥¨
GET /api/analysis/db/history/recent
```

---

## ğŸ¯ ä¼˜åŠ¿å¯¹æ¯”

| åŠŸèƒ½ | å†…å­˜æ–¹æ¡ˆ | æ•°æ®åº“æ–¹æ¡ˆ |
|------|---------|-----------|
| **æ•°æ®æŒä¹…åŒ–** | âŒ é‡å¯ä¸¢å¤± | âœ… æ°¸ä¹…ä¿å­˜ |
| **å†å²è®°å½•** | âŒ æ—  | âœ… å®Œæ•´å†å² |
| **è·¨è®¾å¤‡åŒæ­¥** | âš ï¸ éœ€Redis | âœ… åŸç”Ÿæ”¯æŒ |
| **ç»Ÿè®¡åˆ†æ** | âŒ æ—  | âœ… å¼ºå¤§æŸ¥è¯¢ |
| **æ•°æ®å®¡è®¡** | âŒ æ—  | âœ… å®Œæ•´è¿½æº¯ |
| **å®ç°å¤æ‚åº¦** | â­ ç®€å• | â­â­ ä¸­ç­‰ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“æ–‡ä»¶

SQLite æ•°æ®åº“æ–‡ä»¶ `InvestMindPro.db` ä¼šè‡ªåŠ¨åˆ›å»ºåœ¨é¡¹ç›®æ ¹ç›®å½•ã€‚

### 2. æ€§èƒ½

- SQLite é€‚åˆå¼€å‘å’Œå°è§„æ¨¡ä½¿ç”¨
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ PostgreSQL

### 3. å¤‡ä»½

å®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶ï¼š

```bash
# SQLite å¤‡ä»½
cp InvestMindPro.db InvestMindPro_backup_$(date +%Y%m%d).db

# PostgreSQL å¤‡ä»½
pg_dump InvestMindPro > backup.sql
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. âœ… æ•°æ®åº“æ¨¡å‹å·²åˆ›å»º
2. âœ… API å·²å®ç°
3. â³ é›†æˆåˆ°åˆ†ææµç¨‹ï¼ˆéœ€è¦ä¿®æ”¹åˆ†æä»£ç ï¼‰
4. â³ å‰ç«¯å†å²è®°å½•é¡µé¢

---

## ğŸ“ ç¤ºä¾‹æŸ¥è¯¢

### SQL æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥çœ‹æ‰€æœ‰ä¼šè¯
SELECT * FROM analysis_sessions ORDER BY created_at DESC LIMIT 10;

-- æŸ¥çœ‹æŸè‚¡ç¥¨çš„åˆ†ææ¬¡æ•°
SELECT stock_code, COUNT(*) as count 
FROM analysis_sessions 
GROUP BY stock_code 
ORDER BY count DESC;

-- æŸ¥çœ‹æ™ºèƒ½ä½“å¹³å‡è€—æ—¶
SELECT agent_id, AVG(duration_seconds) as avg_time
FROM agent_results
WHERE status = 'completed'
GROUP BY agent_id
ORDER BY avg_time DESC;

-- æŸ¥çœ‹æˆåŠŸç‡
SELECT 
  status,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
FROM analysis_sessions
GROUP BY status;
```

---

## âœ… æµ‹è¯•æ¸…å•

- [ ] åˆå§‹åŒ–æ•°æ®åº“
- [ ] åˆ›å»ºä¼šè¯
- [ ] æŸ¥è¯¢ä¼šè¯çŠ¶æ€
- [ ] æ›´æ–°æ™ºèƒ½ä½“ç»“æœ
- [ ] æŸ¥è¯¢å†å²è®°å½•
- [ ] æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
- [ ] æµ‹è¯•è·¨è®¾å¤‡åŒæ­¥

---

ç°åœ¨ä½ æ‹¥æœ‰äº†å®Œæ•´çš„æ•°æ®åº“æŒä¹…åŒ–æ–¹æ¡ˆï¼ğŸ‰
