统一新闻监控中心 - 实施报告
一、项目结构变化
新增文件
backend/services/news_center/
├── __init__.py                    # 模块入口
├── news_cache.py                  # 统一缓存层
├── stock_relation_analyzer.py     # 股票关联分析
├── impact_assessor.py             # 影响评估器
└── news_monitor_center.py         # 核心监控中心

backend/api/
└── news_center_api.py             # 新增统一API
修改文件
backend/server.py                  # 注册新API路由
backend/api/websocket_api.py       # 扩展新闻推送功能
frontend/src/views/DataFlowView.vue # 添加新闻推送处理
保留未动的文件
backend/services/background_news_service.py    # 原有后台服务，保留
backend/dataflows/news/sentiment_engine.py     # 原有情绪引擎，被复用
backend/api/unified_news_api_endpoint.py       # 原有统一新闻API，保留
backend/api/dataflow_api.py                    # 原有数据流API，保留
二、当前调用关系（重要）
现状：各模块仍然独立调用，新中心是并行存在
模块	调用方式	是否使用新中心
数据流页面实时新闻流	/api/dataflow/news	❌ 仍用原有API
统一新闻中心页面	/api/unified-news/*	❌ 仍用原有API
详情模态框新闻标签	/api/dataflow/news	❌ 仍用原有API
智能分析模块	独立获取	❌ 仍用原有逻辑
新增的新闻中心	/api/news-center/*	✅ 新架构
结论：新的 NewsMonitorCenter 目前是独立运行的，原有各模块的调用逻辑未改变。

三、各模块工作流程
1. 数据流页面实时新闻流 (DataFlowView.vue)
用户打开页面
    ↓
loadNews() 调用 /api/dataflow/news
    ↓
dataflow_api.py 处理请求
    ↓
background_news_service.py 在进程池中获取新闻
    ↓
返回新闻列表给前端
    ↓
定时器每N秒静默刷新 loadNews(true)
改变： 新增了 WebSocket 新闻订阅，收到推送时会触发 loadNews(true) 静默刷新

2. 统一新闻中心页面 (UnifiedNewsView.vue)
用户打开页面
    ↓
调用 /api/unified-news/all
    ↓
unified_news_api_endpoint.py 聚合12个数据源
    ↓
返回新闻列表
改变： 无

3. 详情模态框新闻标签
用户点击股票详情
    ↓
viewDetails() 加载股票数据
    ↓
调用 /api/dataflow/news?ts_code=xxx
    ↓
返回该股票相关新闻
改变： 无

4. 智能分析模块
用户发起分析
    ↓
分析流程中独立获取新闻
    ↓
使用 sentiment_engine.py 分析情绪
    ↓
生成分析报告
改变： 无

5. 新增的新闻监控中心 (NewsMonitorCenter)
服务启动
    ↓
调用 /api/news-center/start 启动监控
    ↓
NewsMonitorCenter.start() 启动后台任务
    ↓
定时循环：
  ├── 财联社 (30秒)
  ├── 东财全球 (120秒)
  └── 其他数据源...
    ↓
每次获取新闻后：
  ├── 情绪分析 (复用 sentiment_engine)
  ├── 股票关联分析 (stock_relation_analyzer)
  ├── 影响评估 (impact_assessor)
  └── 存入统一缓存 (news_cache)
    ↓
如果是紧急新闻：
  └── WebSocket 推送给订阅者
四、WebSocket 新闻推送流程
前端连接 WebSocket
    ↓
收到 connected 消息
    ↓
自动发送 {"action": "subscribe_news"}
    ↓
后端将 client_id 加入 news_subscribers
    ↓
当 NewsMonitorCenter 检测到紧急新闻
    ↓
调用 notify_urgent_news()
    ↓
WebSocket 推送 {"type": "news_update", "urgency": "critical", ...}
    ↓
前端 handleNewsUpdate() 处理
    ├── 显示 Toast 提醒
    └── 静默刷新新闻列表
五、实现了什么
功能	状态	说明
统一缓存层	✅ 已实现	MD5去重、分级TTL
股票关联分析	✅ 已实现	从新闻提取关联股票
影响评估	✅ 已实现	评估新闻影响程度
后台定时抓取	✅ 已实现	多数据源定时刷新
WebSocket推送	✅ 已实现	紧急新闻实时推送
统一API	✅ 已实现	/api/news-center/*
六、未完成的工作
工作	状态	说明
迁移数据流页面到新API	❌ 未做	仍用 /api/dataflow/news
迁移统一新闻中心到新API	❌ 未做	仍用 /api/unified-news/*
迁移详情模态框到新API	❌ 未做	仍用原有逻辑
迁移智能分析到新API	❌ 未做	仍用原有逻辑
激活巨潮爬虫	❌ 未做	cninfo_crawler 仍未被调用
服务启动时自动启动监控	❌ 未做	需手动调用 /start
七、下一步建议
渐进式迁移：逐步将各模块的新闻调用切换到 /api/news-center/*
自动启动：在 server.py 的 lifespan 中自动启动 NewsMonitorCenter
激活巨潮：在 NewsMonitorCenter 中集成 cninfo_crawler
统一入口：最终所有新闻请求都通过新中心，实现真正的统一
当前状态：新架构已搭建完成，但与原有系统是并行运行，尚未完成迁移整合。





东方财富、 富途、 同花顺、 新浪财经、 财联社、 微博热议、 财经早餐、 巨潮资讯（其它源集成）、 东方财富公告、 新闻联播、
个股有两个新闻接口、刚添加的巨潮官方接口（公告）


fetch_market_news() 现在包含 12个市场新闻接口：
东方财富全球资讯
财联社电报
富途牛牛
同花顺
新浪财经
微博热议
财经早餐
新闻联播
百度财经
巨潮市场公告
巨潮新闻数据（新增）
巨潮研报摘要（新增）

fetch_stock_news() 现在包含 3个个股新闻接口：
东方财富个股新闻
巨潮个股公告
巨潮个股新闻（新增）

API Code	名称	说明
p_info3030	新闻数据查询	按股票代码/日期/分类查询新闻列表
p_info3031	新闻正文查询	根据新闻ID获取正文内容
p_comnewslist	新闻列表	按公司/日期/关键词查询新闻
p_comnewsinfo	新闻详情	根据新闻ID获取详情（含正负面情绪）
p_info3097_inc	个股研报摘要	研报标题、内容、发布机构等
接口	用途	是否适合新闻流
p_stock2100	公司基本信息	否（静态数据）
p_stock2101	股票基本信息	否（静态数据）
p_stock0004	股票所属板块	否（静态数据）
p_stock2102	管理人员任职	可选（人事变动）
p_stock2117	上市状态变动	是（已使用）
p_stock2107	员工情况	否（年报数据）
p_info3005	公告分类信息	否（元数据）
p_info3015	公告基本信息	是（已使用）
p_public0005	公共编码	否（元数据）
p_public0006	汇率数据	否（非新闻）
p_public0007	机构信息	否（静态数据）
p_info3030  新闻数据查询（按股票/日期/分类）    get_news_list()
p_info3031  新闻正文查询    get_news_content()
p_comnewslist   公司新闻列表（含情绪分析）  get_company_news_list()
p_comnewsinfo   新闻详情    get_company_news_detail()
p_info3097_inc  个股研报摘要    get_research_report_summary()

