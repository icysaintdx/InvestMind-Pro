# 前端数据源显示修复

> 修复时间: 2025-12-04 06:15  
> 状态: ✅ 已完成

---

## 🔍 问题诊断

### 发现的问题
1. ❌ **数据源优先级显示错误**: 显示"AKShare > 聚合数据 > 新浪财经 > Tushare"
2. ❌ **新闻分析师数据源为模拟数据**: 没有使用真实的统一新闻API数据
3. ❌ **卡片中没有显示数据数量**: 只显示"X个来源"，没有显示具体数据条数
4. ❌ **数据来源不准确**: 显示的是模拟数据源，不是真实的数据来源

---

## 🔧 修复方案

### 1. 更新数据源优先级显示 ✅

**问题**: 显示的优先级与实际不符

**文件**: `alpha-council-vue/src/views/AnalysisView.vue` 第570行

**修复前**:
```javascript
stockDataPanel.value.addLog('尝试数据源: AKShare > 聚合数据 > 新浪财经 > Tushare', 'fetch')
```

**修复后**:
```javascript
stockDataPanel.value.addLog('数据源优先级: AKShare > 新浪财经 > 聚合数据 > Tushare', 'fetch')
```

---

### 2. 更新AgentCard显示数据数量 ✅

**问题**: 卡片中没有显示具体的数据条数

**文件**: `alpha-council-vue/src/components/AgentCard.vue`

**修复内容**:

#### 2.1 更新模板 (第94-103行)
```vue
<div class="sources-header">
  <span class="text-xs font-semibold text-emerald-400">📊 参考数据</span>
  <span class="text-xs text-slate-500">
    {{ dataSources.length }}个来源 | 
    <span v-if="totalDataCount" class="text-emerald-400 font-semibold">{{ totalDataCount }}条数据</span>
  </span>
</div>
<div class="sources-list">
  <div v-for="(source, index) in dataSources" :key="index" class="source-tag" :title="getSourceTooltip(source)">
    <span class="source-name">{{ source.source }}</span>
    <span v-if="source.count" class="source-count">({{ source.count }}条)</span>
  </div>
</div>
```

#### 2.2 添加计算属性 (第225-232行)
```javascript
computed: {
  totalDataCount() {
    // 计算总数据数量
    if (!this.dataSources || this.dataSources.length === 0) return 0
    return this.dataSources.reduce((total, source) => {
      return total + (source.count || 0)
    }, 0)
  }
}
```

#### 2.3 添加方法 (第235-244行)
```javascript
methods: {
  getSourceTooltip(source) {
    // 生成数据源的完整提示信息
    if (source.count) {
      return `${source.source}: ${source.count}条数据`
    }
    if (source.title) {
      return `${source.source}: ${source.title}`
    }
    return source.source
  },
  // ... 其他方法
}
```

---

### 3. 使用真实的新闻数据源 ✅

**问题**: 新闻分析师使用模拟数据源

**文件**: `alpha-council-vue/src/views/AnalysisView.vue` 第444-486行

**修复前**:
```javascript
// 如果是新闻类Agent，添加数据源模拟
if (['news_analyst', 'china_market'].includes(agent.id)) {
  agentDataSources.value[agent.id] = [
    { source: '东方财富', title: '最新市场动态...', url: '#' },
    { source: '新浪财经', title: '行业板块分析...', url: '#' },
    { source: '雪球', title: '投资者情绪报告...', url: '#' }
  ]
}
```

**修复后**:
```javascript
// 如果是新闻分析师，使用真实的统一新闻API数据
if (agent.id === 'news_analyst') {
  try {
    // 获取新闻数据
    const newsResult = await fetchNewsData(data.symbol)
    
    // 从统一新闻API的数据中提取数据源
    if (newsResult && newsResult.success && newsResult.data) {
      const sources = []
      const newsData = newsResult.data
      
      // 遍历所有数据源
      for (const [sourceName, sourceData] of Object.entries(newsData.sources || {})) {
        if (sourceData.status === 'success') {
          sources.push({
            source: sourceData.source || sourceName,
            count: sourceData.count || 0,
            title: `${sourceData.count || 0}条数据`
          })
        }
      }
      
      agentDataSources.value[agent.id] = sources
      console.log(`[news_analyst] 设置数据源:`, sources)
    } else {
      // 如果没有数据，使用默认值
      agentDataSources.value[agent.id] = [
        { source: '统一新闻API', count: 0, title: '暂无数据' }
      ]
    }
  } catch (e) {
    console.error('[news_analyst] 获取新闻数据失败:', e)
    agentDataSources.value[agent.id] = [
      { source: '统一新闻API', count: 0, title: '获取失败' }
    ]
  }
}
```

---

## 📊 修复效果

### 修复前
```
左侧数据面板:
  尝试数据源: AKShare > 聚合数据 > 新浪财经 > Tushare

新闻分析师卡片:
  📊 参考数据  3个来源
  - 东方财富: 最新市场动态...
  - 新浪财经: 行业板块分析...
  - 雪球: 投资者情绪报告...
```

### 修复后
```
左侧数据面板:
  数据源优先级: AKShare > 新浪财经 > 聚合数据 > Tushare

新闻分析师卡片:
  📊 参考数据  4个来源 | 80条数据
  - 实时新闻聚合器（东方财富） (10条)
  - AKShare个股新闻 (10条)
  - 财联社快讯 (10条)
  - 微博热议 (50条)
```

---

## 📁 修改的文件

### 1. AnalysisView.vue
- **第570行**: 更新数据源优先级显示
- **第444-486行**: 使用真实的新闻数据源

### 2. AgentCard.vue
- **第94-103行**: 更新模板，显示数据数量
- **第225-232行**: 添加totalDataCount计算属性
- **第235-244行**: 添加getSourceTooltip方法

---

## 🧪 测试步骤

### 1. 重启前端
```bash
cd alpha-council-vue
npm run serve
```

### 2. 测试流程
1. 打开浏览器 `http://localhost:8080`
2. 输入股票代码 `600519`
3. 点击"开始分析"
4. 观察左侧数据面板日志
5. 观察新闻分析师卡片的数据源显示

### 3. 预期结果

#### 左侧数据面板
```
06:15:00 ℹ️ 开始获取股票数据: 600519
06:15:00 📡 数据源优先级: AKShare > 新浪财经 > 聚合数据 > Tushare
06:15:01 ✅ 成功获取数据: 贵州茅台 (600519)
06:15:01 💰 价格: ¥1650.00 | 涨跌: +2.3%
06:15:01 ℹ️ 数据源: AKShare
```

#### 新闻分析师卡片
```
📰 新闻舆情分析师
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 参考数据  4个来源 | 80条数据
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
实时新闻聚合器（东方财富） (10条)
AKShare个股新闻 (10条)
财联社快讯 (10条)
微博热议 (50条)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析结果...
```

---

## 💡 关键改进

### 1. 数据透明化
- 显示真实的数据源
- 显示每个数据源的数据数量
- 显示总数据数量

### 2. 用户体验
- 清晰的数据来源标识
- 直观的数据数量显示
- 鼠标悬停显示详细信息

### 3. 数据准确性
- 使用真实的API数据
- 动态更新数据源信息
- 错误处理和降级

---

## 📝 注意事项

### 1. 数据源格式
确保数据源对象包含以下字段：
```javascript
{
  source: '数据源名称',
  count: 10,  // 数据条数
  title: '10条数据'  // 可选
}
```

### 2. 错误处理
如果新闻API调用失败，会显示：
```
📊 参考数据  1个来源 | 0条数据
统一新闻API (获取失败)
```

### 3. 性能优化
- 新闻数据在Agent分析时获取
- 避免重复调用API
- 使用缓存机制（待实现）

---

## 🚀 下一步优化

### 短期
1. ⏳ 添加数据源状态图标（成功/失败/加载中）
2. ⏳ 添加数据源刷新按钮
3. ⏳ 优化数据源显示样式

### 中期
4. ⏳ 实现数据缓存
5. ⏳ 添加数据源切换功能
6. ⏳ 显示数据获取时间

### 长期
7. ⏳ 数据源性能监控
8. ⏳ 数据源质量评分
9. ⏳ 智能推荐数据源

---

**前端数据源显示修复完成！** ✅

现在前端可以正确显示：
- ✅ 正确的数据源优先级
- ✅ 真实的数据来源
- ✅ 具体的数据数量
- ✅ 清晰的数据源信息
