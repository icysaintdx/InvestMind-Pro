# 本地开发指南

**更新时间**: 2025-12-02 01:57

---

## 🔧 本地开发环境说明

### 问题说明

在本地开发环境（`localhost:3000`）中，Vite 开发服务器**不会自动处理** `/api` 路由。这些 API 端点是为 Vercel 部署设计的 serverless 函数。

因此，如果直接访问 `/api/ai/siliconflow-models`，会返回 JavaScript 源代码而不是 JSON 数据，导致错误：

```
SyntaxError: Unexpected token 'i', "import fet"... is not valid JSON
```

---

## ✅ 解决方案

### 方案：开发环境直接调用 API

系统已自动处理这个问题：

- **开发环境** (`localhost` / `127.0.0.1`)
  - 前端直接调用硅基流动 API
  - 需要在前端输入 API Key
  - 绕过后端代理

- **生产环境** (Vercel 部署)
  - 使用后端 serverless 函数代理
  - 可以使用环境变量配置的 Key
  - 更安全

---

## 🚀 本地开发使用步骤

### 步骤 1: 启动开发服务器

```bash
npm run dev
```

### 步骤 2: 输入硅基流动 API Key

1. 打开浏览器访问 `http://localhost:3000`
2. 点击"API 密钥配置（可选）"展开面板
3. 在"硅基流动 API Key"输入框输入你的 Key
4. 点击"启动系统"

### 步骤 3: 验证模型加载

打开浏览器控制台（F12），应该看到：

```
[SiliconFlow] 开发模式：直接调用 API
[SiliconFlow] 成功获取 50 个模型
[App] 使用用户API Key加载了 50 个模型
```

### 步骤 4: 选择模型

在智能体配置中，模型下拉菜单应该显示所有加载的硅基流动模型。

---

## ⚠️ 常见问题

### Q1: 为什么本地开发必须在前端输入 API Key？

**A**: 因为本地开发环境没有运行 Vercel serverless 函数，无法使用后端代理。前端直接调用 API 是最简单的解决方案。

### Q2: 生产环境会有这个问题吗？

**A**: 不会。部署到 Vercel 后，serverless 函数会正常工作，可以使用环境变量配置的 API Key。

### Q3: 可以在本地使用 .env 配置吗？

**A**: 在当前架构下，本地开发环境的 `.env` 配置无法直接传递给前端（出于安全考虑）。建议：
- **本地开发**: 在前端输入 API Key
- **生产部署**: 在 Vercel 配置环境变量

### Q4: 如何在本地开发时使用后端代理？

**A**: 需要额外配置本地开发服务器。有两种方案：

#### 方案 A: 使用 Vercel CLI（推荐）

```bash
# 安装 Vercel CLI
npm install -g vercel

# 在项目目录运行
vercel dev
```

这样会在本地运行 Vercel 环境，支持 serverless 函数。

#### 方案 B: 配置 Vite 代理（复杂）

修改 `vite.config.ts` 添加代理配置，但需要额外的开发服务器来处理 API 请求。

---

## 📊 环境对比

| 特性 | 本地开发 (Vite) | 生产环境 (Vercel) |
|------|----------------|-------------------|
| API 路由 | ❌ 不支持 | ✅ 支持 |
| 后端代理 | ❌ 不可用 | ✅ 可用 |
| 环境变量 | ⚠️ 仅构建时 | ✅ 运行时可用 |
| API Key 来源 | 前端输入 | 环境变量 + 前端输入 |
| 安全性 | ⚠️ Key 暴露 | ✅ Key 隐藏 |

---

## 🎯 推荐工作流

### 本地开发

```bash
# 1. 启动开发服务器
npm run dev

# 2. 在浏览器中输入 API Key
# 3. 开发和测试功能
```

### 部署到生产

```bash
# 1. 配置 Vercel 环境变量
SILICONFLOW_API_KEY=sk-your-key-here

# 2. 部署
vercel --prod

# 3. 用户可以选择：
#    - 使用服务器配置的 Key（自动）
#    - 或在前端输入自己的 Key
```

---

## 🔒 安全最佳实践

### 本地开发

- ✅ 使用临时测试 API Key
- ✅ 不要将 Key 提交到 Git
- ✅ 开发完成后清除浏览器缓存

### 生产部署

- ✅ 在 Vercel 配置环境变量
- ✅ 使用生产环境的 API Key
- ✅ 定期轮换 API Key
- ✅ 监控 API 使用量

---

## 📝 代码实现

### siliconflowService.ts

```typescript
export async function fetchSiliconFlowModels(apiKey?: string) {
  const isDevelopment = window.location.hostname === 'localhost';
  
  if (isDevelopment) {
    // 开发环境：直接调用
    if (!apiKey) {
      console.warn('请在前端输入硅基流动 API Key');
      return [];
    }
    
    const response = await fetch('https://api.siliconflow.cn/v1/models', {
      headers: { 'Authorization': `Bearer ${apiKey}` }
    });
    // ... 处理响应
  } else {
    // 生产环境：使用后端代理
    const response = await fetch('/api/ai/siliconflow-models');
    // ... 处理响应
  }
}
```

---

## 🎉 总结

- ✅ 本地开发需要在前端输入 API Key
- ✅ 生产环境可以使用环境变量
- ✅ 系统已自动处理环境差异
- ✅ 无需额外配置即可开始开发

如有问题，请查看浏览器控制台的日志信息。
