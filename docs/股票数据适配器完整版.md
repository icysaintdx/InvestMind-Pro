# è‚¡ç¥¨æ•°æ®é€‚é…å™¨å®Œæ•´ç‰ˆ

> å®Œæˆæ—¶é—´: 2025-12-04 14:48  
> ç‰ˆæœ¬: 1.3.3  
> çŠ¶æ€: âœ… å·²å®Œæˆ

---

## ğŸ¯ ç›®æ ‡

åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„è‚¡ç¥¨æ•°æ®é€‚é…å™¨ï¼Œæ”¯æŒæ‰€æœ‰5ç§æ•°æ®æºçš„æ ¼å¼è§£æï¼š
1. **AKShare** - DataFrameè¡¨æ ¼æ ¼å¼
2. **Tushare** - Emojiæ ¼å¼ï¼ˆğŸ“Šã€ğŸ’°ã€ğŸ“ˆï¼‰
3. **æ–°æµªè´¢ç»** - ç®€å•é”®å€¼å¯¹æ ¼å¼
4. **èšåˆæ•°æ®** - JSONé£æ ¼æ ¼å¼
5. **BaoStock** - è¡¨æ ¼æ ¼å¼

---

## ğŸ“Š æ•°æ®æºæ ¼å¼ç¤ºä¾‹

### 1. AKShareæ ¼å¼ï¼ˆDataFrameè¡¨æ ¼ï¼‰

```
è‚¡ç¥¨ä»£ç : 000001
æ•°æ®æœŸé—´: None è‡³ None
æ•°æ®æ¡æ•°: 242æ¡

æœ€æ–°3å¤©æ•°æ®:
        æ—¥æœŸ   è‚¡ç¥¨ä»£ç     å¼€ç›˜    æ”¶ç›˜    æœ€é«˜    æœ€ä½     æˆäº¤é‡          æˆäº¤é¢   æŒ¯å¹…   æ¶¨è·Œå¹…   æ¶¨è·Œé¢  æ¢æ‰‹ç‡
2024-12-27 000001 11.87 11.83 11.90 11.66 1290012 1.518383e+09 2.02 -0.25 -0.03 0.66
2024-12-30 000001 11.78 11.95 11.97 11.78 1351846 1.610892e+09 1.61  1.01  0.12 0.70
2024-12-31 000001 11.93 11.70 11.99 11.70 1475367 1.747242e+09 2.43 -2.09 -0.25 0.76
```

**è§£æé€»è¾‘**:
- æŸ¥æ‰¾"æœ€æ–°3å¤©æ•°æ®"æ ‡è®°
- æå–è¡¨æ ¼æœ€åä¸€è¡Œçš„æ•°å­—
- æ ¼å¼: æ—¥æœŸ ä»£ç  å¼€ç›˜ æ”¶ç›˜ æœ€é«˜ æœ€ä½ æˆäº¤é‡ æˆäº¤é¢ æŒ¯å¹… æ¶¨è·Œå¹… æ¶¨è·Œé¢ æ¢æ‰‹ç‡

---

### 2. Tushareæ ¼å¼ï¼ˆEmojiï¼‰

```
ğŸ“Š å¹³å®‰é“¶è¡Œ(000001) - Tushareæ•°æ®
æ•°æ®æœŸé—´: 2024-01-01 è‡³ 2024-12-31
æ•°æ®æ¡æ•°: 242æ¡

ğŸ’° æœ€æ–°ä»·æ ¼: Â¥11.70
ğŸ“ˆ æ¶¨è·Œé¢: -0.25 (-2.09%)

ğŸ“Š ä»·æ ¼ç»Ÿè®¡:
   æœ€é«˜ä»·: Â¥13.43
   æœ€ä½ä»·: Â¥8.96
   å¹³å‡ä»·: Â¥10.50
   æˆäº¤é‡: 1,475,367è‚¡
```

**è§£æé€»è¾‘**:
- æŸ¥æ‰¾emojiæ ‡è®°ï¼ˆğŸ“Šã€ğŸ’°ã€ğŸ“ˆï¼‰
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–ä»·æ ¼ã€æ¶¨è·Œå¹…ç­‰ä¿¡æ¯
- æ ¼å¼: `ğŸ’° æœ€æ–°ä»·æ ¼: Â¥11.70`

---

### 3. æ–°æµªè´¢ç»æ ¼å¼ï¼ˆé”®å€¼å¯¹ï¼‰

```
è‚¡ç¥¨åç§°: å¹³å®‰é“¶è¡Œ
è‚¡ç¥¨ä»£ç : 000001
æœ€æ–°ä»·æ ¼: 11.70
æ¶¨è·Œå¹…: -2.09%
å¼€ç›˜ä»·: 11.93
æœ€é«˜ä»·: 11.99
æœ€ä½ä»·: 11.70
æˆäº¤é‡: 1475367
```

**è§£æé€»è¾‘**:
- ç®€å•çš„é”®å€¼å¯¹æ ¼å¼
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼: `æœ€æ–°ä»·æ ¼[ï¼š:]\s*([\d.]+)`
- ç›´æ¥æå–æ•°å€¼

---

### 4. èšåˆæ•°æ®æ ¼å¼ï¼ˆJSONé£æ ¼ï¼‰

```
{
  "name": "å¹³å®‰é“¶è¡Œ",
  "symbol": "000001",
  "nowpri": "11.70",
  "changepercent": "-2.09",
  "openpri": "11.93",
  "maxpri": "11.99",
  "minpri": "11.70",
  "traNumber": "1475367"
}
```

**è§£æé€»è¾‘**:
- JSONé£æ ¼çš„é”®å€¼å¯¹
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼: `"nowpri"\s*:\s*"([\d.]+)"`
- æå–å¼•å·å†…çš„æ•°å€¼

---

### 5. BaoStockæ ¼å¼ï¼ˆè¡¨æ ¼ï¼‰

```
æœ€æ–°æ•°æ®:
date       code      open   close   high   low    volume
2024-12-31 sz.000001 11.93  11.70   11.99  11.70  1475367
```

**è§£æé€»è¾‘**:
- æŸ¥æ‰¾"æœ€æ–°æ•°æ®"æˆ–"date"æ ‡è®°
- æŒ‰ç©ºæ ¼åˆ†å‰²æå–æ•°æ®
- æ ¼å¼: date code open close high low volume

---

## ğŸ”§ è§£æå™¨æ¶æ„

### ä¸»è§£ææ–¹æ³•

```python
@staticmethod
def parse_text_data(text: str, symbol: str) -> Dict:
    """
    ä»æ–‡æœ¬æ•°æ®ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯
    æ”¯æŒæ‰€æœ‰5ç§æ•°æ®æºæ ¼å¼
    """
    result = {åˆå§‹åŒ–å­—å…¸}
    
    # æ­¥éª¤1: è¯†åˆ«æ•°æ®æº
    if "Tushare" in text or "ğŸ“Š" in text:
        result["data_source"] = "tushare"
    elif "æœ€æ–°3å¤©æ•°æ®" in text:
        result["data_source"] = "akshare"
    # ... å…¶ä»–è¯†åˆ«é€»è¾‘
    
    # æ­¥éª¤2: è°ƒç”¨å¯¹åº”çš„è§£æå™¨
    if result["data_source"] == "tushare":
        _parse_tushare_format(text, result)
    elif result["data_source"] == "akshare":
        _parse_akshare_format(text, result)
    # ... å…¶ä»–è§£æå™¨
    else:
        _parse_generic_format(text, result)  # é€šç”¨è§£æå™¨
    
    return result
```

### 5ä¸ªä¸“ç”¨è§£æå™¨

1. **`_parse_tushare_format()`** - è§£æTushare emojiæ ¼å¼
2. **`_parse_akshare_format()`** - è§£æAKShareè¡¨æ ¼æ ¼å¼
3. **`_parse_sina_format()`** - è§£ææ–°æµªè´¢ç»é”®å€¼å¯¹æ ¼å¼
4. **`_parse_juhe_format()`** - è§£æèšåˆæ•°æ®JSONæ ¼å¼
5. **`_parse_baostock_format()`** - è§£æBaoStockè¡¨æ ¼æ ¼å¼

### é€šç”¨è§£æå™¨

```python
@staticmethod
def _parse_generic_format(text: str, result: Dict) -> None:
    """é€šç”¨è§£æå™¨ï¼ˆå…¼å®¹æ‰€æœ‰æ ¼å¼ï¼‰"""
    # ä¾æ¬¡å°è¯•æ‰€æœ‰è§£æå™¨
    _parse_tushare_format(text, result)
    if result["price"] == "N/A":
        _parse_akshare_format(text, result)
    if result["price"] == "N/A":
        _parse_sina_format(text, result)
    if result["price"] == "N/A":
        _parse_juhe_format(text, result)
    if result["price"] == "N/A":
        _parse_baostock_format(text, result)
```

---

## ğŸ“ ç»Ÿä¸€è¾“å‡ºæ ¼å¼

æ‰€æœ‰è§£æå™¨éƒ½è¾“å‡ºç»Ÿä¸€çš„å­—å…¸æ ¼å¼ï¼š

```python
{
    "symbol": "000001",           # è‚¡ç¥¨ä»£ç 
    "name": "å¹³å®‰é“¶è¡Œ",            # è‚¡ç¥¨åç§°
    "price": "11.70",             # æœ€æ–°ä»·æ ¼
    "change": "-2.09%",           # æ¶¨è·Œå¹…
    "change_amount": "-0.25",     # æ¶¨è·Œé¢
    "open": "11.93",              # å¼€ç›˜ä»·
    "close": "11.70",             # æ”¶ç›˜ä»·
    "high": "11.99",              # æœ€é«˜ä»·
    "low": "11.70",               # æœ€ä½ä»·
    "volume": "1475367",          # æˆäº¤é‡
    "amount": "N/A",              # æˆäº¤é¢
    "data_source": "akshare",     # æ•°æ®æº
    "raw_data": "åŸå§‹æ–‡æœ¬..."      # åŸå§‹æ•°æ®
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•AKShareæ ¼å¼

```python
text = """
è‚¡ç¥¨ä»£ç : 000001
æœ€æ–°3å¤©æ•°æ®:
2024-12-31 000001 11.93 11.70 11.99 11.70 1475367 1.747242e+09 2.43 -2.09 -0.25 0.76
"""

result = StockDataAdapter.parse_text_data(text, "000001")
assert result["price"] == "11.70"
assert result["change"] == "-2.09%"
assert result["data_source"] == "akshare"
```

### æµ‹è¯•Tushareæ ¼å¼

```python
text = """
ğŸ“Š å¹³å®‰é“¶è¡Œ(000001) - Tushareæ•°æ®
ğŸ’° æœ€æ–°ä»·æ ¼: Â¥11.70
ğŸ“ˆ æ¶¨è·Œé¢: -0.25 (-2.09%)
"""

result = StockDataAdapter.parse_text_data(text, "000001")
assert result["price"] == "11.70"
assert result["change"] == "-2.09%"
assert result["data_source"] == "tushare"
```

---

## ğŸ’¡ å…³é”®ç‰¹æ€§

### 1. æ™ºèƒ½è¯†åˆ«
- è‡ªåŠ¨è¯†åˆ«5ç§æ•°æ®æºæ ¼å¼
- åŸºäºå…³é”®å­—å’Œç‰¹å¾æ ‡è®°

### 2. å®¹é”™æ€§å¼º
- é€šç”¨è§£æå™¨ä½œä¸ºfallback
- ä¾æ¬¡å°è¯•æ‰€æœ‰è§£æå™¨
- å³ä½¿éƒ¨åˆ†å­—æ®µç¼ºå¤±ä¹Ÿèƒ½å·¥ä½œ

### 3. ç»Ÿä¸€è¾“å‡º
- æ‰€æœ‰æ•°æ®æºè¾“å‡ºç›¸åŒæ ¼å¼
- ä¾¿äºåç»­å¤„ç†å’Œæ˜¾ç¤º

### 4. è¯¦ç»†æ—¥å¿—
- è®°å½•è¯†åˆ«è¿‡ç¨‹
- è®°å½•è§£æç»“æœ
- ä¾¿äºè°ƒè¯•

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åœ¨åç«¯APIä¸­ä½¿ç”¨

```python
from backend.dataflows.data_source_manager import DataSourceManager
from backend.dataflows.stock_data_adapter import StockDataAdapter

# è·å–åŸå§‹æ•°æ®
manager = DataSourceManager()
result_text = manager.get_stock_data("000001")

# è§£ææ•°æ®
stock_info = StockDataAdapter.parse_text_data(result_text, "000001")

# éªŒè¯æ•°æ®
is_valid = StockDataAdapter.validate_data(stock_info)

if is_valid:
    print(f"âœ… {stock_info['name']} {stock_info['price']} {stock_info['change']}")
else:
    print(f"âŒ æ•°æ®éªŒè¯å¤±è´¥")
```

---

## ğŸ“Š æ•°æ®æºä¼˜å…ˆçº§

åœ¨`DataSourceManager`ä¸­çš„ä¼˜å…ˆçº§ï¼š

1. **AKShare** - é»˜è®¤æ•°æ®æºï¼Œå…è´¹æ— é™åˆ¶
2. **æ–°æµªè´¢ç»** - å¤‡ç”¨æ•°æ®æºï¼Œå…è´¹æ— é™åˆ¶
3. **èšåˆæ•°æ®** - éœ€è¦API Keyï¼Œæ¯å¤©50æ¬¡
4. **Tushare** - éœ€è¦Tokenï¼Œæœ‰ç§¯åˆ†é™åˆ¶
5. **BaoStock** - å…è´¹ï¼Œä½†æ•°æ®æ›´æ–°è¾ƒæ…¢

---

## âœ… å®ŒæˆçŠ¶æ€

- [x] AKShareæ ¼å¼è§£æå™¨
- [x] Tushareæ ¼å¼è§£æå™¨
- [x] æ–°æµªè´¢ç»æ ¼å¼è§£æå™¨
- [x] èšåˆæ•°æ®æ ¼å¼è§£æå™¨
- [x] BaoStockæ ¼å¼è§£æå™¨
- [x] é€šç”¨è§£æå™¨ï¼ˆfallbackï¼‰
- [x] æ•°æ®éªŒè¯å™¨
- [x] è¯¦ç»†æ—¥å¿—è®°å½•
- [x] ç»Ÿä¸€è¾“å‡ºæ ¼å¼

---

**è‚¡ç¥¨æ•°æ®é€‚é…å™¨å®Œæ•´ç‰ˆå·²å®Œæˆï¼** âœ…

**æ–‡ä»¶**: `backend/dataflows/stock_data_adapter.py`

**æµ‹è¯•**: é‡å¯åç«¯ï¼Œè¾“å…¥ä»»æ„è‚¡ç¥¨ä»£ç æµ‹è¯•
