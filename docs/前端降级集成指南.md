# 前端降级功能集成指南

## 1. 添加 agentRole 参数

在 `AnalysisView.vue` 中，调用智能体时添加角色映射：

```javascript
// 智能体角色映射
const AGENT_ROLE_MAP = {
  'news_analyst': 'NEWS',
  'fundamental': 'FUNDAMENTAL', 
  'technical': 'TECHNICAL',
  'bull_researcher': 'BULL',
  'bear_researcher': 'BEAR',
  'risk_manager': 'RISK',
  'macro': 'MACRO',
  'industry': 'INDUSTRY',
  'funds': 'FUNDAMENTAL',
  'manager_fundamental': 'MANAGER',
  'manager_momentum': 'MANAGER',
  'risk_system': 'RISK',
  'risk_portfolio': 'RISK',
  'gm': 'MANAGER',
  'china_market': 'NEWS',
  'social_analyst': 'NEWS',
  'risk_aggressive': 'RISK',
  'risk_conservative': 'RISK',
  'risk_neutral': 'RISK',
  'research_manager': 'MANAGER',
  'trader': 'TRADER'
}

// 调用分析时
const response = await fetch('/api/analyze', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    agent_id: agentId,
    stock_code: stockCode,
    stock_data: stockData,
    previous_outputs: previousOutputs,
    // agentRole 已在后端自动处理，但前端也可以传
    agentRole: AGENT_ROLE_MAP[agentId]
  })
})
```

## 2. 显示降级提示

```javascript
// 在 AgentCard.vue 中添加降级标识
if (response.data.fallback_level > 0) {
  // 显示降级标识
  agentStatus.value = '降级响应'
  
  if (response.data.fallback_level === 99) {
    // 使用了默认响应
    showWarning('使用了预设的保守建议')
  } else {
    // 使用了压缩响应
    showInfo(`已压缩到级别${response.data.fallback_level}`)
  }
}
```

## 3. 添加降级统计

```javascript
// 在 AnalysisView.vue 中统计降级情况
const fallbackStats = ref({
  total: 0,
  defaultResponses: 0,
  compressedResponses: 0,
  successRate: 100
})

// 更新统计
function updateFallbackStats(response) {
  fallbackStats.value.total++
  
  if (response.fallback_level === 99) {
    fallbackStats.value.defaultResponses++
  } else if (response.fallback_level > 0) {
    fallbackStats.value.compressedResponses++
  }
  
  // 计算成功率
  const failed = fallbackStats.value.defaultResponses
  const total = fallbackStats.value.total
  fallbackStats.value.successRate = ((total - failed) / total * 100).toFixed(1)
}
```

## 4. 降级状态显示组件

```vue
<!-- FallbackIndicator.vue -->
<template>
  <div v-if="showIndicator" class="fallback-indicator">
    <el-tooltip :content="tooltipContent">
      <el-tag 
        :type="tagType"
        size="mini"
        effect="plain"
      >
        <i :class="iconClass"></i>
        {{ label }}
      </el-tag>
    </el-tooltip>
  </div>
</template>

<script setup>
import { computed } from 'vue'

const props = defineProps({
  fallbackLevel: {
    type: Number,
    default: 0
  }
})

const showIndicator = computed(() => props.fallbackLevel > 0)

const label = computed(() => {
  if (props.fallbackLevel === 99) return '默认响应'
  if (props.fallbackLevel > 0) return `L${props.fallbackLevel}压缩`
  return ''
})

const tagType = computed(() => {
  if (props.fallbackLevel === 99) return 'warning'
  if (props.fallbackLevel > 0) return 'info'
  return 'success'
})

const iconClass = computed(() => {
  if (props.fallbackLevel === 99) return 'el-icon-warning'
  if (props.fallbackLevel > 0) return 'el-icon-data-analysis'
  return 'el-icon-success'
})

const tooltipContent = computed(() => {
  if (props.fallbackLevel === 99) {
    return '由于网络问题，使用了预设的保守建议'
  }
  if (props.fallbackLevel === 3) {
    return '提示词压缩到10%（最小化）'
  }
  if (props.fallbackLevel === 2) {
    return '提示词压缩到25%（深度压缩）'
  }
  if (props.fallbackLevel === 1) {
    return '提示词压缩到50%（轻度压缩）'
  }
  return '正常响应'
})
</script>

<style scoped>
.fallback-indicator {
  display: inline-block;
  margin-left: 8px;
}
</style>
```

## 5. 环境变量控制

```javascript
// 在 .env 中添加
VUE_APP_USE_FALLBACK=true

// 在代码中使用
const useFallback = process.env.VUE_APP_USE_FALLBACK === 'true'

if (!useFallback) {
  // 禁用降级功能的 UI 提示
  console.log('降级功能已禁用')
}
```

## 6. 降级监控面板

```vue
<!-- FallbackMonitor.vue -->
<template>
  <el-card class="fallback-monitor">
    <template #header>
      <div class="card-header">
        <span>降级监控</span>
        <el-button 
          size="mini" 
          @click="refreshStats"
        >
          刷新
        </el-button>
      </div>
    </template>
    
    <el-row :gutter="20">
      <el-col :span="6">
        <el-statistic 
          title="总请求数" 
          :value="stats.total"
        />
      </el-col>
      
      <el-col :span="6">
        <el-statistic 
          title="成功率" 
          :value="stats.successRate"
          suffix="%"
        />
      </el-col>
      
      <el-col :span="6">
        <el-statistic 
          title="压缩响应" 
          :value="stats.compressed"
          :value-style="{ color: '#409EFF' }"
        />
      </el-col>
      
      <el-col :span="6">
        <el-statistic 
          title="默认响应" 
          :value="stats.defaults"
          :value-style="{ color: '#E6A23C' }"
        />
      </el-col>
    </el-row>
    
    <!-- 降级详情 -->
    <el-divider />
    
    <el-table 
      :data="recentFallbacks" 
      size="small"
      max-height="300"
    >
      <el-table-column 
        prop="time" 
        label="时间" 
        width="100"
      />
      <el-table-column 
        prop="agent" 
        label="智能体"
        width="120"
      />
      <el-table-column 
        prop="level" 
        label="降级级别"
        width="100"
      >
        <template #default="{ row }">
          <el-tag 
            size="mini"
            :type="row.level === 99 ? 'warning' : 'info'"
          >
            {{ row.level === 99 ? '默认' : `L${row.level}` }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column 
        prop="reason" 
        label="原因"
      />
    </el-table>
  </el-card>
</template>

<script setup>
import { ref, onMounted } from 'vue'

const stats = ref({
  total: 0,
  successRate: 100,
  compressed: 0,
  defaults: 0
})

const recentFallbacks = ref([])

async function refreshStats() {
  try {
    // 从后端获取降级统计
    const response = await fetch('/api/fallback/stats')
    const data = await response.json()
    
    // 更新统计数据
    stats.value = data.summary
    recentFallbacks.value = data.recent || []
  } catch (error) {
    console.error('获取降级统计失败:', error)
  }
}

onMounted(() => {
  refreshStats()
  // 定期刷新
  setInterval(refreshStats, 30000) // 30秒刷新一次
})
</script>

<style scoped>
.fallback-monitor {
  margin: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
</style>
```

## 7. A/B 测试实现

```javascript
// 随机分组
const useExperimentalFallback = Math.random() > 0.5

// 记录分组
localStorage.setItem('ab_test_group', useExperimentalFallback ? 'B' : 'A')

// 发送分析请求时带上分组信息
const response = await fetch('/api/analyze', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-AB-Test-Group': useExperimentalFallback ? 'B' : 'A'
  },
  body: JSON.stringify({...})
})

// 记录指标
function recordMetrics(group, metrics) {
  const data = {
    group,
    timestamp: Date.now(),
    ...metrics
  }
  
  // 发送到分析服务
  fetch('/api/metrics/ab-test', {
    method: 'POST',
    body: JSON.stringify(data)
  })
}
```

## 8. 用户提示

```javascript
// 当使用降级响应时，给用户友好提示
function showFallbackNotification(level) {
  if (level === 99) {
    ElNotification({
      title: '网络状况不佳',
      message: '当前使用预设的保守建议，建议稍后重试获取更精准的分析',
      type: 'warning',
      duration: 5000
    })
  } else if (level > 0) {
    ElNotification({
      title: '分析已优化',
      message: '为确保响应速度，部分内容已精简',
      type: 'info',
      duration: 3000
    })
  }
}
```

## 9. 重试机制

```javascript
// 允许用户手动重试获取完整分析
async function retryAnalysis(agentId) {
  const retryButton = document.querySelector(`#retry-${agentId}`)
  retryButton.disabled = true
  
  try {
    // 强制使用原始请求（不降级）
    const response = await fetch('/api/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Force-No-Fallback': 'true'  // 禁用降级
      },
      body: JSON.stringify({...})
    })
    
    if (response.ok) {
      // 更新显示
      updateAgentResult(agentId, await response.json())
    }
  } finally {
    retryButton.disabled = false
  }
}
```

---

## 总结

降级功能已在后端完整实现，前端集成主要是：
1. **显示降级状态** - 让用户知道
2. **统计监控** - 了解降级频率
3. **A/B测试** - 对比效果
4. **用户交互** - 提供重试选项

后端会自动处理 `agentRole`，前端主要是 UI 展示和用户体验优化。
