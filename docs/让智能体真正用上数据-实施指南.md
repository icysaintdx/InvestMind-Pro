# è®©æ™ºèƒ½ä½“çœŸæ­£ç”¨ä¸Šæ•°æ® - å®æ–½æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025-12-05 06:10  
**çŠ¶æ€**: âœ… APIå·²å°±ç»ªï¼Œåˆ†æå¸ˆå¯ç”¨

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®æ¨¡å— âœ…
- `backend/dataflows/akshare/fund_flow_data.py` - èµ„é‡‘æµå‘
- `backend/dataflows/akshare/financial_data.py` - è´¢åŠ¡æ•°æ®
- `backend/dataflows/akshare/social_media_data.py` - ç¤¾äº¤åª’ä½“

### 2. APIç«¯ç‚¹ âœ…
- `/api/akshare/fund-flow/*` - èµ„é‡‘æµå‘API (4ä¸ªç«¯ç‚¹)
- `/api/akshare/financial/*` - è´¢åŠ¡æ•°æ®API (2ä¸ªç«¯ç‚¹)
- `/api/akshare/social-media/*` - ç¤¾äº¤åª’ä½“API (3ä¸ªç«¯ç‚¹)

### 3. åˆ†æå¸ˆé›†æˆ âœ…
- âœ… ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ - å·²æ·»åŠ APIè¯´æ˜åˆ°æç¤ºè¯

---

## ğŸ¯ å¦‚ä½•è®©åˆ†æå¸ˆä½¿ç”¨æ•°æ®

### æ–¹å¼1: åœ¨æç¤ºè¯ä¸­è¯´æ˜APIï¼ˆå·²å®æ–½ï¼‰

**ç¤ºä¾‹ï¼šç¤¾äº¤åª’ä½“åˆ†æå¸ˆ**

```python
system_message = """
æ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ...

ğŸ“Š æ•°æ®è·å–æ–¹å¼ï¼š
æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ API ç«¯ç‚¹è·å–å®æ—¶ç¤¾äº¤åª’ä½“æ•°æ®ï¼š
- GET http://localhost:8000/api/akshare/social-media/weibo/stock-hot
- GET http://localhost:8000/api/akshare/social-media/weibo/hot-search
- GET http://localhost:8000/api/akshare/social-media/all

æ‚¨çš„ä¸»è¦èŒè´£åŒ…æ‹¬...
"""
```

### æ–¹å¼2: åœ¨åˆ†ææµç¨‹ä¸­è‡ªåŠ¨æ³¨å…¥æ•°æ®

ä¿®æ”¹ `backend/server.py` çš„åˆ†æç«¯ç‚¹ï¼š

```python
@app.post("/api/analyze")
async def analyze_stock(request: AnalyzeRequest):
    symbol = request.symbol
    
    # 1. è·å–èµ„é‡‘æµå‘æ•°æ®
    import requests
    fund_flow_response = requests.get(
        f"http://localhost:8000/api/akshare/fund-flow/{symbol}"
    )
    fund_flow_data = fund_flow_response.json()["data"]
    
    # 2. è·å–ç¤¾äº¤åª’ä½“æ•°æ®
    social_response = requests.get(
        "http://localhost:8000/api/akshare/social-media/all"
    )
    social_data = social_response.json()["data"]
    
    # 3. å°†æ•°æ®æ³¨å…¥åˆ°stateä¸­
    state = {
        "company_of_interest": symbol,
        "fund_flow_data": fund_flow_data,
        "social_media_data": social_data,
        # ... å…¶ä»–æ•°æ®
    }
    
    # 4. è°ƒç”¨åˆ†ææµç¨‹
    result = await run_analysis(state)
    return result
```

### æ–¹å¼3: åˆ›å»ºæ•°æ®å·¥å…·ï¼ˆæ¨èï¼‰

ä¸ºæ¯ä¸ªåˆ†æå¸ˆåˆ›å»ºä¸“ç”¨å·¥å…·ï¼š

```python
# backend/agents/utils/analyst_tools.py

class FundFlowDataTool(BaseTool):
    """èµ„é‡‘æµå‘æ•°æ®å·¥å…·"""
    name = "get_fund_flow_data"
    description = "è·å–è‚¡ç¥¨çš„èµ„é‡‘æµå‘æ•°æ®ï¼ŒåŒ…æ‹¬åŒ—å‘èµ„é‡‘ã€è¡Œä¸šèµ„é‡‘æµç­‰"
    
    def _run(self, symbol: str) -> str:
        import requests
        response = requests.get(
            f"http://localhost:8000/api/akshare/fund-flow/{symbol}"
        )
        data = response.json()["data"]
        return format_fund_flow_data(data)

class SocialMediaDataTool(BaseTool):
    """ç¤¾äº¤åª’ä½“æ•°æ®å·¥å…·"""
    name = "get_social_media_data"
    description = "è·å–å¾®åšçƒ­æœã€å¾®åšè‚¡ç¥¨çƒ­è®®ç­‰ç¤¾äº¤åª’ä½“æ•°æ®"
    
    def _run(self) -> str:
        import requests
        response = requests.get(
            "http://localhost:8000/api/akshare/social-media/all"
        )
        data = response.json()["data"]
        return format_social_media_data(data)
```

ç„¶ååœ¨åˆ†æå¸ˆä¸­æ·»åŠ å·¥å…·ï¼š

```python
def create_social_media_analyst(llm, toolkit):
    # æ·»åŠ ç¤¾äº¤åª’ä½“æ•°æ®å·¥å…·
    tools = [
        toolkit.get_stock_news_openai,
        SocialMediaDataTool(),  # æ–°å¢
    ]
    # ... å…¶ä½™ä»£ç 
```

---

## ğŸ“‹ éœ€è¦ä¿®æ”¹çš„åˆ†æå¸ˆ

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®æ”¹ï¼‰

#### 1. èµ„é‡‘æµå‘åˆ†æå¸ˆ (funds)
**æ–‡ä»¶**: `backend/agents/analysts/` (legacyæ¨¡å¼ï¼Œå¯èƒ½åœ¨å…¶ä»–ä½ç½®)

**æ·»åŠ åˆ°æç¤ºè¯**:
```python
ğŸ“Š æ•°æ®è·å–æ–¹å¼ï¼š
- GET http://localhost:8000/api/akshare/fund-flow/{symbol}  # ä¸ªè‚¡èµ„é‡‘æµå‘
- GET http://localhost:8000/api/akshare/fund-flow/north-bound/realtime  # åŒ—å‘èµ„é‡‘
- GET http://localhost:8000/api/akshare/fund-flow/industry/realtime  # è¡Œä¸šèµ„é‡‘æµ
- GET http://localhost:8000/api/akshare/fund-flow/concept/realtime  # æ¦‚å¿µèµ„é‡‘æµ
```

#### 2. åŸºæœ¬é¢ä¼°å€¼åˆ†æå¸ˆ (fundamental)
**æ–‡ä»¶**: `backend/agents/analysts/fundamentals_analyst.py`

**æ·»åŠ åˆ°æç¤ºè¯**:
```python
ğŸ“Š æ•°æ®è·å–æ–¹å¼ï¼š
- GET http://localhost:8000/api/akshare/financial/{symbol}  # ä¸‰å¤§è´¢åŠ¡æŠ¥è¡¨
- GET http://localhost:8000/api/akshare/financial/{symbol}/summary  # è´¢åŠ¡æ‘˜è¦
```

#### 3. è¡Œä¸šè½®åŠ¨åˆ†æå¸ˆ (industry)
**æ–‡ä»¶**: `backend/agents/analysts/` (éœ€è¦æŸ¥æ‰¾)

**æ·»åŠ åˆ°æç¤ºè¯**:
```python
ğŸ“Š æ•°æ®è·å–æ–¹å¼ï¼š
- GET http://localhost:8000/api/akshare/fund-flow/industry/realtime  # è¡Œä¸šèµ„é‡‘æµ
```

### ä¸­ä¼˜å…ˆçº§

#### 4. å®è§‚æ”¿ç­–åˆ†æå¸ˆ (macro)
**å¾…å¼€å‘**: å®è§‚ç»æµæ•°æ®API

#### 5. é£é™©ç³»ç»Ÿåˆ†æå¸ˆ (risk_system)
**å¾…å¼€å‘**: æœŸæƒé£é™©æ•°æ®API

---

## ğŸš€ ç«‹å³æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1: æµ‹è¯•APIï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# å¯åŠ¨æœåŠ¡å™¨
python backend/server.py

# æµ‹è¯•èµ„é‡‘æµå‘API
curl http://localhost:8000/api/akshare/fund-flow/600519

# æµ‹è¯•ç¤¾äº¤åª’ä½“API
curl http://localhost:8000/api/akshare/social-media/all

# æµ‹è¯•è´¢åŠ¡æ•°æ®API
curl http://localhost:8000/api/akshare/financial/600519/summary
```

### æ­¥éª¤2: ä¿®æ”¹åˆ†æå¸ˆæç¤ºè¯ï¼ˆ30åˆ†é’Ÿï¼‰

1. âœ… ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ - å·²å®Œæˆ
2. â³ èµ„é‡‘æµå‘åˆ†æå¸ˆ - å¾…ä¿®æ”¹
3. â³ åŸºæœ¬é¢ä¼°å€¼åˆ†æå¸ˆ - å¾…ä¿®æ”¹
4. â³ è¡Œä¸šè½®åŠ¨åˆ†æå¸ˆ - å¾…ä¿®æ”¹

### æ­¥éª¤3: æµ‹è¯•åˆ†ææµç¨‹ï¼ˆ15åˆ†é’Ÿï¼‰

```bash
# è¿è¡Œå®Œæ•´åˆ†æ
python test_analysis_with_data.py
```

### æ­¥éª¤4: å‰ç«¯é›†æˆï¼ˆ1å°æ—¶ï¼‰

åœ¨æ–°é—»é¢æ¿æ·»åŠ ç¤¾äº¤åª’ä½“ä¸“åŒºã€‚

---

## ğŸ“ ä¿®æ”¹æ¨¡æ¿

### æ¨¡æ¿1: æ·»åŠ APIè¯´æ˜åˆ°æç¤ºè¯

```python
system_message = (
    """æ‚¨æ˜¯ä¸€ä½ä¸“ä¸šçš„XXXåˆ†æå¸ˆ...

ğŸ“Š æ•°æ®è·å–æ–¹å¼ï¼š
æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ API ç«¯ç‚¹è·å–å®æ—¶æ•°æ®ï¼š
- GET http://localhost:8000/api/akshare/XXX/XXX  # æ•°æ®è¯´æ˜

æ‚¨çš„ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š
1. ...
2. ...
"""
)
```

### æ¨¡æ¿2: åˆ›å»ºæ•°æ®å·¥å…·

```python
class XXXDataTool(BaseTool):
    """XXXæ•°æ®å·¥å…·"""
    name = "get_xxx_data"
    description = "è·å–XXXæ•°æ®"
    
    def _run(self, symbol: str = None) -> str:
        import requests
        url = f"http://localhost:8000/api/akshare/xxx/{symbol}" if symbol else "http://localhost:8000/api/akshare/xxx"
        response = requests.get(url)
        data = response.json()["data"]
        return format_xxx_data(data)
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ•°æ®æ ¼å¼åŒ–
ä¸ºLLMæä¾›æ¸…æ™°çš„æ•°æ®æ ¼å¼ï¼š

```python
def format_fund_flow_data(data: dict) -> str:
    """æ ¼å¼åŒ–èµ„é‡‘æµå‘æ•°æ®"""
    output = []
    output.append("=" * 60)
    output.append("ğŸ“Š èµ„é‡‘æµå‘æ•°æ®")
    output.append("=" * 60)
    
    # åŒ—å‘èµ„é‡‘
    if data.get('north_bound_realtime'):
        output.append("\nğŸŒ åŒ—å‘èµ„é‡‘å®æ—¶:")
        latest = data['north_bound_realtime'][0]
        output.append(f"  - åŒ—å‘èµ„é‡‘: {latest.get('åŒ—å‘èµ„é‡‘')}ä¸‡å…ƒ")
    
    # ä¸ªè‚¡èµ„é‡‘æµ
    if data.get('stock_detail'):
        output.append("\nğŸ’° ä¸ªè‚¡èµ„é‡‘æµ:")
        flow = data['stock_detail']['fund_flow']
        output.append(f"  - å‡€é¢: {flow.get('å‡€é¢')}")
    
    return "\n".join(output)
```

### 2. é”™è¯¯å¤„ç†
APIè°ƒç”¨å¯èƒ½å¤±è´¥ï¼Œéœ€è¦ä¼˜é›…å¤„ç†ï¼š

```python
def get_fund_flow_data_safe(symbol: str) -> str:
    """å®‰å…¨è·å–èµ„é‡‘æµå‘æ•°æ®"""
    try:
        response = requests.get(
            f"http://localhost:8000/api/akshare/fund-flow/{symbol}",
            timeout=10
        )
        if response.status_code == 200:
            data = response.json()["data"]
            return format_fund_flow_data(data)
        else:
            return f"âŒ APIè¿”å›é”™è¯¯: {response.status_code}"
    except Exception as e:
        return f"âŒ è·å–æ•°æ®å¤±è´¥: {str(e)}"
```

### 3. ç¼“å­˜æœºåˆ¶
é¿å…é‡å¤è°ƒç”¨APIï¼š

```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_social_media_data_cached(cache_key: str) -> str:
    """ç¼“å­˜çš„ç¤¾äº¤åª’ä½“æ•°æ®"""
    response = requests.get(
        "http://localhost:8000/api/akshare/social-media/all"
    )
    return response.json()["data"]

# ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºç¼“å­˜é”®ï¼Œæ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
cache_key = datetime.now().strftime("%Y%m%d%H%M")[:11]  # ç²¾ç¡®åˆ°5åˆ†é’Ÿ
data = get_social_media_data_cached(cache_key)
```

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### æ•°æ®å¯ç”¨æ€§
- âœ… APIå“åº”æ—¶é—´ < 2ç§’
- âœ… æ•°æ®å®Œæ•´æ€§ > 95%
- âœ… APIå¯ç”¨æ€§ > 99%

### åˆ†æå¸ˆä½¿ç”¨
- âœ… åˆ†æå¸ˆèƒ½è·å–åˆ°æ•°æ®
- âœ… æ•°æ®æ ¼å¼æ¸…æ™°æ˜“æ‡‚
- âœ… åˆ†ææŠ¥å‘ŠåŒ…å«æ•°æ®å¼•ç”¨

### ç”¨æˆ·ä½“éªŒ
- âœ… åˆ†æé€Ÿåº¦ < 30ç§’
- âœ… æŠ¥å‘Šè´¨é‡æå‡
- âœ… æ•°æ®å¯è§†åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/æ•°æ®é›†æˆä½¿ç”¨æŒ‡å—.md` - æ•°æ®é›†æˆæ€»è§ˆ
- `docs/AKShareæ•°æ®é›†æˆæ€»ç»“æŠ¥å‘Š.md` - æ•°æ®æ¨¡å—è¯¦æƒ…
- `backend/api/akshare_data_api.py` - APIç«¯ç‚¹å®ç°

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2025-12-05 06:15  
**ä¸‹ä¸€æ­¥**: ä¿®æ”¹å‰©ä½™åˆ†æå¸ˆçš„æç¤ºè¯ï¼Œæµ‹è¯•å®Œæ•´åˆ†ææµç¨‹
