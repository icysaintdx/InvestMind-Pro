# InvestMind Pro - 核心逻辑与算法文档（第1部分）

> **主题**: 新闻过滤、情绪分析、评分算法  
> **创建日期**: 2025-12-05

---

## 一、新闻过滤与评分算法

### 1.1 基础规则过滤器

**文件位置**: `backend/dataflows/news/news_filter.py`

#### 核心算法：相关性评分计算

```python
def calculate_relevance_score(title: str, content: str) -> float:
    """
    计算新闻相关性评分 (0-100分)
    
    评分规则：
    1. 标题包含公司名称: +50分
    2. 内容包含公司名称: +25分
    3. 标题包含股票代码: +40分
    4. 内容包含股票代码: +20分
    5. 强相关关键词(标题): +30分/个
    6. 强相关关键词(内容): +15分/个
    7. 相关关键词(标题): +15分/个
    8. 相关关键词(内容): +8分/个
    9. 排除关键词(标题): -40分/个
    10. 排除关键词(内容): -20分/个
    11. 标题无公司信息但含排除词: -30分
    """
```

#### 关键词配置

**排除关键词**（降低相关性）：
```python
exclude_keywords = [
    'etf', '指数基金', '基金', '指数', 'index', 'fund',
    '权重股', '成分股', '板块', '概念股', '主题基金',
    '跟踪指数', '被动投资', '指数投资', '基金持仓'
]
```

**包含关键词**（提高相关性）：
```python
include_keywords = [
    '业绩', '财报', '公告', '重组', '并购', '分红', '派息',
    '高管', '董事', '股东', '增持', '减持', '回购',
    '年报', '季报', '半年报', '业绩预告', '业绩快报',
    '股东大会', '董事会', '监事会', '重大合同',
    '投资', '收购', '出售', '转让', '合作', '协议'
]
```

**强相关关键词**（大幅提高相关性）：
```python
strong_keywords = [
    '停牌', '复牌', '涨停', '跌停', '限售解禁',
    '股权激励', '员工持股', '定增', '配股', '送股',
    '资产重组', '借壳上市', '退市', '摘帽', 'ST'
]
```

#### 过滤阈值
- **最低评分阈值**: 30分
- **高相关新闻**: ≥60分
- **中等相关**: 30-60分
- **低相关（过滤）**: <30分

---

### 1.2 增强过滤器（多策略融合）

**文件位置**: `backend/dataflows/news/enhanced_news_filter.py`

#### 核心算法：综合评分计算

```python
def calculate_enhanced_relevance_score(title: str, content: str) -> Dict[str, float]:
    """
    综合评分 = 规则评分 × 40% + 语义评分 × 35% + 分类评分 × 25%
    
    返回：
    {
        'rule_score': 基础规则评分,
        'semantic_score': 语义相似度评分,
        'classification_score': 本地模型分类评分,
        'final_score': 综合评分
    }
    """
```

#### 权重配置

```python
weights = {
    'rule': 0.4,           # 规则过滤权重40%
    'semantic': 0.35,      # 语义相似度权重35%
    'classification': 0.25  # 分类模型权重25%
}
```

#### 语义相似度计算

**使用模型**: `paraphrase-multilingual-MiniLM-L12-v2`

**计算步骤**：
1. 预计算公司相关文本的embedding
2. 计算新闻文本的embedding
3. 使用余弦相似度计算相似性
4. 取最高相似度转换为0-100评分

```python
similarity = np.dot(text_embedding, company_embedding) / (
    np.linalg.norm(text_embedding) * np.linalg.norm(company_embedding)
)
semantic_score = max(0, min(100, similarity * 100))
```

#### 本地分类模型

**使用模型**: `uer/roberta-base-finetuned-chinanews-chinese`

**分类逻辑**：
1. 构建上下文文本："关于{公司名}({股票代码})的新闻: {新闻内容}"
2. 使用RoBERTa模型进行序列分类
3. 使用softmax获取相关性概率
4. 转换为0-100评分

---

## 二、情绪分析算法

### 2.1 基于词典的情绪分析

**文件位置**: `backend/dataflows/news/improved_sentiment_analysis.py`

#### 核心算法：情绪分数计算

```python
def analyze_text_sentiment(text: str) -> float:
    """
    情绪分数 = (正面得分 - 负面得分) / (正面得分 + 负面得分)
    
    返回值范围: -1.0 (极度消极) 到 1.0 (极度积极)
    """
```

#### 情绪词典

**正面词汇**（36个）：
```python
positive_words = [
    '上涨', '增长', '利好', '看好', '买入', '推荐', '强势', '突破', '创新高',
    '盈利', '增收', '扩张', '领先', '优势', '机会', '积极', '乐观', '提升',
    '改善', '回暖', '复苏', '繁荣', '稳定', '增强', '超预期', '超额', '优质',
    '创新', '突破', '领涨', '大涨', '飙升', '暴涨', '涨停', '涨幅', '涨势'
]
```

**负面词汇**（38个）：
```python
negative_words = [
    '下跌', '下降', '利空', '看空', '卖出', '风险', '跌破', '创新低', '亏损',
    '下滑', '萎缩', '困难', '压力', '危机', '警告', '担忧', '悲观', '下行',
    '恶化', '衰退', '疲软', '低迷', '减少', '缩水', '暴跌', '跌停', '跌幅',
    '崩盘', '暴跌', '大跌', '重挫', '挫败', '失败', '问题', '隐患', '风波'
]
```

#### 强度调节机制

**强度词及其倍数**：
```python
intensity_words = {
    '大幅': 1.5,
    '显著': 1.3,
    '明显': 1.2,
    '持续': 1.2,
    '快速': 1.3,
    '急剧': 1.5,
    '暴': 2.0,
    '猛': 1.8,
    '强劲': 1.5,
    '稳健': 1.2
}
```

**否定词处理**：
```python
negation_words = ['不', '没', '无', '非', '未', '否', '别', '莫']
# 检测前5个字符内是否有否定词，如有则反转情绪
```

#### 情绪等级划分

```python
if avg_score > 0.3:    label = '积极'
elif avg_score > 0.1:  label = '偏积极'
elif avg_score < -0.3: label = '消极'
elif avg_score < -0.1: label = '偏消极'
else:                  label = '中性'
```

#### 置信度计算

```python
def _calculate_confidence(scores: List[float], news_count: int) -> float:
    """
    置信度 = 数量置信度 × 60% + 一致性置信度 × 40%
    
    数量置信度 = min(新闻数量 / 10, 1.0)
    一致性置信度 = 1.0 - min(方差, 1.0)
    """
    count_confidence = min(news_count / 10.0, 1.0)
    variance = sum((s - avg_score) ** 2 for s in scores) / len(scores)
    consistency_confidence = 1.0 - min(variance, 1.0)
    
    return count_confidence * 0.6 + consistency_confidence * 0.4
```

---

### 2.2 综合情绪分析

**文件位置**: `backend/dataflows/news/chinese_finance_utils.py`

#### 多源情绪加权算法

```python
def _calculate_overall_sentiment(
    news_sentiment: Dict,
    forum_sentiment: Dict,
    media_sentiment: Dict
) -> Dict:
    """
    综合情绪 = (新闻情绪 × 新闻置信度 + 
                论坛情绪 × 论坛置信度 + 
                媒体情绪 × 媒体置信度) / 总置信度
    """
    weighted_sentiment = (
        news_sentiment['sentiment_score'] * news_sentiment['confidence'] +
        forum_sentiment['sentiment_score'] * forum_sentiment['confidence'] +
        media_sentiment['sentiment_score'] * media_sentiment['confidence']
    ) / total_weight
    
    # 确定情绪等级
    if weighted_sentiment > 0.3:    level = 'very_positive'
    elif weighted_sentiment > 0.1:  level = 'positive'
    elif weighted_sentiment > -0.1: level = 'neutral'
    elif weighted_sentiment > -0.3: level = 'negative'
    else:                           level = 'very_negative'
```

---

## 三、基本面评分系统

### 3.1 ROE评分

**文件位置**: `backend/dataflows/stock/optimized_china_data.py`

```python
def _calculate_fundamental_score(metrics: dict) -> float:
    """
    ROE评分规则：
    - ROE > 15%: +1.5分
    - ROE > 10%: +1.0分
    - ROE > 5%:  +0.5分
    - 其他: 0分
    
    基础分: 5.0分
    最高分: 10.0分
    """
    score = 5.0
    roe = float(metrics.get("roe", "0").replace("%", ""))
    
    if roe > 15:
        score += 1.5
    elif roe > 10:
        score += 1.0
    elif roe > 5:
        score += 0.5
    
    return min(score, 10.0)
```

### 3.2 估值评分

```python
def _calculate_valuation_score(metrics: dict) -> float:
    """
    PE评分规则：
    - PE < 15:  +2.0分
    - PE < 25:  +1.0分
    - PE > 50:  -1.0分
    
    PB评分规则：
    - PB < 1.5: +1.0分
    - PB < 3:   +0.5分
    - PB > 5:   -0.5分
    
    基础分: 5.0分
    范围: [1.0, 10.0]
    """
```

### 3.3 成长性评分

```python
def _calculate_growth_score(stock_info: dict) -> float:
    """
    行业调整规则：
    - 科技/软件/互联网: +1.0分
    - 银行/保险: -0.5分
    - 其他: 0分
    
    基础分: 6.0分
    范围: [1.0, 10.0]
    """
```

---

## 📌 相关文档

- [核心逻辑与算法-第2部分](./项目核心逻辑与算法-第2部分-辩论与风控.md) - 辩论机制与风险管理
- [核心逻辑与算法-第3部分](./项目核心逻辑与算法-第3部分-交易与验证.md) - 交易决策与闭环验证
- [智能体提示词完整文档](./智能体提示词完整文档-第1部分.md) - 智能体提示词
