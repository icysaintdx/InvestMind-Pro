# 数据库集成实施计划

## ✅ 已完成

1. **数据库模型和连接** - 完成
2. **数据库 API** - 完成
3. **初始化脚本** - 完成（已修复）

---

## 📋 待实施任务

### 任务1：集成到分析流程 ⏳

**目标**：在后端分析代码中调用数据库 API，实时保存分析进度

**需要修改的文件**：
- `backend/api/agents_api.py` - 智能体分析 API
- 或创建新的辅助函数

**实现内容**：
```python
# 在每个智能体完成时调用
from backend.database.database import get_db_context
from backend.database.services import AgentResultService, SessionService

def save_agent_result_to_db(session_id, agent_id, result):
    with get_db_context() as db:
        AgentResultService.create_or_update_result(
            db=db,
            session_id=session_id,
            agent_id=agent_id,
            agent_name=agent_name,
            status="completed",
            output=result['output'],
            tokens=result['tokens']
        )
        
        # 更新会话进度
        completed_count = len(AgentResultService.get_completed_agents(db, session_id))
        progress = int(completed_count / 21 * 100)
        
        SessionService.update_session_status(
            db=db,
            session_id=session_id,
            status="running",
            progress=progress
        )
```

---

### 任务2：前端更新 ⏳

**目标**：前端使用新的数据库 API 端点

**需要修改的文件**：
- `alpha-council-vue/src/views/AnalysisView.vue`

**实现内容**：
```javascript
// 将 API 端点从 /api/analysis/session/ 改为 /api/analysis/db/session/

// 创建会话
const response = await fetch('http://localhost:8000/api/analysis/db/session/create', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({
    stock_code: stockCode.value,
    stock_name: stockData.value?.name
  })
})

// 查询状态
const status = await fetch(
  `http://localhost:8000/api/analysis/db/session/${sessionId}/status`
).then(r => r.json())

// 获取智能体结果
const result = await fetch(
  `http://localhost:8000/api/analysis/db/session/${sessionId}/agent/${agentId}`
).then(r => r.json())
```

---

### 任务3：历史记录页面 ⏳

**目标**：创建前端页面展示历史记录

**需要创建的文件**：
- `alpha-council-vue/src/views/HistoryView.vue` - 历史记录页面
- `alpha-council-vue/src/components/SessionHistoryCard.vue` - 会话历史卡片

**页面功能**：
1. **最近分析** - 显示最近的分析记录
2. **股票搜索** - 搜索特定股票的历史
3. **详情查看** - 查看完整的分析详情
4. **统计图表** - 显示分析统计

**页面布局**：
```
┌─────────────────────────────────────┐
│  📊 分析历史                         │
├─────────────────────────────────────┤
│  🔍 搜索: [股票代码]  [日期范围]    │
├─────────────────────────────────────┤
│  📈 统计概览                         │
│  总分析: 50次  成功: 45  失败: 5    │
├─────────────────────────────────────┤
│  📋 最近分析                         │
│  ┌──────────────────────────────┐  │
│  │ 600000 浦发银行               │  │
│  │ 2025-12-08 06:30             │  │
│  │ 状态: 已完成  进度: 100%      │  │
│  │ [查看详情] [重新分析]         │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │ 000001 平安银行               │  │
│  │ 2025-12-07 15:20             │  │
│  │ 状态: 已完成  进度: 100%      │  │
│  │ [查看详情] [重新分析]         │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
```

---

## 🎯 实施优先级

### 高优先级
1. ✅ 修复数据库连接错误
2. ⏳ 前端更新（使用数据库 API）
3. ⏳ 集成到分析流程

### 中优先级
4. ⏳ 历史记录页面

### 低优先级
5. ⏳ 统计图表
6. ⏳ 数据导出功能

---

## 📝 实施步骤

### 步骤1：测试数据库（现在）
```bash
cd d:\InvestMindPro\backend
python init_database.py
```

### 步骤2：前端更新（10分钟）
- 修改 API 端点
- 测试基本功能

### 步骤3：分析流程集成（15分钟）
- 创建辅助函数
- 在分析代码中调用

### 步骤4：历史记录页面（30分钟）
- 创建 Vue 组件
- 实现查询和展示

---

## ⚠️ 注意事项

1. **API 兼容性**
   - 新旧 API 可以共存
   - 逐步迁移到数据库版本

2. **数据迁移**
   - 旧的内存数据不会自动迁移
   - 需要重新分析才会保存到数据库

3. **性能**
   - SQLite 适合开发
   - 生产环境建议 PostgreSQL

---

## 🚀 开始实施

现在开始按顺序实施：
1. ✅ 修复数据库连接 - 已完成
2. ⏳ 前端更新 - 进行中
3. ⏳ 分析流程集成
4. ⏳ 历史记录页面

准备好了吗？让我们开始！
