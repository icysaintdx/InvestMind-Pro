# å½»åº•ä¿®å¤åå°è¿è¡Œé—®é¢˜

**é—®é¢˜æ—¥æœŸ**: 2025-12-10  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ ç´§æ€¥  

---

## ğŸ› çœŸæ­£çš„é—®é¢˜

### é—®é¢˜1: è½®è¯¢ä¹Ÿè¢«æš‚åœ

```javascript
// setInterval åœ¨é¡µé¢ä¸å¯è§æ—¶ä¼šè¢«æš‚åœ
pollingInterval.value = setInterval(() => {
  pollBackendStatus()  // é¡µé¢ä¸å¯è§æ—¶ä¸æ‰§è¡Œï¼
}, 5000)
```

**è¯æ®**ï¼š
- ç”¨æˆ·åˆ‡èµ°åï¼Œåç«¯ç»§ç»­è¿è¡Œ
- ä½†å‰ç«¯æ—¥å¿—æ˜¾ç¤ºæ²¡æœ‰è½®è¯¢è¯·æ±‚
- åˆ‡å›æ¥åæ‰ç»§ç»­è½®è¯¢

### é—®é¢˜2: localStorage çŠ¶æ€æ±¡æŸ“

```javascript
// ä¿å­˜äº†é”™è¯¯çš„çŠ¶æ€
localStorage.setItem('analysis_state', JSON.stringify({
  isAnalyzing: true,  // ä¸€ç›´æ˜¯ true
  analysisElapsedTime: 1000000  // é”™è¯¯çš„æ—¶é—´
}))

// åˆ·æ–°ååŠ è½½è¿™ä¸ªé”™è¯¯çŠ¶æ€
// å¯¼è‡´æ— æ³•é‡æ–°å¼€å§‹
```

### é—®é¢˜3: æ²¡æœ‰å¼ºåˆ¶æ¸…ç†æœºåˆ¶

- ç”¨æˆ·æ— æ³•æ‰‹åŠ¨åœæ­¢åˆ†æ
- æ— æ³•æ¸…é™¤é”™è¯¯çŠ¶æ€
- é¡µé¢ä¸€ç›´å¡ä½

---

## âœ… å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä½¿ç”¨ requestAnimationFrame æ›¿ä»£ setInterval

```javascript
// âŒ é”™è¯¯ï¼šsetInterval ä¼šè¢«æš‚åœ
pollingInterval.value = setInterval(() => {
  pollBackendStatus()
}, 5000)

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ requestAnimationFrame + æ—¶é—´æ£€æŸ¥
let lastPollTime = 0
const POLL_INTERVAL = 5000

const poll = () => {
  const now = Date.now()
  
  if (now - lastPollTime >= POLL_INTERVAL) {
    pollBackendStatus()
    lastPollTime = now
  }
  
  if (isAnalyzing.value) {
    requestAnimationFrame(poll)  // æŒç»­è½®è¯¢ï¼Œä¸ä¼šè¢«æš‚åœ
  }
}

// å¯åŠ¨è½®è¯¢
requestAnimationFrame(poll)
```

### æ–¹æ¡ˆ2: æ·»åŠ å¼ºåˆ¶åœæ­¢æŒ‰é’®

```vue
<template>
  <button 
    v-if="isAnalyzing" 
    @click="forceStop"
    class="force-stop-btn"
  >
    â¹ï¸ å¼ºåˆ¶åœæ­¢
  </button>
</template>

<script>
const forceStop = () => {
  // åœæ­¢æ‰€æœ‰è®¡æ—¶å’Œè½®è¯¢
  stopAnalysis()
  
  // æ¸…é™¤ localStorage
  localStorage.removeItem('analysis_state')
  localStorage.removeItem('current_session_id')
  
  // é‡ç½®æ‰€æœ‰çŠ¶æ€
  isAnalyzing.value = false
  analysisElapsedTime.value = 0
  agentStatus.value = {}
  agentOutputs.value = {}
  
  // é€šçŸ¥åç«¯å–æ¶ˆä¼šè¯
  if (currentSessionId.value) {
    axios.post(`/api/session/${currentSessionId.value}/cancel`)
  }
  
  alert('âœ… å·²å¼ºåˆ¶åœæ­¢åˆ†æ')
}
</script>
```

### æ–¹æ¡ˆ3: é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¹¶æ¸…ç†é”™è¯¯çŠ¶æ€

```javascript
onMounted(async () => {
  // æ£€æŸ¥ localStorage ä¸­çš„çŠ¶æ€
  const savedState = localStorage.getItem('analysis_state')
  
  if (savedState) {
    const state = JSON.parse(savedState)
    
    // å¦‚æœçŠ¶æ€å¼‚å¸¸ï¼ˆæ—¶é—´è¿‡é•¿ï¼‰ï¼Œè‡ªåŠ¨æ¸…ç†
    if (state.analysisElapsedTime > 600) {  // è¶…è¿‡10åˆ†é’Ÿ
      console.log('[å¯åŠ¨] æ£€æµ‹åˆ°å¼‚å¸¸çŠ¶æ€ï¼Œè‡ªåŠ¨æ¸…ç†')
      localStorage.removeItem('analysis_state')
      localStorage.removeItem('current_session_id')
      return
    }
    
    // å¦‚æœæœ‰ä¼šè¯IDï¼Œæ£€æŸ¥åç«¯çŠ¶æ€
    const sessionId = localStorage.getItem('current_session_id')
    if (sessionId) {
      try {
        const response = await axios.get(`/api/session/${sessionId}/status`)
        const status = response.data
        
        if (status.status === 'completed') {
          // åç«¯å·²å®Œæˆï¼Œæ¸…é™¤çŠ¶æ€
          localStorage.removeItem('analysis_state')
          localStorage.removeItem('current_session_id')
          alert('ä¸Šæ¬¡åˆ†æå·²å®Œæˆï¼Œå·²æ¸…é™¤çŠ¶æ€')
        } else if (status.status === 'error') {
          // åç«¯å‡ºé”™ï¼Œæ¸…é™¤çŠ¶æ€
          localStorage.removeItem('analysis_state')
          localStorage.removeItem('current_session_id')
          alert('ä¸Šæ¬¡åˆ†æå‡ºé”™ï¼Œå·²æ¸…é™¤çŠ¶æ€')
        }
      } catch (error) {
        // åç«¯æ— æ­¤ä¼šè¯ï¼Œæ¸…é™¤çŠ¶æ€
        localStorage.removeItem('analysis_state')
        localStorage.removeItem('current_session_id')
      }
    }
  }
})
```

### æ–¹æ¡ˆ4: ä½¿ç”¨ Broadcast Channel API è·¨æ ‡ç­¾é¡µåŒæ­¥

```javascript
// åˆ›å»ºå¹¿æ’­é¢‘é“
const channel = new BroadcastChannel('analysis_channel')

// ç›‘å¬å…¶ä»–æ ‡ç­¾é¡µçš„æ¶ˆæ¯
channel.onmessage = (event) => {
  if (event.data.type === 'status_update') {
    // æ›´æ–°çŠ¶æ€
    analysisElapsedTime.value = event.data.elapsed_time
    agentStatus.value = event.data.agent_status
  }
}

// è½®è¯¢æ—¶å¹¿æ’­çŠ¶æ€
const pollBackendStatus = async () => {
  const status = await getBackendStatus()
  
  // å¹¿æ’­ç»™å…¶ä»–æ ‡ç­¾é¡µ
  channel.postMessage({
    type: 'status_update',
    elapsed_time: status.elapsed_time,
    agent_status: status.agents
  })
}
```

### æ–¹æ¡ˆ5: ä½¿ç”¨ Service Worker ä¿è¯åå°è½®è¯¢

```javascript
// service-worker.js
let pollingInterval = null

self.addEventListener('message', (event) => {
  if (event.data.action === 'start_polling') {
    const sessionId = event.data.sessionId
    
    pollingInterval = setInterval(async () => {
      const response = await fetch(`/api/session/${sessionId}/status`)
      const status = await response.json()
      
      // å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯
      const clients = await self.clients.matchAll()
      clients.forEach(client => {
        client.postMessage({
          type: 'status_update',
          data: status
        })
      })
      
      // å¦‚æœå®Œæˆï¼Œåœæ­¢è½®è¯¢
      if (status.status === 'completed') {
        clearInterval(pollingInterval)
      }
    }, 5000)
  }
  
  if (event.data.action === 'stop_polling') {
    if (pollingInterval) {
      clearInterval(pollingInterval)
      pollingInterval = null
    }
  }
})
```

---

## ğŸ”§ ç«‹å³å®æ–½çš„ä¿®å¤

### ä¿®å¤1: æ·»åŠ å¼ºåˆ¶åœæ­¢æŒ‰é’®ï¼ˆæœ€å¿«ï¼‰

è¿™ä¸ªæœ€ç®€å•ï¼Œç«‹å³å¯ä»¥è§£å†³ç§»åŠ¨ç«¯å¡ä½çš„é—®é¢˜ã€‚

### ä¿®å¤2: é¡µé¢åŠ è½½æ—¶æ¸…ç†å¼‚å¸¸çŠ¶æ€

é˜²æ­¢åŠ è½½é”™è¯¯çŠ¶æ€ã€‚

### ä¿®å¤3: ä½¿ç”¨ requestAnimationFrame

æ›¿ä»£ setIntervalï¼Œç¡®ä¿è½®è¯¢ä¸è¢«æš‚åœã€‚

---

## ğŸ“ å®æ–½æ­¥éª¤

1. **ç«‹å³æ·»åŠ å¼ºåˆ¶åœæ­¢æŒ‰é’®**
2. **æ·»åŠ é¡µé¢åŠ è½½æ—¶çš„çŠ¶æ€æ£€æŸ¥**
3. **æµ‹è¯•ç§»åŠ¨ç«¯æ˜¯å¦å¯ä»¥æ¸…é™¤çŠ¶æ€**
4. **å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œä½¿ç”¨ Service Worker**

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•1: å¼ºåˆ¶åœæ­¢
```
1. å¯åŠ¨åˆ†æ
2. ç‚¹å‡»"å¼ºåˆ¶åœæ­¢"
3. ç¡®è®¤çŠ¶æ€å·²æ¸…é™¤
4. å¯ä»¥é‡æ–°å¼€å§‹
```

### æµ‹è¯•2: å¼‚å¸¸çŠ¶æ€æ¸…ç†
```
1. æ¨¡æ‹Ÿå¼‚å¸¸çŠ¶æ€ï¼ˆä¿®æ”¹ localStorageï¼‰
2. åˆ·æ–°é¡µé¢
3. ç¡®è®¤è‡ªåŠ¨æ¸…ç†
4. å¯ä»¥æ­£å¸¸ä½¿ç”¨
```

### æµ‹è¯•3: ç§»åŠ¨ç«¯æ¢å¤
```
1. ç§»åŠ¨ç«¯å¯åŠ¨åˆ†æ
2. åˆ‡å‡ºåº”ç”¨
3. ç­‰å¾…å®Œæˆ
4. åˆ‡å›åº”ç”¨
5. ç‚¹å‡»"å¼ºåˆ¶åœæ­¢"
6. é‡æ–°å¼€å§‹åˆ†æ
```

---

**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡æ—¶é—´**: 1å°æ—¶  
**ç«‹å³å¼€å§‹ï¼**
