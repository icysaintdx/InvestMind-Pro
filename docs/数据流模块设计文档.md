# 数据流模块设计文档

## 一、模块概述

数据流模块是InvestMind Pro的核心数据采集与分析模块，负责：
- 实时采集股票新闻、公告、舆情数据
- 监控风险信号和利好信息
- 进行情绪分析和风险评估
- 按紧急程度分类并推送通知

## 二、接口集成状态

### 2.1 总体统计

| 数据源 | 总接口数 | 已集成 | 部分集成 | 未集成 | 覆盖率 |
|--------|----------|--------|----------|--------|--------|
| Tushare | 40 | 28 | 2 | 10 | 75% |
| AKShare | 17 | 13 | 3 | 1 | 94% |
| **合计** | **57** | **41** | **5** | **11** | **81%** |

### 2.2 Tushare接口详情 (40个)

#### 已集成 (28个)
| 接口名称 | 功能说明 | 实现方法 |
|----------|----------|----------|
| realtime_quote | 实时盘口快照 | `_get_realtime_quote()` |
| suspend_d | 每日停复牌信息 | `_get_suspend_info()` |
| income | 利润表 | `_get_financial_data()` |
| balancesheet | 资产负债表 | `_get_financial_data()` |
| cashflow | 现金流量表 | `_get_financial_data()` |
| fina_audit | 财务审计意见 | `_get_audit_opinion()` |
| forecast | 业绩预告 | `_get_performance_forecast()` |
| express | 业绩快报 | `_get_performance_forecast()` |
| dividend | 分红送股 | `_get_dividend_data()` |
| share_float | 限售股解禁 | `_get_restricted_release()` |
| pledge_stat | 股权质押统计 | `_get_pledge_data()` |
| stk_holdertrade | 股东增减持 | `_get_holder_trade()` |
| top_list | 龙虎榜每日明细 | `_get_dragon_tiger()` |
| top_inst | 龙虎榜机构明细 | `_get_top_inst()` |
| limit_list_d | 涨跌停榜单 | `_get_limit_list()` |
| margin | 融资融券汇总 | `_get_margin_data()` |
| stock_company | 上市公司基本信息 | `_get_company_info()` |
| stk_managers | 上市公司管理层 | `_get_managers()` |
| stk_rewards | 管理层薪酬和持股 | `_get_manager_rewards()` |
| fina_mainbz | 主营业务构成 | `_get_main_business()` |
| hsgt_top10 | 沪深股通十大成交股 | `_get_hsgt_holding()` |

#### 部分集成 (2个)
| 接口名称 | 功能说明 | 状态说明 |
|----------|----------|----------|
| realtime_tick | 实时成交数据 | 使用stk_mins替代 |
| stock_st | ST股票列表 | 使用AKShare替代 |

#### 未集成 (10个)
| 接口名称 | 功能说明 | 优先级 | 建议 |
|----------|----------|--------|------|
| realtime_list | 实时涨跌幅排名 | 高 | 市场监控必需 |
| pledge_detail | 股权质押明细 | 中 | 风险分析增强 |
| margin_detail | 融资融券明细 | 中 | 杠杆风险监控 |
| ggt_top10 | 港股通十大成交 | 中 | 资金流向分析 |
| hk_hold | 沪深港通持股明细 | 高 | 北向资金监控 |
| moneyflow_hsgt | 沪深港通资金流向 | 高 | 市场情绪指标 |
| limit_list_ths | 涨跌停榜单(同花顺) | 低 | 已有limit_list_d |

### 2.3 AKShare接口详情 (17个)

#### 已集成 (13个)
| 接口名称 | 功能说明 | 实现方法 |
|----------|----------|----------|
| stock_announcement | 全市场公司公告 | `_get_announcements_akshare()` |
| stock_news_em | 东方财富个股新闻 | `_get_news_em()` |
| stock_st_info | ST股票相关 | `_get_stock_st_info_ak()` |
| stock_suspension_info | 停复牌信息 | `_get_suspension_info_ak()` |
| stock_equity_pledge_detail | 股权质押数据 | `_get_pledge_detail_ak()` |
| stock_restricted_shares | 限售股解禁 | `_get_restricted_shares_ak()` |
| stock_dragon_tiger_list | 龙虎榜风险信号 | `_get_dragon_tiger_ak()` |
| stock_zh_a_st_em | 风险警示板 | `_check_st_status()` |
| stock_performance_forecast | 业绩预告 | `_get_performance_forecast_ak()` |
| stock_audit_opinion | 财报审计意见 | `_get_audit_opinion_ak()` |
| stock_margin_trading | 融资融券交易明细 | `_get_margin_trading_ak()` |
| stock_block_trade | 大宗交易数据 | `_get_block_trade()` |
| stock_yjyg_em | 业绩预告数据 | `_get_performance_forecast_ak()` |

#### 部分集成 (3个)
| 接口名称 | 功能说明 | 状态说明 |
|----------|----------|----------|
| stock_news_sina | 新浪财经个股新闻 | 使用stock_news_main_cx替代 |
| stock_market_news_cninfo | 巨潮资讯快讯 | 使用news_economic_baidu替代 |
| stock_shareholder_change | 股东增减持 | 使用stock_zh_a_gdhs(股东户数)替代 |

#### 未集成 (1个)
| 接口名称 | 功能说明 | 优先级 | 建议 |
|----------|----------|--------|------|
| stock_industry_policy | 行业政策动态 | 中 | 当前为stub实现 |

## 三、数据分类体系

### 3.1 数据类别

```
DataCategory
├── NEWS (新闻舆情)
│   ├── 公司公告
│   ├── 个股新闻
│   ├── 市场快讯
│   └── 行业政策
│
├── RISK (风险预警)
│   ├── ST风险
│   ├── 停牌风险
│   ├── 审计风险
│   ├── 质押风险
│   ├── 解禁风险
│   ├── 减持风险
│   └── 业绩风险
│
├── POSITIVE (利好信号)
│   ├── 股东增持
│   ├── 分红送股
│   ├── 业绩预增
│   ├── 北向资金流入
│   └── 机构买入
│
├── FUNDAMENTAL (基本面数据)
│   ├── 财务报表
│   ├── 主营业务
│   └── 公司治理
│
├── MARKET (市场数据)
│   ├── 实时行情
│   ├── 涨跌停
│   └── 龙虎榜
│
└── CAPITAL_FLOW (资金流向)
    ├── 融资融券
    ├── 大宗交易
    └── 北向资金
```

### 3.2 风险等级

| 等级 | 标识 | 说明 | 触发条件 |
|------|------|------|----------|
| CRITICAL | 严重风险 | 需立即关注 | ST/*ST、非标审计、质押>50% |
| HIGH | 高风险 | 需重点关注 | 大规模解禁、大股东减持、业绩预亏 |
| MEDIUM | 中等风险 | 需持续关注 | 炸板、融资余额过高、机构卖出 |
| LOW | 低风险 | 一般关注 | 小规模变动 |
| NONE | 无风险 | 正常状态 | 无风险信号 |

### 3.3 情绪等级

| 等级 | 标识 | 分数范围 | 说明 |
|------|------|----------|------|
| VERY_POSITIVE | 非常正面 | 70-100 | 多重利好 |
| POSITIVE | 正面 | 55-69 | 偏正面 |
| NEUTRAL | 中性 | 45-54 | 无明显倾向 |
| NEGATIVE | 负面 | 30-44 | 偏负面 |
| VERY_NEGATIVE | 非常负面 | 0-29 | 多重利空 |

### 3.4 紧急程度

| 等级 | 标识 | 说明 | 响应时间 |
|------|------|------|----------|
| IMMEDIATE | 立即处理 | 重大风险事件 | 即时 |
| HIGH | 高优先级 | 重要信息 | 1小时内 |
| MEDIUM | 中等优先级 | 一般信息 | 当日 |
| LOW | 低优先级 | 常规信息 | 次日 |
| INFO | 仅供参考 | 背景信息 | 无时限 |

## 四、模块架构

### 4.1 核心组件

```
backend/dataflows/
├── comprehensive_stock_data.py    # 综合数据服务(主入口)
├── enhanced_data_service.py       # 增强数据服务(分类评级)
├── interface.py                   # 统一数据接口
├── data_source_manager.py         # 多源数据管理
│
├── news/                          # 新闻模块
│   ├── multi_source_news_aggregator.py  # 多源新闻聚合
│   ├── sentiment_engine.py              # 情绪分析引擎
│   ├── realtime_news.py                 # 实时新闻
│   └── akshare_news_api.py              # AKShare新闻接口
│
├── risk/                          # 风险模块
│   ├── risk_analyzer.py           # 综合风险分析
│   ├── suspend_monitor.py         # 停复牌监控
│   ├── st_monitor.py              # ST股票监控
│   ├── realtime_monitor.py        # 实时数据监控
│   └── akshare_risk.py            # AKShare风险接口
│
├── providers/                     # 数据提供者
│   └── china/
│       ├── akshare.py             # AKShare适配器
│       └── tushare.py             # Tushare适配器
│
└── cache/                         # 缓存层
    ├── integrated_cache.py        # 集成缓存
    └── adaptive_cache.py          # 自适应缓存
```

### 4.2 API接口

```
/api/dataflow/
├── GET  /monitored-stocks         # 获取监控股票列表
├── POST /monitor/add              # 添加监控股票
├── POST /monitor/remove           # 移除监控股票
├── POST /monitor/update           # 立即更新数据
│
├── GET  /sources/status           # 获取数据源状态
├── POST /sources/check            # 检测数据源连接
│
├── GET  /news                     # 获取新闻列表
├── GET  /stock/news/{ts_code}     # 获取股票新闻
├── GET  /stock/sentiment/{ts_code} # 获取情绪分析
├── GET  /stock/risk/{ts_code}     # 获取风险分析
├── GET  /stock/comprehensive/{ts_code} # 获取综合数据
├── GET  /stock/realtime/{ts_code} # 获取实时数据
└── GET  /stock/suspend/{ts_code}  # 获取停复牌状态
```

### 4.3 数据流程

```
数据采集 → 数据清洗 → 分类标注 → 情绪分析 → 风险评估 → 紧急度判定 → 推送通知
    ↓           ↓           ↓           ↓           ↓           ↓           ↓
 Tushare    去重/格式化   NEWS/RISK   正面/负面   HIGH/LOW   IMMEDIATE   前端展示
 AKShare                 /POSITIVE    /中性                  /HIGH/LOW
```

## 五、当前问题与不足

### 5.1 接口层面

| 问题 | 影响 | 优先级 | 解决方案 |
|------|------|--------|----------|
| 缺少realtime_list | 无法监控全市场涨跌幅排名 | 高 | 新增接口实现 |
| 缺少moneyflow_hsgt | 无法监控北向资金流向 | 高 | 新增接口实现 |
| 缺少hk_hold | 无法查看港股通持股明细 | 高 | 新增接口实现 |
| stock_shareholder_change使用替代接口 | 股东增减持数据不准确 | 中 | 寻找正确接口 |
| stock_industry_policy为stub | 无行业政策数据 | 中 | 实现真实接口 |

### 5.2 功能层面

| 问题 | 影响 | 优先级 | 解决方案 |
|------|------|--------|----------|
| 新闻情绪分析依赖关键词 | 准确度有限 | 中 | 引入LLM分析 |
| 风险评分权重固定 | 不够灵活 | 低 | 支持自定义权重 |
| 缺少历史数据对比 | 无法分析趋势 | 中 | 增加时序分析 |
| 缺少预警推送机制 | 用户无法及时获知 | 高 | 实现WebSocket推送 |

### 5.3 性能层面

| 问题 | 影响 | 优先级 | 解决方案 |
|------|------|--------|----------|
| 综合数据获取较慢 | 用户体验差 | 高 | 并行请求+缓存优化 |
| 缺少请求限流 | 可能触发API限制 | 中 | 实现令牌桶限流 |
| 缓存策略单一 | 数据时效性不一致 | 低 | 分类缓存策略 |

## 六、优化计划

### 6.1 短期计划 (1-2周)

1. **补充缺失接口**
   - 实现realtime_list接口
   - 实现moneyflow_hsgt接口
   - 实现hk_hold接口
   - 修复stock_shareholder_change

2. **优化数据获取**
   - 并行请求多个数据源
   - 优化缓存策略
   - 增加请求重试机制

3. **完善前端展示**
   - 增加北向资金流向图表
   - 增加风险预警弹窗
   - 优化数据加载状态

### 6.2 中期计划 (1个月)

1. **增强分析能力**
   - 引入LLM进行新闻情绪分析
   - 增加历史数据趋势分析
   - 实现自定义风险权重

2. **实现推送机制**
   - WebSocket实时推送
   - 邮件/微信通知
   - 自定义预警规则

3. **性能优化**
   - 实现请求限流
   - 优化数据库查询
   - 增加数据预加载

### 6.3 长期计划 (3个月)

1. **智能化升级**
   - AI驱动的风险预测
   - 自动生成投资建议
   - 个性化信息推荐

2. **数据源扩展**
   - 接入更多数据源
   - 支持港股/美股数据
   - 增加另类数据(舆情/卫星等)

3. **系统完善**
   - 完善监控告警
   - 增加数据质量检测
   - 支持数据导出

## 七、接口调用示例

### 7.1 获取综合数据

```python
from backend.dataflows.comprehensive_stock_data import get_comprehensive_service

service = get_comprehensive_service()
result = service.get_all_stock_data("600519.SH")

# 返回结构
{
    "ts_code": "600519.SH",
    "realtime": {...},      # 实时行情
    "st_status": {...},     # ST状态
    "suspend": {...},       # 停复牌
    "financial": {...},     # 财务数据
    "forecast": {...},      # 业绩预告
    "dividend": {...},      # 分红送股
    "pledge": {...},        # 股权质押
    "restricted": {...},    # 限售解禁
    "holder_trade": {...},  # 股东增减持
    "dragon_tiger": {...},  # 龙虎榜
    "margin": {...},        # 融资融券
    "block_trade": {...},   # 大宗交易
    "news": [...],          # 新闻列表
    "timestamp": "..."
}
```

### 7.2 数据分类评级

```python
from backend.dataflows.enhanced_data_service import get_enhanced_service

service = get_enhanced_service()
classified = service.classify_data(raw_data, "600519.SH")

# 返回结构
{
    "ts_code": "600519.SH",
    "news_items": [...],        # 新闻列表
    "risk_items": [...],        # 风险项
    "positive_items": [...],    # 利好项
    "overall_risk": "low",      # 综合风险
    "overall_sentiment": "positive",  # 综合情绪
    "urgency": "info",          # 紧急程度
    "summary": "...",           # 摘要
    "timestamp": "..."
}
```

### 7.3 风险分析

```python
from backend.dataflows.risk import analyze_stock_risk

result = analyze_stock_risk("600519.SH", sentiment_score=65)

# 返回结构
{
    "ts_code": "600519.SH",
    "risk_level": "low",
    "risk_score": 15,
    "risk_factors": {
        "suspend_risk": {...},
        "st_risk": {...},
        "sentiment_risk": {...},
        "realtime_risk": {...}
    },
    "warnings": [],
    "timestamp": "..."
}
```

## 八、配置说明

### 8.1 环境变量

```bash
# .env 文件
TUSHARE_TOKEN=your_tushare_token      # Tushare API Token
GEMINI_API_KEY=your_gemini_key        # Gemini AI (情绪分析)
DEEPSEEK_API_KEY=your_deepseek_key    # DeepSeek AI (备选)
```

### 8.2 缓存配置

```python
# 缓存时间配置 (秒)
CACHE_TTL = {
    "realtime": 60,        # 实时数据: 1分钟
    "news": 300,           # 新闻: 5分钟
    "financial": 86400,    # 财务数据: 24小时
    "risk": 600,           # 风险数据: 10分钟
}
```

## 九、总结

数据流模块已完成基础功能开发，接口覆盖率达到81%。主要优势：

1. **多源数据整合**: 整合Tushare和AKShare两大数据源
2. **完善的分类体系**: 新闻/风险/利好三大类别
3. **多维度评级**: 风险等级、情绪等级、紧急程度
4. **前端完整对接**: 数据流监控页面功能完善

待改进方向：

1. 补充缺失的高优先级接口
2. 增强情绪分析准确度
3. 实现实时推送机制
4. 优化数据获取性能

---

*文档版本: v1.0*
*更新日期: 2025-12-18*
*作者: Claude Code*
