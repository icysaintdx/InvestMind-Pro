# InvestMind Pro - æ ¸å¿ƒé€»è¾‘ä¸ç®—æ³•æ–‡æ¡£ï¼ˆç¬¬3éƒ¨åˆ†ï¼‰

> **ä¸»é¢˜**: äº¤æ˜“å†³ç­–ç®—æ³•ã€é—­ç¯éªŒè¯ä¸ç­–ç•¥ä¼˜åŒ–  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-05

---

## ä¸€ã€äº¤æ˜“å†³ç­–ç®—æ³•

### 1.1 äº¤æ˜“æ•°é‡è®¡ç®—

**æ–‡ä»¶ä½ç½®**: `backend/api/debate_api.py`, `backend/api/trading_api.py`

```python
def calculate_quantity(
    capital: float,
    position_size: float,
    current_price: float
) -> int:
    """
    è´­ä¹°æ•°é‡ = int((å¯ç”¨èµ„é‡‘ Ã— ä»“ä½æ¯”ä¾‹ / 100) / å½“å‰ä»· / 100) Ã— 100
    
    è¯´æ˜ï¼š
    - ç¡®ä¿æ˜¯100çš„æ•´æ•°å€ï¼ˆAè‚¡æœ€å°äº¤æ˜“å•ä½ï¼‰
    - å‘ä¸‹å–æ•´ï¼Œé¿å…èµ„é‡‘ä¸è¶³
    
    è®¡ç®—ç¤ºä¾‹ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å¯ç”¨èµ„é‡‘ â”‚ ä»“ä½%  â”‚ è‚¡ä»·   â”‚ è´­ä¹°æ•°é‡ â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 100,000  â”‚ 10%    â”‚ 50     â”‚ 200è‚¡    â”‚
    â”‚ 100,000  â”‚ 20%    â”‚ 100    â”‚ 200è‚¡    â”‚
    â”‚ 50,000   â”‚ 30%    â”‚ 75     â”‚ 200è‚¡    â”‚
    â”‚ 200,000  â”‚ 15%    â”‚ 60     â”‚ 500è‚¡    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    quantity = int((capital * position_size / 100) / current_price / 100) * 100
    return max(100, quantity)  # æœ€å°‘100è‚¡
```

### 1.2 äº¤æ˜“æˆæœ¬è®¡ç®—

```python
def calculate_commission(amount: float) -> float:
    """
    ä½£é‡‘ = max(5å…ƒ, äº¤æ˜“é‡‘é¢ Ã— 0.0003)
    
    è§„åˆ™ï¼š
    - ä½£é‡‘ç‡: ä¸‡åˆ†ä¹‹ä¸‰ (0.03%)
    - æœ€ä½ä½£é‡‘: 5å…ƒ
    - åŒå‘æ”¶å–ï¼ˆä¹°å…¥å’Œå–å‡ºéƒ½æ”¶ï¼‰
    
    æˆæœ¬ç¤ºä¾‹ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ äº¤æ˜“é‡‘é¢ â”‚ è®¡ç®—   â”‚ å®é™…   â”‚ è´¹ç‡     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 1,000    â”‚ 0.3    â”‚ 5      â”‚ 0.5%     â”‚
    â”‚ 10,000   â”‚ 3      â”‚ 5      â”‚ 0.05%    â”‚
    â”‚ 50,000   â”‚ 15     â”‚ 15     â”‚ 0.03%    â”‚
    â”‚ 100,000  â”‚ 30     â”‚ 30     â”‚ 0.03%    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    return max(5, amount * 0.0003)
```

### 1.3 ç›ˆäºè®¡ç®—

```python
def calculate_profit_loss(
    action: str,
    entry_price: float,
    exit_price: float,
    quantity: int,
    commission: float
) -> Tuple[float, float]:
    """
    ç›ˆäºé‡‘é¢ = (å–å‡ºä»· - ä¹°å…¥ä»·) Ã— æ•°é‡ - åŒå‘ä½£é‡‘
    æ”¶ç›Šç‡ = ç›ˆäºé‡‘é¢ / (ä¹°å…¥ä»· Ã— æ•°é‡) Ã— 100%
    
    ç¤ºä¾‹ï¼š
    ä¹°å…¥: 100å…ƒ Ã— 1000è‚¡ = 100,000å…ƒ, ä½£é‡‘30å…ƒ
    å–å‡º: 110å…ƒ Ã— 1000è‚¡ = 110,000å…ƒ, ä½£é‡‘33å…ƒ
    ç›ˆäº = (110-100) Ã— 1000 - 30 - 33 = 9,937å…ƒ
    æ”¶ç›Šç‡ = 9,937 / 100,000 Ã— 100% = 9.94%
    """
    if action == "BUY":
        # ä¹°å…¥åå–å‡º
        profit = (exit_price - entry_price) * quantity - commission * 2
    else:  # SELL
        # å–å‡ºåå›è´­
        profit = (entry_price - exit_price) * quantity - commission * 2
    
    cost_basis = entry_price * quantity
    return_rate = (profit / cost_basis * 100) if cost_basis > 0 else 0
    
    return profit, return_rate
```

---

## äºŒã€é—­ç¯éªŒè¯ç³»ç»Ÿ

### 2.1 å†³ç­–éªŒè¯ç®—æ³•

**æ–‡ä»¶ä½ç½®**: `backend/api/verification_api.py`

#### å‡†ç¡®ç‡è®¡ç®—

```python
def calculate_accuracy_rate(
    actual_price: float,
    predicted_price: float
) -> float:
    """
    å‡†ç¡®ç‡ = 1 - |å®é™…ä»·æ ¼ - é¢„æµ‹ä»·æ ¼| / é¢„æµ‹ä»·æ ¼
    
    è¯„çº§æ ‡å‡†ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å‡†ç¡®ç‡   â”‚ è¯„çº§       â”‚ è¯´æ˜     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ â‰¥ 95%    â”‚ å“è¶Š       â”‚ æé«˜ç²¾åº¦ â”‚
    â”‚ 90-95%   â”‚ ä¼˜ç§€       â”‚ é«˜ç²¾åº¦   â”‚
    â”‚ 80-90%   â”‚ è‰¯å¥½       â”‚ å¯æ¥å—   â”‚
    â”‚ 70-80%   â”‚ ä¸€èˆ¬       â”‚ éœ€æ”¹è¿›   â”‚
    â”‚ < 70%    â”‚ è¾ƒå·®       â”‚ éœ€ä¼˜åŒ–   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    ç¤ºä¾‹ï¼š
    - é¢„æµ‹100, å®é™…105: 1 - 5/100 = 95% (ä¼˜ç§€)
    - é¢„æµ‹100, å®é™…90:  1 - 10/100 = 90% (ä¼˜ç§€)
    - é¢„æµ‹100, å®é™…75:  1 - 25/100 = 75% (ä¸€èˆ¬)
    """
    accuracy = 1 - abs(actual_price - predicted_price) / predicted_price
    return max(0, min(1, accuracy))
```

#### æˆåŠŸåˆ¤å®š

```python
def is_decision_successful(
    profit_loss: float,
    accuracy_rate: float,
    confidence: float
) -> bool:
    """
    æˆåŠŸæ¡ä»¶ï¼ˆå¿…é¡»åŒæ—¶æ»¡è¶³ï¼‰ï¼š
    1. ç›ˆåˆ© (profit_loss > 0)
    2. å‡†ç¡®ç‡é«˜ (accuracy_rate > 0.8)
    
    å¯é€‰åŠ æƒæ¡ä»¶ï¼š
    3. ä¿¡å¿ƒåº¦é«˜ (confidence > 0.7)
    
    åˆ¤å®šçŸ©é˜µï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç›ˆäº   â”‚ å‡†ç¡®ç‡   â”‚ ä¿¡å¿ƒåº¦ â”‚ åˆ¤å®š   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ç›ˆåˆ©   â”‚ > 80%    â”‚ > 70%  â”‚ æˆåŠŸ   â”‚
    â”‚ ç›ˆåˆ©   â”‚ > 80%    â”‚ < 70%  â”‚ æˆåŠŸ   â”‚
    â”‚ ç›ˆåˆ©   â”‚ < 80%    â”‚ ä»»æ„   â”‚ å¤±è´¥   â”‚
    â”‚ äºæŸ   â”‚ ä»»æ„     â”‚ ä»»æ„   â”‚ å¤±è´¥   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    return profit_loss > 0 and accuracy_rate > 0.8
```

---

### 2.2 ç­–ç•¥ä¼˜åŒ–ç®—æ³•

#### å‚æ•°ä¼˜åŒ–é€»è¾‘

```python
def _run_optimization(params: Dict, metrics: Dict) -> Dict:
    """
    åŸºäºå†å²è¡¨ç°ä¼˜åŒ–ç­–ç•¥å‚æ•°
    
    ä¼˜åŒ–è§„åˆ™ï¼š
    
    1. èƒœç‡ä½(<50%): 
       - æé«˜ä¿¡å¿ƒé˜ˆå€¼20% (æ›´ä¸¥æ ¼ç­›é€‰)
       - é™ä½æ­¢æŸ20% (æ›´æ—©æ­¢æŸ)
       
    2. èƒœç‡é«˜(>70%):
       - æé«˜æœ€å¤§ä»“ä½20% (å¢åŠ æ”¶ç›Š)
       - æé«˜æ­¢ç›ˆ30% (æ‰©å¤§ç›ˆåˆ©ç©ºé—´)
       
    3. å…¶ä»–æƒ…å†µ: ä¿æŒå‚æ•°ä¸å˜
    
    å‚æ•°é™åˆ¶ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å‚æ•°         â”‚ æœ€å°å€¼ â”‚ æœ€å¤§å€¼ â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ ä¿¡å¿ƒé˜ˆå€¼     â”‚ 0.5    â”‚ 0.9    â”‚
    â”‚ æ­¢æŸ         â”‚ 0.03   â”‚ 0.15   â”‚
    â”‚ æœ€å¤§ä»“ä½     â”‚ 0.1    â”‚ 0.8    â”‚
    â”‚ æ­¢ç›ˆ         â”‚ 0.1    â”‚ 0.5    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    """
    win_rate = metrics.get("win_rate", 0.5)
    optimized = dict(params)
    
    if win_rate < 0.5:
        # æé«˜é£æ§æ ‡å‡†
        optimized["confidence_threshold"] = min(
            0.9, 
            params.get("confidence_threshold", 0.6) * 1.2
        )
        optimized["stop_loss"] = max(
            0.03, 
            params.get("stop_loss", 0.08) * 0.8
        )
        
    elif win_rate > 0.7:
        # é€‚å½“æ”¾å®½é™åˆ¶
        optimized["max_position"] = min(
            0.8, 
            params.get("max_position", 0.5) * 1.2
        )
        optimized["take_profit"] = min(
            0.5,
            params.get("take_profit", 0.25) * 1.3
        )
    
    return optimized
```

#### æ”¹è¿›åº¦è®¡ç®—

```python
def calculate_improvement(
    original_metrics: Dict,
    optimized_metrics: Dict
) -> Dict:
    """
    æ”¹è¿›åº¦ = (ä¼˜åŒ–åæŒ‡æ ‡ - åŸå§‹æŒ‡æ ‡) / åŸå§‹æŒ‡æ ‡ Ã— 100%
    
    å…³é”®æŒ‡æ ‡ï¼š
    - èƒœç‡æ”¹è¿›
    - å¹³å‡æ”¶ç›Šæ”¹è¿›
    - æœ€å¤§å›æ’¤æ”¹è¿›
    - å¤æ™®æ¯”ç‡æ”¹è¿›
    
    ç¤ºä¾‹ï¼š
    åŸå§‹èƒœç‡: 50%, ä¼˜åŒ–å: 60%
    æ”¹è¿›åº¦ = (60-50)/50 Ã— 100% = 20%
    """
    improvements = {}
    
    for key in optimized_metrics:
        if key in original_metrics and original_metrics[key] != 0:
            improvement = (
                (optimized_metrics[key] - original_metrics[key]) / 
                original_metrics[key] * 100
            )
            improvements[key] = round(improvement, 2)
    
    return improvements
```

---

### 2.3 è¡¨ç°æŒ‡æ ‡è®¡ç®—

#### èƒœç‡è®¡ç®—

```python
def _calculate_win_rate(trades: List[Dict]) -> float:
    """
    èƒœç‡ = ç›ˆåˆ©äº¤æ˜“æ•° / æ€»äº¤æ˜“æ•°
    
    ä»…ç»Ÿè®¡å·²å®Œæˆçš„ä¹°å–é…å¯¹äº¤æ˜“
    
    è®¡ç®—ç¤ºä¾‹ï¼š
    æ€»äº¤æ˜“: 10ç¬”
    ç›ˆåˆ©: 6ç¬”
    äºæŸ: 4ç¬”
    èƒœç‡ = 6/10 = 60%
    """
    if not trades:
        return 0.0
    
    sells = [t for t in trades if t["action"] == "SELL"]
    if not sells:
        return 0.0
    
    profitable = [t for t in sells if t.get("profit_loss", 0) > 0]
    win_rate = len(profitable) / len(sells)
    
    return round(win_rate, 4)
```

#### æœ€å¤§å›æ’¤è®¡ç®—

```python
def _calculate_max_drawdown(equity_curve: List[float]) -> float:
    """
    æœ€å¤§å›æ’¤ = (å³°å€¼ - è°·å€¼) / å³°å€¼
    
    åŸºäºå‡€å€¼æ›²çº¿è®¡ç®—
    
    è®¡ç®—æ­¥éª¤ï¼š
    1. éå†å‡€å€¼æ›²çº¿
    2. è®°å½•å†å²æœ€é«˜ç‚¹
    3. è®¡ç®—å½“å‰å›æ’¤ = (å³°å€¼ - å½“å‰å€¼) / å³°å€¼
    4. å–æœ€å¤§å›æ’¤å€¼
    
    ç¤ºä¾‹ï¼š
    å‡€å€¼æ›²çº¿: [100, 110, 105, 120, 90, 100]
    å³°å€¼åºåˆ—: [100, 110, 110, 120, 120, 120]
    å›æ’¤åºåˆ—: [0%, 0%, 4.5%, 0%, 25%, 16.7%]
    æœ€å¤§å›æ’¤: 25%
    """
    if not equity_curve:
        return 0.0
    
    peak = equity_curve[0]
    max_dd = 0
    
    for value in equity_curve:
        if value > peak:
            peak = value
        drawdown = (peak - value) / peak
        max_dd = max(max_dd, drawdown)
    
    return round(max_dd, 4)
```

#### å¤æ™®æ¯”ç‡è®¡ç®—

```python
def _calculate_sharpe_ratio(
    returns: List[float], 
    risk_free_rate: float = 0.03
) -> float:
    """
    å¤æ™®æ¯”ç‡ = (å¹³å‡æ”¶ç›Šç‡ - æ— é£é™©åˆ©ç‡) / æ”¶ç›Šç‡æ ‡å‡†å·®
    
    æ— é£é™©åˆ©ç‡é»˜è®¤3% (å¹´åŒ–)
    
    è¯„çº§æ ‡å‡†ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å¤æ™®æ¯”ç‡   â”‚ è¯„çº§       â”‚ è¯´æ˜     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ > 3.0      â”‚ å“è¶Š       â”‚ æä½³     â”‚
    â”‚ 2.0 - 3.0  â”‚ ä¼˜ç§€       â”‚ å¾ˆå¥½     â”‚
    â”‚ 1.0 - 2.0  â”‚ è‰¯å¥½       â”‚ å¯æ¥å—   â”‚
    â”‚ 0.5 - 1.0  â”‚ ä¸€èˆ¬       â”‚ éœ€æ”¹è¿›   â”‚
    â”‚ < 0.5      â”‚ è¾ƒå·®       â”‚ ä¸ç†æƒ³   â”‚
    â”‚ < 0        â”‚ è´Ÿå€¼       â”‚ äºæŸ     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    è®¡ç®—ç¤ºä¾‹ï¼š
    æœˆæ”¶ç›Šç‡: [2%, 3%, -1%, 4%, 2%]
    å¹³å‡æ”¶ç›Š: 2%
    æ ‡å‡†å·®: 1.87%
    å¤æ™®æ¯”ç‡ = (2% - 0.25%) / 1.87% = 0.94
    """
    if not returns or len(returns) < 2:
        return 0.0
    
    avg_return = np.mean(returns)
    std_return = np.std(returns)
    
    if std_return == 0:
        return 0.0
    
    # å°†å¹´åŒ–æ— é£é™©åˆ©ç‡è½¬æ¢ä¸ºæœŸé—´åˆ©ç‡
    period_risk_free = risk_free_rate / 12  # å‡è®¾æœˆåº¦æ”¶ç›Š
    
    sharpe = (avg_return - period_risk_free) / std_return
    return round(sharpe, 2)
```

#### ç´¢æè¯ºæ¯”ç‡è®¡ç®—

```python
def _calculate_sortino_ratio(
    returns: List[float],
    risk_free_rate: float = 0.03
) -> float:
    """
    ç´¢æè¯ºæ¯”ç‡ = (å¹³å‡æ”¶ç›Šç‡ - æ— é£é™©åˆ©ç‡) / ä¸‹è¡Œæ ‡å‡†å·®
    
    ä¸å¤æ™®æ¯”ç‡çš„åŒºåˆ«ï¼š
    - å¤æ™®æ¯”ç‡: è€ƒè™‘æ‰€æœ‰æ³¢åŠ¨
    - ç´¢æè¯ºæ¯”ç‡: åªè€ƒè™‘ä¸‹è¡Œæ³¢åŠ¨ï¼ˆæ›´åˆç†ï¼‰
    
    ä¸‹è¡Œæ ‡å‡†å·® = sqrt(mean((min(return, 0))^2))
    
    ä¼˜åŠ¿ï¼š
    - ä¸æƒ©ç½šä¸Šè¡Œæ³¢åŠ¨
    - æ›´å…³æ³¨ä¸‹è¡Œé£é™©
    - æ›´é€‚åˆè¯„ä¼°æŠ•èµ„ç­–ç•¥
    """
    if not returns or len(returns) < 2:
        return 0.0
    
    avg_return = np.mean(returns)
    
    # è®¡ç®—ä¸‹è¡Œæ ‡å‡†å·®ï¼ˆåªè€ƒè™‘è´Ÿæ”¶ç›Šï¼‰
    downside_returns = [min(r, 0) for r in returns]
    downside_std = np.std(downside_returns)
    
    if downside_std == 0:
        return 0.0
    
    period_risk_free = risk_free_rate / 12
    sortino = (avg_return - period_risk_free) / downside_std
    
    return round(sortino, 2)
```

---

## ä¸‰ã€å·¥å…·è°ƒç”¨å¼ºåˆ¶æœºåˆ¶

### 3.1 DashScopeé¢„å¤„ç†æœºåˆ¶

**æ–‡ä»¶ä½ç½®**: `backend/agents/analysts/news_analyst.py`

```python
def dashscope_preprocessing(llm, ticker: str, unified_news_tool) -> Optional[str]:
    """
    DashScopeæ¨¡å‹é¢„å¤„ç†å¼ºåˆ¶æ–°é—»è·å–
    
    é—®é¢˜ï¼šDashScopeæ¨¡å‹å¯èƒ½ä¸è°ƒç”¨å·¥å…·
    è§£å†³æ–¹æ¡ˆï¼šé¢„å…ˆå¼ºåˆ¶è·å–æ•°æ®ï¼Œç›´æ¥æä¾›ç»™æ¨¡å‹
    
    æµç¨‹ï¼š
    1. æ£€æµ‹æ¨¡å‹ç±»å‹ (DashScope)
    2. å¼ºåˆ¶è°ƒç”¨ç»Ÿä¸€æ–°é—»å·¥å…·
    3. é¢„è·å–æ–°é—»æ•°æ®
    4. ç›´æ¥åŸºäºæ•°æ®ç”Ÿæˆåˆ†æ
    5. è·³è¿‡å·¥å…·è°ƒç”¨ç¯èŠ‚
    
    ä¼˜åŠ¿ï¼š
    - ç¡®ä¿æ•°æ®è·å–
    - é¿å…å·¥å…·è°ƒç”¨å¤±è´¥
    - æé«˜å“åº”é€Ÿåº¦
    """
    if 'DashScope' not in llm.__class__.__name__:
        return None
    
    logger.warning("[æ–°é—»åˆ†æå¸ˆ] æ£€æµ‹åˆ°DashScopeæ¨¡å‹ï¼Œå¯åŠ¨é¢„å¤„ç†...")
    
    try:
        # å¼ºåˆ¶é¢„å…ˆè·å–æ–°é—»æ•°æ®
        pre_fetched_news = unified_news_tool(
            stock_code=ticker, 
            max_news=10, 
            model_info="DashScope"
        )
        
        if pre_fetched_news and len(pre_fetched_news.strip()) > 100:
            logger.info("[æ–°é—»åˆ†æå¸ˆ] é¢„å¤„ç†æˆåŠŸè·å–æ–°é—»")
            return pre_fetched_news
        else:
            logger.warning("[æ–°é—»åˆ†æå¸ˆ] é¢„å¤„ç†è·å–æ–°é—»å¤±è´¥")
            return None
            
    except Exception as e:
        logger.error(f"[æ–°é—»åˆ†æå¸ˆ] é¢„å¤„ç†å¤±è´¥: {e}")
        return None
```

### 3.2 å¼ºåˆ¶è¡¥æ•‘æœºåˆ¶

```python
def force_tool_call_rescue(llm, result, ticker: str, unified_news_tool) -> str:
    """
    å·¥å…·è°ƒç”¨å¤±è´¥çš„å¼ºåˆ¶è¡¥æ•‘æœºåˆ¶
    
    è§¦å‘æ¡ä»¶ï¼š
    - LLMæ²¡æœ‰è°ƒç”¨ä»»ä½•å·¥å…· (tool_call_count == 0)
    
    è¡¥æ•‘æ­¥éª¤ï¼š
    1. æ£€æµ‹å·¥å…·è°ƒç”¨æƒ…å†µ
    2. å¼ºåˆ¶è°ƒç”¨ç»Ÿä¸€æ–°é—»å·¥å…·
    3. åŸºäºçœŸå®æ•°æ®é‡æ–°ç”Ÿæˆåˆ†æ
    4. è¿”å›å®Œæ•´åˆ†ææŠ¥å‘Š
    
    é€‚ç”¨æ¨¡å‹ï¼š
    - æ‰€æœ‰éGoogleæ¨¡å‹
    - ç‰¹åˆ«æ˜¯DashScopeã€é€šä¹‰åƒé—®ç­‰
    """
    tool_call_count = len(result.tool_calls) if hasattr(result, 'tool_calls') else 0
    
    if tool_call_count > 0:
        return result.content  # æœ‰å·¥å…·è°ƒç”¨ï¼Œæ­£å¸¸å¤„ç†
    
    logger.warning("[è¡¥æ•‘æœºåˆ¶] LLMæœªè°ƒç”¨å·¥å…·ï¼Œå¯åŠ¨å¼ºåˆ¶è¡¥æ•‘...")
    
    try:
        # å¼ºåˆ¶è·å–æ–°é—»æ•°æ®
        forced_news = unified_news_tool(
            stock_code=ticker, 
            max_news=10, 
            model_info=""
        )
        
        if forced_news and len(forced_news.strip()) > 100:
            logger.info("[è¡¥æ•‘æœºåˆ¶] å¼ºåˆ¶è·å–æ–°é—»æˆåŠŸ")
            
            # åŸºäºçœŸå®æ–°é—»æ•°æ®é‡æ–°ç”Ÿæˆåˆ†æ
            forced_prompt = f"""
æ‚¨æ˜¯ä¸“ä¸šçš„è´¢ç»æ–°é—»åˆ†æå¸ˆã€‚è¯·åŸºäºä»¥ä¸‹æœ€æ–°è·å–çš„æ–°é—»æ•°æ®ï¼Œ
å¯¹è‚¡ç¥¨ {ticker} è¿›è¡Œè¯¦ç»†çš„æ–°é—»åˆ†æï¼š

=== æœ€æ–°æ–°é—»æ•°æ® ===
{forced_news}

è¯·æ’°å†™è¯¦ç»†çš„ä¸­æ–‡åˆ†ææŠ¥å‘Šã€‚
"""
            
            forced_result = llm.invoke([{
                "role": "user", 
                "content": forced_prompt
            }])
            
            if hasattr(forced_result, 'content') and forced_result.content:
                logger.info("[è¡¥æ•‘æœºåˆ¶] è¡¥æ•‘æˆåŠŸ")
                return forced_result.content
        
        logger.warning("[è¡¥æ•‘æœºåˆ¶] è¡¥æ•‘å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹ç»“æœ")
        return result.content
        
    except Exception as e:
        logger.error(f"[è¡¥æ•‘æœºåˆ¶] è¡¥æ•‘è¿‡ç¨‹å¤±è´¥: {e}")
        return result.content
```

### 3.3 Googleæ¨¡å‹ç»Ÿä¸€å¤„ç†

```python
def handle_google_tool_calls(
    result,
    llm,
    tools: List,
    state: Dict,
    analysis_prompt_template: str,
    analyst_name: str
) -> Tuple[str, List]:
    """
    Googleæ¨¡å‹å·¥å…·è°ƒç”¨ç»Ÿä¸€å¤„ç†å™¨
    
    ç‰¹ç‚¹ï¼š
    - Googleæ¨¡å‹å·¥å…·è°ƒç”¨æ ¼å¼ç‰¹æ®Š
    - éœ€è¦ç‰¹æ®Šçš„æ¶ˆæ¯æ ¼å¼å¤„ç†
    - æ”¯æŒå¤šè½®å·¥å…·è°ƒç”¨
    
    å¤„ç†æµç¨‹ï¼š
    1. æ£€æµ‹å·¥å…·è°ƒç”¨
    2. æ‰§è¡Œå·¥å…·è·å–æ•°æ®
    3. æ„å»ºå·¥å…·æ¶ˆæ¯
    4. ç”Ÿæˆæœ€ç»ˆåˆ†æ
    5. è¿”å›æŠ¥å‘Šå’Œæ¶ˆæ¯åˆ—è¡¨
    """
    if not hasattr(result, 'tool_calls') or not result.tool_calls:
        return result.content, [result]
    
    logger.info(f"[{analyst_name}] Googleæ¨¡å‹å·¥å…·è°ƒç”¨å¤„ç†")
    
    # æ‰§è¡Œæ‰€æœ‰å·¥å…·è°ƒç”¨
    tool_messages = []
    for tool_call in result.tool_calls:
        tool_name = tool_call.get('name')
        tool_args = tool_call.get('args', {})
        
        # æŸ¥æ‰¾å¹¶æ‰§è¡Œå·¥å…·
        for tool in tools:
            if hasattr(tool, 'name') and tool.name == tool_name:
                tool_result = tool.invoke(tool_args)
                tool_messages.append({
                    "role": "tool",
                    "content": str(tool_result),
                    "tool_call_id": tool_call.get('id')
                })
                break
    
    # åŸºäºå·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆåˆ†æ
    messages = state["messages"] + [result] + tool_messages
    messages.append({"role": "user", "content": analysis_prompt_template})
    
    final_result = llm.invoke(messages)
    report = final_result.content
    
    return report, messages + [final_result]
```

---

## ğŸ“Œ æ ¸å¿ƒç«äº‰åŠ›æ€»ç»“

### 1. å¤šå±‚è¿‡æ»¤æœºåˆ¶
- è§„åˆ™è¿‡æ»¤ + è¯­ä¹‰ç›¸ä¼¼åº¦ + æœ¬åœ°åˆ†ç±»æ¨¡å‹
- ä¸‰é‡éªŒè¯ç¡®ä¿æ–°é—»è´¨é‡

### 2. æƒ…ç»ªåˆ†æç³»ç»Ÿ
- è¯å…¸ + å¼ºåº¦è°ƒèŠ‚ + å¦å®šå¤„ç†
- å¤šæºåŠ æƒç»¼åˆè¯„åˆ†

### 3. å¤šæ™ºèƒ½ä½“è¾©è®º
- å¤šç©ºå¯¹å†³ + ä¸‰æ–¹åšå¼ˆ
- è§‚ç‚¹å¼ºåº¦é‡åŒ–è¯„ä¼°

### 4. åŠ¨æ€é£é™©ç®¡ç†
- å®æ—¶é£é™©ç›‘æ§
- è‡ªé€‚åº”ä»“ä½è°ƒæ•´

### 5. é—­ç¯éªŒè¯ä¼˜åŒ–
- å†³ç­–éªŒè¯ + ç­–ç•¥ä¼˜åŒ–
- æŒç»­å­¦ä¹ æ”¹è¿›

### 6. å·¥å…·è°ƒç”¨ä¿éšœ
- é¢„å¤„ç† + å¼ºåˆ¶è¡¥æ•‘
- å¤šæ¨¡å‹é€‚é…

---

## ğŸ“Œ ç›¸å…³æ–‡æ¡£

- [æ ¸å¿ƒé€»è¾‘ä¸ç®—æ³•-ç¬¬1éƒ¨åˆ†](./é¡¹ç›®æ ¸å¿ƒé€»è¾‘ä¸ç®—æ³•-ç¬¬1éƒ¨åˆ†-è¿‡æ»¤ä¸è¯„åˆ†.md) - è¿‡æ»¤ä¸è¯„åˆ†ç®—æ³•
- [æ ¸å¿ƒé€»è¾‘ä¸ç®—æ³•-ç¬¬2éƒ¨åˆ†](./é¡¹ç›®æ ¸å¿ƒé€»è¾‘ä¸ç®—æ³•-ç¬¬2éƒ¨åˆ†-è¾©è®ºä¸é£æ§.md) - è¾©è®ºæœºåˆ¶ä¸é£é™©ç®¡ç†
- [æ™ºèƒ½ä½“æç¤ºè¯å®Œæ•´æ–‡æ¡£](./æ™ºèƒ½ä½“æç¤ºè¯å®Œæ•´æ–‡æ¡£-ç¬¬1éƒ¨åˆ†.md) - æ™ºèƒ½ä½“æç¤ºè¯
