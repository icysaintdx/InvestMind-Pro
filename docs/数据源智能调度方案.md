# InvestMindPro 数据源智能调度方案

## 一、测试结果汇总

### 1.1 各数据源响应时间对比

| 数据类型 | TDX | Tushare | AKShare | 巨潮 |
|---------|-----|---------|---------|------|
| 单只股票行情 | **60ms** | - | 160-510ms | 需Token |
| 批量股票行情 | **64ms** | - | 18-23秒(全市场) | - |
| 日K线数据 | **60ms** | 100-180ms | 160-510ms | - |
| 股票列表 | **123ms** | 220-240ms | - | - |
| 利润表 | - | **120-140ms** | - | - |
| 资金流向 | - | **100-120ms** | 85-94ms | - |
| 龙虎榜 | - | **90-120ms** | 370ms | - |
| 融资融券 | - | - | 540-600ms | - |
| 行业板块 | - | - | 250-1200ms | - |
| 概念板块 | - | - | **600ms** | - |
| 全球资讯 | - | - | **180-200ms** | - |
| 公司信息 | - | - | **84-100ms** | 120-150ms |

### 1.2 关键发现

1. **TDX最快最稳定** - 60-120ms，适合实时行情
2. **AKShare大部分接口正常** - 只有全市场行情慢（数据量大导致）
3. **Tushare稳定可靠** - 100-240ms，财务数据首选
4. **巨潮需要Token** - 响应本身快，但需要认证

### 1.3 问题接口

| 接口 | 问题 | 原因 |
|------|------|------|
| ak.stock_zh_a_spot_em | 18-23秒 | 获取5792只股票，数据量大 |
| ak.stock_news_em | JSON解析错误 | AKShare bug |
| ak.stock_zygc_em | 接口错误 | 东财接口变更 |
| 巨潮所有接口 | 返回401 | 需要Token认证 |

---

## 二、数据分类与接口覆盖对照表

### 2.1 实时行情类

| 数据需求 | TDX | Tushare | AKShare | 推荐 |
|---------|-----|---------|---------|------|
| 单只股票实时行情 | get_security_quotes | - | stock_bid_ask_em | TDX |
| 批量股票行情 | get_security_quotes(80只/次) | - | stock_zh_a_spot_em | TDX |
| 五档盘口 | get_security_quotes(含五档) | - | stock_bid_ask_em | TDX |
| 指数行情 | get_security_quotes | - | stock_zh_index_spot_em | TDX |
| 分时数据 | get_history_minute_time_data | - | stock_zh_a_hist_min_em | TDX |

### 2.2 K线历史类

| 数据需求 | TDX | Tushare | AKShare | 推荐 |
|---------|-----|---------|---------|------|
| 日K线 | get_security_bars | daily | stock_zh_a_hist | TDX/Tushare |
| 周K线 | get_security_bars | weekly | stock_zh_a_hist | TDX/Tushare |
| 月K线 | get_security_bars | monthly | stock_zh_a_hist | TDX/Tushare |
| 分钟K线 | get_security_bars | - | stock_zh_a_hist_min_em | TDX |
| 复权数据 | - | pro_bar(adj) | stock_zh_a_hist(adjust) | Tushare |

### 2.3 财务数据类

| 数据需求 | TDX | Tushare | AKShare | 推荐 |
|---------|-----|---------|---------|------|
| 利润表 | - | income | - | Tushare |
| 资产负债表 | - | balancesheet | - | Tushare |
| 现金流量表 | - | cashflow | - | Tushare |
| 财务指标 | - | fina_indicator | stock_financial_analysis_indicator | Tushare |
| 主营构成 | - | fina_mainbz | stock_zygc_em(有bug) | Tushare |
| 业绩预告 | - | forecast | stock_yjyg_em | Tushare |
| 业绩快报 | - | express | stock_yjkb_em | Tushare |

### 2.4 资金流向类

| 数据需求 | TDX | Tushare | AKShare | 推荐 |
|---------|-----|---------|---------|------|
| 个股资金流向 | - | moneyflow | stock_individual_fund_flow | 都可以 |
| 板块资金流向 | - | - | stock_sector_fund_flow_rank | AKShare |
| 北向资金 | - | hk_hold | stock_hsgt_north_net_flow_in | Tushare |
| 融资融券 | - | margin | stock_margin_detail_sse | 都可以 |

### 2.5 龙虎榜类

| 数据需求 | TDX | Tushare | AKShare | 推荐 |
|---------|-----|---------|---------|------|
| 龙虎榜明细 | - | top_list | stock_lhb_detail_em | 都可以 |
| 机构龙虎榜 | - | top_inst | stock_lhb_jgstatistic_em | 都可以 |
| 营业部统计 | - | - | stock_lhb_traderstatistic_em | AKShare |

### 2.6 新闻公告类

| 数据需求 | TDX | Tushare | AKShare | 巨潮 | 推荐 |
|---------|-----|---------|---------|------|------|
| 全球资讯 | - | - | stock_info_global_em | - | AKShare |
| 财联社电报 | - | - | stock_telegraph_cls | - | AKShare |
| 个股新闻 | - | - | stock_news_em(有bug) | p_info3030 | 巨潮 |
| 公司公告 | - | - | stock_notice_report | p_info3015 | 巨潮 |
| 研报摘要 | - | - | - | p_info3097_inc | 巨潮 |

### 2.7 基础信息类

| 数据需求 | TDX | Tushare | AKShare | 巨潮 | 推荐 |
|---------|-----|---------|---------|------|------|
| 股票列表 | get_security_list | stock_basic | - | - | TDX/Tushare |
| 公司信息 | - | - | stock_individual_info_em | p_stock2100 | AKShare |
| 行业板块 | - | - | stock_board_industry_name_em | - | AKShare |
| 概念板块 | - | - | stock_board_concept_name_em | - | AKShare |
| 管理层信息 | - | - | - | p_stock2102 | 巨潮 |

### 2.8 市场统计类

| 数据需求 | TDX | Tushare | AKShare | 推荐 |
|---------|-----|---------|---------|------|
| 涨跌停统计 | 需计算 | - | stock_zt_pool_em | AKShare |
| ST股票列表 | - | stock_basic(is_st) | stock_zh_a_st_em | 都可以 |
| 停复牌 | - | suspend_d | stock_zh_a_stop_em | Tushare |
| 限售解禁 | - | share_float | stock_restricted_release_queue_sina | Tushare |
| 股东户数 | - | stk_holdernumber | stock_zh_a_gdhs | 都可以 |

---

## 三、智能数据源调度系统设计

### 3.1 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                      前端配置界面                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 数据源管理  │ │ 缓存设置    │ │ 优先级配置  │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据源调度器 (DataSourceScheduler)         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 读取配置 → 2. 健康检查 → 3. 选择最优源 → 4. 获取数据 │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            ▼               ▼               ▼
    ┌───────────┐   ┌───────────┐   ┌───────────┐
    │    TDX    │   │  Tushare  │   │  AKShare  │
    │  Provider │   │  Provider │   │  Provider │
    └───────────┘   └───────────┘   └───────────┘
            │               │               │
            └───────────────┼───────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    统一缓存层 (UnifiedCache)                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 内存缓存    │ │ 文件缓存    │ │ 数据库缓存  │           │
│  │ (热数据)    │ │ (温数据)    │ │ (冷数据)    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 数据分类与缓存策略

| 数据类别 | 更新频率 | 缓存时效 | 缓存层级 | 示例 |
|---------|---------|---------|---------|------|
| 实时行情 | 秒级 | 3-5秒 | 内存 | 股票价格、五档盘口 |
| 分时数据 | 分钟级 | 1分钟 | 内存 | 分时图、分钟K线 |
| 日内统计 | 5分钟 | 5分钟 | 内存+文件 | 涨跌停统计、板块涨幅 |
| 日K线 | 日级 | 1小时 | 文件 | 日/周/月K线 |
| 财务数据 | 季度 | 24小时 | 文件+数据库 | 财报、财务指标 |
| 基础信息 | 低频 | 7天 | 数据库 | 公司信息、股票列表 |
| 新闻公告 | 实时 | 10分钟 | 内存+文件 | 新闻、公告 |

### 3.3 配置文件结构 (data/data_source_config.json)

```json
{
  "data_sources": {
    "tdx": {
      "enabled": true,
      "priority": 1,
      "timeout": 5000,
      "retry": 3,
      "servers": [
        {"host": "218.75.126.9", "port": 7709},
        {"host": "119.147.212.81", "port": 7709}
      ]
    },
    "tushare": {
      "enabled": true,
      "priority": 2,
      "timeout": 10000,
      "retry": 2
    },
    "akshare": {
      "enabled": true,
      "priority": 3,
      "timeout": 15000,
      "retry": 2
    },
    "cninfo": {
      "enabled": false,
      "priority": 4,
      "timeout": 10000
    }
  },

  "data_categories": {
    "realtime_quote": {
      "name": "实时行情",
      "sources": ["tdx", "akshare"],
      "primary": "tdx",
      "cache_ttl": 5,
      "cache_level": "memory"
    },
    "kline_daily": {
      "name": "日K线",
      "sources": ["tdx", "tushare", "akshare"],
      "primary": "tdx",
      "cache_ttl": 3600,
      "cache_level": "file"
    },
    "financial": {
      "name": "财务数据",
      "sources": ["tushare"],
      "primary": "tushare",
      "cache_ttl": 86400,
      "cache_level": "database"
    },
    "fund_flow": {
      "name": "资金流向",
      "sources": ["tushare", "akshare"],
      "primary": "tushare",
      "cache_ttl": 300,
      "cache_level": "file"
    },
    "news": {
      "name": "新闻资讯",
      "sources": ["akshare"],
      "primary": "akshare",
      "cache_ttl": 600,
      "cache_level": "memory"
    }
  }
}
```

---

## 四、前端配置界面设计

### 4.1 数据源管理页面

功能：
1. **数据源状态监控** - 显示每个数据源的健康状态、响应时间、成功率
2. **启用/禁用开关** - 可以临时禁用某个数据源
3. **优先级调整** - 拖拽调整数据源优先级
4. **连接测试** - 一键测试所有数据源连接

### 4.2 缓存设置页面

功能：
1. **按数据类别设置缓存时效** - 每种数据类型独立设置
2. **缓存层级选择** - 内存/文件/数据库
3. **手动清除缓存** - 按类别清除
4. **缓存统计** - 显示缓存命中率、大小

### 4.3 数据源测试页面

功能：
1. **按数据类别测试** - 选择数据类别，测试所有可用数据源
2. **显示响应时间对比** - 柱状图展示
3. **自动推荐最优源** - 根据测试结果推荐

---

## 五、实施步骤

### 第一阶段：基础架构（1-2天）

1. 创建配置文件结构 `data/data_source_config.json`
2. 实现 `DataSourceScheduler` 核心调度器
3. 实现统一缓存层 `UnifiedCache`
4. 添加健康检查机制

### 第二阶段：Provider适配（2-3天）

1. 统一 TDX Provider 接口
2. 统一 Tushare Provider 接口
3. 统一 AKShare Provider 接口
4. 实现接口映射表

### 第三阶段：前端界面（2-3天）

1. 数据源管理页面
2. 缓存设置页面
3. 数据源测试页面
4. 实时状态监控

### 第四阶段：集成测试（1-2天）

1. 各模块集成调度器
2. 性能测试
3. 降级测试
4. 文档完善

---

## 六、API接口设计

### 6.1 数据源配置API

```
GET  /api/datasource/config          # 获取配置
PUT  /api/datasource/config          # 更新配置
GET  /api/datasource/health          # 获取健康状态
POST /api/datasource/test            # 测试数据源
POST /api/datasource/test-category   # 测试指定类别所有数据源
```

### 6.2 缓存管理API

```
GET  /api/cache/stats                # 缓存统计
POST /api/cache/clear                # 清除缓存
PUT  /api/cache/config               # 更新缓存配置
```

---

## 七、总结

本方案的核心思想：

1. **配置驱动** - 所有数据源和缓存策略通过配置文件管理，无需修改代码
2. **自动降级** - 主数据源失败自动切换到备用数据源
3. **健康监控** - 实时监控数据源健康状态，自动调整优先级
4. **灵活缓存** - 按数据类别设置不同的缓存策略
5. **前端可配** - 用户可以通过界面调整所有设置

这样即使将来数据源发生变化，也只需要修改配置，不需要改代码。

---

## 八、实现状态（2026-01-01更新）

### 8.1 已完成

| 模块 | 文件 | 说明 |
|-----|------|------|
| 配置文件 | `data/data_source_config.json` | 完整的数据源和缓存配置 |
| 调度器 | `backend/services/data_source_scheduler.py` | 核心调度逻辑，被动监控 |
| API接口 | `backend/api/datasource_api.py` | RESTful API接口 |
| 服务注册 | `backend/server.py` | 已注册到FastAPI |

### 8.2 API接口列表

```
# 配置管理
GET  /api/datasource/config                    # 获取完整配置
PUT  /api/datasource/config/source/{source}    # 更新数据源配置
PUT  /api/datasource/config/category/{cat}     # 更新数据类别配置
POST /api/datasource/source/{source}/enable    # 启用数据源
POST /api/datasource/source/{source}/disable   # 禁用数据源

# 健康状态
GET  /api/datasource/health                    # 获取所有数据源健康状态
GET  /api/datasource/categories                # 获取所有数据类别状态
GET  /api/datasource/best-source/{category}    # 获取最优数据源

# 测试功能
POST /api/datasource/test                      # 测试单个数据源
POST /api/datasource/test-category             # 测试指定类别所有数据源
POST /api/datasource/test-all                  # 测试所有数据源

# 缓存管理
GET  /api/datasource/cache/stats               # 缓存统计
POST /api/datasource/cache/clear               # 清除缓存

# 指标管理
POST /api/datasource/metrics/reset             # 重置指标
```

### 8.3 使用示例

```python
from backend.services.data_source_scheduler import DataSourceScheduler, track_request

# 获取调度器实例（单例）
scheduler = DataSourceScheduler()

# 获取最优数据源
best_source = scheduler.get_best_source("realtime_quote")  # 返回 "tdx"

# 获取备用数据源
fallbacks = scheduler.get_fallback_sources("realtime_quote", exclude="tdx")

# 获取缓存配置
cache_config = scheduler.get_cache_config("financial")  # {"ttl": 86400, "level": "database"}

# 使用装饰器自动记录请求指标
@track_request(source="akshare", category="news", interface="stock_info_global_em")
def get_news():
    import akshare as ak
    return ak.stock_info_global_em()
```

### 8.4 监控特点

本方案采用**被动监控**模式：

1. **不主动轮询** - 只在实际请求时记录指标，不会占用系统资源
2. **异步保存** - 指标每100次请求异步保存一次，不阻塞主流程
3. **滑动平均** - 响应时间使用滑动平均计算，避免单次异常影响
4. **健康评分** - 综合成功率(60%)和响应时间(40%)计算健康分数

### 8.5 待完成

- [ ] 前端配置界面（数据源管理页面）
- [ ] 前端测试界面（响应时间对比图表）
- [ ] 统一缓存层实现
- [ ] 各模块集成调度器

