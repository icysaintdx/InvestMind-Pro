<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IcySaint AI - å¤šæ™ºèƒ½ä½“è‚¡ç¥¨åˆ†æå†³ç­–ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }


        /* ç²’å­èƒŒæ™¯ */
        #particles-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        /* æ¸å˜å¡ç‰‡æ•ˆæœ */
        .gradient-card-cyan {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(8, 145, 178, 0.05) 100%);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }
        .gradient-card-violet {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        .gradient-card-emerald {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .gradient-card-blue {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .gradient-card-indigo {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .gradient-card-fuchsia {
            background: linear-gradient(135deg, rgba(217, 70, 239, 0.1) 0%, rgba(192, 38, 211, 0.05) 100%);
            border: 1px solid rgba(217, 70, 239, 0.3);
        }
        .gradient-card-orange {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(249, 115, 22, 0.05) 100%);
            border: 1px solid rgba(251, 146, 60, 0.3);
        }
        .gradient-card-amber {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .gradient-card-red {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .gradient-card-slate {
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.1) 0%, rgba(71, 85, 105, 0.05) 100%);
            border: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        /* æ‰“å­—å…‰æ ‡ */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #3b82f6;
            animation: blink 1s infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* è‡ªå®šä¹‰æ»‘å— */
        .custom-range {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 9999px;
            outline: none;
            border: 1px solid #334155;
        }
        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            border: 2px solid #0f172a;
            cursor: pointer;
        }
        .custom-range::-webkit-slider-thumb:hover {
            background: #60a5fa;
            transform: scale(1.1);
        }
        
        /* æ™ºèƒ½ä½“å›¾æ ‡èƒŒæ™¯è‰² */
        .agent-icon-bg[data-color="slate"] { background: linear-gradient(135deg, rgba(100, 116, 139, 0.2), rgba(71, 85, 105, 0.1)); }
        .agent-icon-bg[data-color="cyan"] { background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(8, 145, 178, 0.1)); }
        .agent-icon-bg[data-color="violet"] { background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); }
        .agent-icon-bg[data-color="emerald"] { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); }
        .agent-icon-bg[data-color="blue"] { background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); }
        .agent-icon-bg[data-color="indigo"] { background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(79, 70, 229, 0.1)); }
        .agent-icon-bg[data-color="fuchsia"] { background: linear-gradient(135deg, rgba(217, 70, 239, 0.2), rgba(192, 38, 211, 0.1)); }
        .agent-icon-bg[data-color="orange"] { background: linear-gradient(135deg, rgba(251, 146, 60, 0.2), rgba(249, 115, 22, 0.1)); }
        .agent-icon-bg[data-color="amber"] { background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); }
        .agent-icon-bg[data-color="red"] { background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1)); }
        
        /* éª¨æ¶å±åŠ è½½åŠ¨ç”» */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-line {
            height: 12px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            /* text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 40px #fff, 0 0 80px #3b82f6; */
            
        }
    </style>
</head>
<body class="min-h-screen">
    <canvas id="particles-canvas"></canvas>
    
    <div class="relative z-10 container mx-auto px-4 py-8 max-w-[1800px]">
        <!-- å¤´éƒ¨ -->
        <header class="text-center mb-12">
            <div class="inline-flex items-center gap-3 mb-4">
                <span class="text-5xl">ğŸš€</span>
                <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    IcySaint AI
                </h1>
            </div>

            <p class="text-xl text-slate-400 mb-2">å¤šæ™ºèƒ½ä½“è‚¡ç¥¨åˆ†æå†³ç­–ç³»ç»Ÿ</p>
            <p class="text-sm text-slate-500">Institutional Grade Multi-Agent System</p>
            <p class="text-xl text-slate-400 mb-2">éƒ¨ç½²ç”±10ä½AIä¸“å®¶ç»„æˆçš„å†³ç­–å§”å‘˜ä¼šã€‚æ¥å…¥èšåˆæ•°æ®APIå®æ—¶è¡Œæƒ…ï¼Œå…¨æ–¹ä½æ‰«æAè‚¡æŠ•èµ„æœºä¼šã€‚</p>
            <div class="flex gap-3 justify-center mt-4">
                <button onclick="toggleConfig()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm transition-colors">
                    âš™ï¸ é…ç½®æ¨¡å¼
                </button>
                <button onclick="openModelManager()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-colors">
                    ğŸ¯ æ¨¡å‹ç®¡ç†
                </button>
            </div>
        </header>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="mb-8 max-w-4xl mx-auto bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 sm:p-6 border border-slate-700">
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mb-4">
                <input 
                    type="text" 
                    id="stockCode" 
                    placeholder="è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š600519ï¼‰"
                    maxlength="6"
                    class="flex-1 px-4 py-3 bg-slate-900 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
                >
                <button 
                    onclick="startAnalysis()" 
                    id="analyzeBtn"
                    class="w-full sm:w-auto px-6 sm:px-8 py-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-xl font-semibold transition-all transform hover:scale-105 active:scale-95 shadow-lg shadow-blue-500/25 whitespace-nowrap"
                >
                    å¼€å§‹åˆ†æ
                </button>
            </div>
            
            <details class="mt-4">
                <summary class="cursor-pointer text-slate-400 hover:text-slate-300 text-sm flex items-center gap-2">
                    <span>âš™ï¸ API é…ç½®ï¼ˆå¯é€‰ - åç«¯å·²é…ç½®å¯å¿½ç•¥ï¼‰</span>
                    <div class="flex gap-2 ml-auto">
                        <div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-slate-500" id="status-dot-gemini"></span>
                            <span class="text-xs">Gemini</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-slate-500" id="status-dot-deepseek"></span>
                            <span class="text-xs">DeepSeek</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-slate-500" id="status-dot-qwen"></span>
                            <span class="text-xs">Qwen</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-slate-500" id="status-dot-siliconflow"></span>
                            <span class="text-xs">SF</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-slate-500" id="status-dot-juhe"></span>
                            <span class="text-xs">Juhe</span>
                        </div>
                    </div>
                </summary>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">ğŸŒŸ Gemini API Key <span id="gemini-status" class="text-green-400"></span></label>
                        <input type="password" id="geminiKey" placeholder="ç”¨äºå®è§‚/è¡Œä¸šåˆ†æ" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-600 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">ğŸ§  DeepSeek API Key <span id="deepseek-status" class="text-green-400"></span></label>
                        <input type="password" id="deepseekKey" placeholder="ç”¨äºæ·±åº¦åˆ†æ" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-600 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">ğŸ¯ é€šä¹‰åƒé—® API Key <span id="qwen-status" class="text-green-400"></span></label>
                        <input type="password" id="qwenKey" placeholder="ç”¨äºä¸“ä¸šåˆ†æ" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-600 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">ğŸ’ ç¡…åŸºæµåŠ¨ API Key <span id="siliconflow-status" class="text-green-400"></span></label>
                        <input type="password" id="siliconflowKey" placeholder="æ”¯æŒ50+æ¨¡å‹" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-600 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">ğŸ“Š èšåˆæ•°æ® API Key <span id="juhe-status" class="text-green-400"></span></label>
                        <input type="password" id="juheKey" placeholder="è·å–å®æ—¶è¡Œæƒ…" class="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-white placeholder-slate-600 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </details>
        </div>

        <!-- æ™ºèƒ½ä½“ç½‘æ ¼ - 4é˜¶æ®µå¸ƒå±€ -->
        <div class="space-y-8 mb-8">
            <!-- ç¬¬ä¸€é˜¶æ®µï¼šåˆ†æå¸ˆå›¢é˜Ÿ -->
            <div>
                <h3 class="text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ“Š</span>
                    <span>ç¬¬ä¸€é˜¶æ®µ - å¹¶è¡Œä¸“ä¸šåˆ†æ</span>
                </h3>
                <div id="stage1Grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4"></div>
            </div>
            
            <!-- ç¬¬äºŒé˜¶æ®µï¼šç»ç†å›¢é˜Ÿ -->
            <div>
                <h3 class="text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ‘”</span>
                    <span>ç¬¬äºŒé˜¶æ®µ - ç­–ç•¥æ•´åˆ</span>
                </h3>
                <div id="stage2Grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            </div>
            
            <!-- ç¬¬ä¸‰é˜¶æ®µï¼šé£æ§å›¢é˜Ÿ -->
            <div>
                <h3 class="text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2">
                    <span class="text-2xl">âš ï¸</span>
                    <span>ç¬¬ä¸‰é˜¶æ®µ - é£æ§è¯„ä¼°</span>
                </h3>
                <div id="stage3Grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            </div>
            
            <!-- ç¬¬å››é˜¶æ®µï¼šæ€»ç»ç†å†³ç­– -->
            <div>
                <h3 class="text-lg font-semibold text-slate-300 mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ‘‘</span>
                    <span>ç¬¬å››é˜¶æ®µ - æœ€ç»ˆå†³ç­–</span>
                </h3>
                <div id="stage4Grid" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>

        <!-- æ¨¡å‹ç®¡ç†å¼¹çª— -->
        <div id="modelManagerModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-slate-800 rounded-2xl p-6 max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col border border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-white">ğŸ¯ æ¨¡å‹ç®¡ç†</h2>
                    <button onclick="closeModelManager()" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
                </div>
                
                <div class="mb-4 space-y-3">
                    <div class="flex gap-4">
                        <input type="text" id="modelSearch" placeholder="æœç´¢æ¨¡å‹..." class="flex-1 px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-blue-500">
                        <button onclick="selectAllModels()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">å…¨é€‰</button>
                        <button onclick="deselectAllModels()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">å–æ¶ˆå…¨é€‰</button>
                        <button onclick="saveModelSelection()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">ä¿å­˜</button>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="filterModelType('all')" class="model-type-filter px-3 py-1 bg-blue-600 rounded-lg text-xs" data-type="all">å…¨éƒ¨</button>
                        <button onclick="filterModelType('qwen')" class="model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs" data-type="qwen">Qwen</button>
                        <button onclick="filterModelType('llama')" class="model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs" data-type="llama">Llama</button>
                        <button onclick="filterModelType('deepseek')" class="model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs" data-type="deepseek">DeepSeek</button>
                        <button onclick="filterModelType('gemma')" class="model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs" data-type="gemma">Gemma</button>
                        <button onclick="filterModelType('mistral')" class="model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs" data-type="mistral">Mistral</button>
                        <button onclick="filterModelType('yi')" class="model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs" data-type="yi">Yi</button>
                        <button onclick="filterModelType('glm')" class="model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs" data-type="glm">GLM</button>
                    </div>
                </div>
                
                <div class="text-sm text-slate-400 mb-2">
                    å·²åŠ è½½ <span id="totalModels" class="text-blue-400 font-bold">0</span> ä¸ªæ¨¡å‹ | 
                    å·²é€‰ä¸­ <span id="selectedModels" class="text-green-400 font-bold">0</span> ä¸ª
                </div>
                
                <div id="modelList" class="flex-1 overflow-y-auto space-y-2 bg-slate-900/50 rounded-lg p-4">
                    <!-- æ¨¡å‹åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- æœ€ç»ˆç»“æœ -->
        <div id="resultSection" class="hidden bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700">
            <h2 class="text-2xl font-bold mb-4 text-white">
                ğŸ“Š ç»¼åˆåˆ†ææŠ¥å‘Š
            </h2>
            <div id="finalResult" class="text-sm leading-relaxed whitespace-pre-wrap text-white" style="font-family: 'Microsoft YaHei', sans-serif;"></div>
        </div>
    </div>

    <script src="/static/particles.js"></script>
    <script src="/static/app.js"></script>
    <script>
        const colorMap = {
            slate: 'gradient-card-slate', cyan: 'gradient-card-cyan', violet: 'gradient-card-violet',
            emerald: 'gradient-card-emerald', blue: 'gradient-card-blue', indigo: 'gradient-card-indigo',
            fuchsia: 'gradient-card-fuchsia', orange: 'gradient-card-orange', amber: 'gradient-card-amber',
            red: 'gradient-card-red'
        };
        
        // æ™ºèƒ½ä½“æè¿°
        function getAgentDescription(agentId) {
            const descriptions = {
                'macro': 'åˆ†æGDPã€CPIã€è´§å¸æ”¿ç­–åŠç³»ç»Ÿæ€§é£é™©ï¼Œåˆ¤æ–­å®è§‚æ°´ä½',
                'industry': 'è·Ÿè¸ªè¡Œä¸šæŒ‡æ•°ã€æ™¯æ°”åº¦åŠè½®åŠ¨è§„å¾‹ï¼ŒæŠŠæ¡äº§ä¸šæœºä¼š',
                'technical': 'ç²¾é€šè¶‹åŠ¿åˆ†æã€æ”¯æ’‘é˜»åŠ›ä½åŠé‡ä»·å…³ç³»ï¼Œè¯†åˆ«ä¹°å–ä¿¡å·',
                'funds': 'ç›‘æ§åŒ—å‘èµ„é‡‘ã€ä¸»åŠ›èµ„é‡‘åŠèèµ„èåˆ¸åŠ¨å‘ï¼Œè¿½è¸ªèµ„é‡‘æµå‘',
                'fundamental': 'è´¢åŠ¡æŠ¥è¡¨åˆ†æã€ä¼°å€¼æ¨¡å‹åŠä»·å€¼å‘ç°ï¼Œè¯„ä¼°æŠ•èµ„ä»·å€¼',
                'manager_fundamental': 'æ•´åˆå®è§‚ã€è¡Œä¸šã€åŸºæœ¬é¢è§‚ç‚¹ï¼Œå½¢æˆç»¼åˆåˆ¤æ–­',
                'manager_momentum': 'æ•´åˆæŠ€æœ¯é¢å’Œèµ„é‡‘é¢åˆ†æï¼Œåˆ¤æ–­çŸ­æœŸåŠ¨èƒ½',
                'risk_system': 'è¯†åˆ«ç³»ç»Ÿæ€§å±æœºä¸æµåŠ¨æ€§é—®é¢˜ï¼Œé¢„è­¦å¸‚åœºé£é™©',
                'risk_portfolio': 'ç®¡ç†ç»„åˆé›†ä¸­åº¦ã€å›æ’¤åŠæ­¢æŸç­–ç•¥ï¼Œæ§åˆ¶é£é™©æš´éœ²',
                'gm': 'æ‹¥æœ‰æœ€ç»ˆå†³ç­–æƒï¼Œç»¼åˆæ”¶ç›Šä¸é£é™©ï¼Œåšå”¯ä¸€æŒ‡ä»¤'
            };
            return descriptions[agentId] || 'ä¸“ä¸šåˆ†æå¸ˆ';
        }
        
        let configMode = false;
        function toggleConfig() {
            configMode = !configMode;
            document.querySelectorAll('.agent-config').forEach(el => {
                el.classList.toggle('hidden', !configMode);
            });
        }
        
        // æ¨¡å‹ç®¡ç†
        let allModels = [];
        let selectedModelIds = new Set();
        let currentModelTypeFilter = 'all';
        
        function openModelManager() {
            document.getElementById('modelManagerModal').classList.remove('hidden');
            renderModelList();
        }
        
        function closeModelManager() {
            document.getElementById('modelManagerModal').classList.add('hidden');
        }
        
        function filterModelType(type) {
            currentModelTypeFilter = type;
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.model-type-filter').forEach(btn => {
                if (btn.dataset.type === type) {
                    btn.className = 'model-type-filter px-3 py-1 bg-blue-600 rounded-lg text-xs';
                } else {
                    btn.className = 'model-type-filter px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-xs';
                }
            });
            renderModelList();
        }
        
        function renderModelList() {
            const searchTerm = document.getElementById('modelSearch')?.value.toLowerCase() || '';
            const modelList = document.getElementById('modelList');
            
            let filteredModels = allModels;
            
            // ç±»å‹ç­›é€‰
            if (currentModelTypeFilter !== 'all') {
                filteredModels = filteredModels.filter(model => 
                    model.name.toLowerCase().includes(currentModelTypeFilter.toLowerCase())
                );
            }
            
            // æœç´¢ç­›é€‰
            filteredModels = filteredModels.filter(model => 
                model.name.toLowerCase().includes(searchTerm) || 
                model.label.toLowerCase().includes(searchTerm)
            );
            
            modelList.innerHTML = filteredModels.map(model => `
                <label class="flex items-center gap-3 p-3 bg-slate-800 hover:bg-slate-700 rounded-lg cursor-pointer transition-colors">
                    <input type="checkbox" 
                           class="model-checkbox w-4 h-4 text-blue-600 bg-slate-900 border-slate-600 rounded focus:ring-blue-500" 
                           data-model-id="${model.name}" 
                           ${selectedModelIds.has(model.name) ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="text-white text-sm font-medium">${model.label}</div>
                        <div class="text-xs text-slate-400">${model.provider} | ${model.name}</div>
                    </div>
                </label>
            `).join('');
            
            document.getElementById('totalModels').textContent = allModels.length;
            document.getElementById('selectedModels').textContent = selectedModelIds.size;
            
            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            document.querySelectorAll('.model-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedModelIds.add(this.dataset.modelId);
                    } else {
                        selectedModelIds.delete(this.dataset.modelId);
                    }
                    document.getElementById('selectedModels').textContent = selectedModelIds.size;
                });
            });
        }
        
        function selectAllModels() {
            allModels.forEach(model => selectedModelIds.add(model.name));
            renderModelList();
        }
        
        function deselectAllModels() {
            selectedModelIds.clear();
            renderModelList();
        }
        
        function saveModelSelection() {
            // æ›´æ–° MODEL_OPTIONS
            const newModelOptions = allModels.filter(model => selectedModelIds.has(model.name));
            MODEL_OPTIONS.length = 0;
            MODEL_OPTIONS.push(...newModelOptions);
            
            // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰æ¡†
            document.querySelectorAll('.model-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = MODEL_OPTIONS.map(opt => 
                    `<option value="${opt.name}" data-provider="${opt.provider}">${opt.label}</option>`
                ).join('');
                // å°è¯•æ¢å¤åŸå€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é€‰ç¬¬ä¸€ä¸ª
                if (MODEL_OPTIONS.find(m => m.name === currentValue)) {
                    select.value = currentValue;
                } else if (MODEL_OPTIONS.length > 0) {
                    select.value = MODEL_OPTIONS[0].name;
                }
            });
            
            // ä¿å­˜åˆ°æ–‡ä»¶
            saveAgentConfigs();
            
            alert(`âœ… å·²ä¿å­˜ ${selectedModelIds.size} ä¸ªæ¨¡å‹`);
            closeModelManager();
        }

        // ä¿å­˜é…ç½®ï¼ˆæ™ºèƒ½ä½“ + æ¨¡å‹é€‰æ‹©ï¼‰
        async function saveAgentConfigs() {
            try {
                const configData = {
                    agents: appState.agentConfigs.map(config => ({
                        id: config.id,
                        modelName: config.modelName,
                        modelProvider: config.modelProvider,
                        temperature: config.temperature
                    })),
                    selectedModels: [...selectedModelIds]
                };
                
                const response = await fetch(`${API_BASE}/api/config/agents`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('âœ… é…ç½®å·²ä¿å­˜åˆ°æ–‡ä»¶');
                } else {
                    console.error('âŒ ä¿å­˜å¤±è´¥:', data.error);
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', error);
            }
        }
        
        // ä»æ–‡ä»¶åŠ è½½é…ç½®ï¼ˆæ™ºèƒ½ä½“ + æ¨¡å‹é€‰æ‹©ï¼‰
        async function loadAgentConfigs() {
            try {
                const response = await fetch(`${API_BASE}/api/config/agents`);
                const result = await response.json();
                
                if (!result.success || !result.data) {
                    console.log('â„¹ï¸ æ²¡æœ‰ä¿å­˜çš„é…ç½®');
                    return;
                }
                
                const data = result.data;
                
                // åŠ è½½æ™ºèƒ½ä½“é…ç½®
                if (data.agents && data.agents.length > 0) {
                    data.agents.forEach(savedConfig => {
                        const agentConfig = appState.agentConfigs.find(c => c.id === savedConfig.id);
                        if (agentConfig) {
                            agentConfig.modelName = savedConfig.modelName;
                            agentConfig.modelProvider = savedConfig.modelProvider;
                            agentConfig.temperature = savedConfig.temperature;
                            
                            // æ›´æ–°ç•Œé¢
                            const select = document.querySelector(`.model-select[data-agent-id="${savedConfig.id}"]`);
                            if (select) select.value = savedConfig.modelName;
                            
                            const tempSlider = document.querySelector(`.custom-range[data-agent-id="${savedConfig.id}"]`);
                            if (tempSlider) {
                                tempSlider.value = savedConfig.temperature;
                                const tempDisplay = tempSlider.previousElementSibling?.querySelector('.temp-display');
                                if (tempDisplay) tempDisplay.textContent = savedConfig.temperature.toFixed(1);
                            }
                        }
                    });
                    console.log(`âœ… å·²æ¢å¤ ${data.agents.length} ä¸ªæ™ºèƒ½ä½“é…ç½®`);
                }
                
                // åŠ è½½æ¨¡å‹é€‰æ‹©
                if (data.selectedModels && data.selectedModels.length > 0) {
                    selectedModelIds = new Set(data.selectedModels);
                    console.log(`âœ… å·²æ¢å¤ ${data.selectedModels.length} ä¸ªæ¨¡å‹é€‰æ‹©`);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°APIçŠ¶æ€ç‚¹
        function updateApiStatusDot(apiName, status) {
            const dotEl = document.getElementById(`status-dot-${apiName}`);
            if (!dotEl) return;
            
            // çŠ¶æ€: unconfigured(ç°è‰²), error(çº¢è‰²), success(ç»¿è‰²)
            const colors = {
                unconfigured: 'bg-slate-500',
                error: 'bg-red-500 animate-pulse',
                success: 'bg-green-500'
            };
            
            dotEl.className = `w-2 h-2 rounded-full ${colors[status] || 'bg-slate-500'}`;
        }
        
        // åŠ è½½åç«¯é…ç½®
        async function loadBackendConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/config`);
                const data = await response.json();
                
                if (data.configured) {
                    // æ˜¾ç¤ºå·²é…ç½®çŠ¶æ€
                    Object.entries(data.configured).forEach(([key, configured]) => {
                        const statusEl = document.getElementById(`${key}-status`);
                        if (statusEl && configured) {
                            statusEl.textContent = '(âœ… å·²é…ç½®)';
                            // è®¾ç½®è¾“å…¥æ¡†ä¸ºplaceholder
                            const inputEl = document.getElementById(`${key}Key`);
                            if (inputEl) {
                                inputEl.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (åç«¯å·²é…ç½®)';
                            }
                            // æ›´æ–°çŠ¶æ€ç‚¹ä¸ºç»¿è‰²ï¼ˆå·²é…ç½®ï¼Œä½†è¿˜æœªéªŒè¯ï¼‰
                            updateApiStatusDot(key, 'success');
                        } else {
                            // æœªé…ç½®ï¼Œä¿æŒç°è‰²
                            updateApiStatusDot(key, 'unconfigured');
                        }
                    });
                }
                
                console.log('âœ… åç«¯é…ç½®åŠ è½½æˆåŠŸ:', data);
            } catch (error) {
                console.error('âŒ åŠ è½½åç«¯é…ç½®å¤±è´¥:', error);
                // æ‰€æœ‰APIè®¾ç½®ä¸ºé”™è¯¯çŠ¶æ€
                ['gemini', 'deepseek', 'qwen', 'siliconflow', 'juhe'].forEach(key => {
                    updateApiStatusDot(key, 'error');
                });
            }
        }
        
        // åŠ è½½ç¡…åŸºæµåŠ¨æ¨¡å‹
        async function loadSiliconFlowModels() {
            try {
                const response = await fetch(`${API_BASE}/api/ai/siliconflow-models`);
                const data = await response.json();
                
                if (data.success && data.models) {
                    // å°†æ‰€æœ‰æ¨¡å‹æ·»åŠ åˆ° allModels
                    data.models.forEach(model => {
                        const modelData = {
                            provider: 'SILICONFLOW',
                            name: model.id,
                            label: model.label || model.id
                        };
                        if (!allModels.find(m => m.name === model.id)) {
                            allModels.push(modelData);
                        }
                    });
                    // å¦‚æœæ²¡æœ‰ä»æ–‡ä»¶åŠ è½½æ¨¡å‹é€‰æ‹©ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    if (selectedModelIds.size === 0) {
                        // é»˜è®¤é€‰ä¸­åŸºç¡€æ¨¡å‹ + å‰20ä¸ª
                        MODEL_OPTIONS.forEach(m => selectedModelIds.add(m.name));
                        allModels.slice(0, 20).forEach(m => selectedModelIds.add(m.name));
                    }
                    
                    // æ›´æ–° MODEL_OPTIONS ä¸ºé€‰ä¸­çš„æ¨¡å‹
                    MODEL_OPTIONS.length = 0;
                    MODEL_OPTIONS.push(...allModels.filter(m => selectedModelIds.has(m.name)));
                    
                    // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰æ¡†
                    document.querySelectorAll('.model-select').forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = MODEL_OPTIONS.map(opt => 
                            `<option value="${opt.name}" data-provider="${opt.provider}">${opt.label}</option>`
                        ).join('');
                        if (MODEL_OPTIONS.find(m => m.name === currentValue)) {
                            select.value = currentValue;
                        }
                    });
                    
                    console.log(`âœ… åŠ è½½äº† ${allModels.length} ä¸ªæ¨¡å‹ï¼Œå·²é€‰ä¸­ ${selectedModelIds.size} ä¸ª`);
                }
            } catch (error) {
                console.error('âŒ åŠ è½½ç¡…åŸºæµåŠ¨æ¨¡å‹å¤±è´¥:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 4ä¸ªé˜¶æ®µçš„ç½‘æ ¼å®¹å™¨
            const stage1Grid = document.getElementById('stage1Grid');
            const stage2Grid = document.getElementById('stage2Grid');
            const stage3Grid = document.getElementById('stage3Grid');
            const stage4Grid = document.getElementById('stage4Grid');
            
            AGENTS.forEach((agent, index) => {
                const card = document.createElement('div');
                card.className = `${colorMap[agent.color] || 'gradient-card-blue'} rounded-xl p-4 transition-all duration-300 hover:scale-105 hover:shadow-xl`;
                card.id = `agent-${agent.id}`;
                
                card.innerHTML = `
                    <div class="mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <div class="text-2xl">${agent.icon}</div>
                                <div class="font-semibold text-white text-sm whitespace-nowrap">${agent.title}</div>
                            </div>
                            <span class="status-badge px-2 py-1 rounded-full text-xs font-medium bg-slate-700 text-slate-300 whitespace-nowrap">å¾…å‘½</span>
                        </div>
                        <div class="flex items-center justify-between pl-8">
                            <div class="text-xs text-slate-400 uppercase tracking-wide">${agent.role}</div>
                            <div class="token-usage text-xs text-slate-500" style="font-family: 'Consolas', monospace;"></div>
                        </div>
                    </div>
                    
                    <div class="agent-config hidden mb-3 space-y-3 p-3 bg-slate-900/50 rounded-lg">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1.5">æ¨¡å‹ (Model)</label>
                            <select class="model-select w-full px-2 py-1.5 bg-slate-800 border border-slate-700 rounded text-xs text-white" data-agent-id="${agent.id}">
                                ${MODEL_OPTIONS.map(opt => 
                                    `<option value="${opt.name}" data-provider="${opt.provider}" ${opt.name === agent.modelName ? 'selected' : ''}>${opt.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-1.5">
                                <label class="text-xs text-slate-400">éšæœºæ€§ (Temp)</label>
                                <span class="temp-display font-mono text-xs text-blue-400 font-semibold">${agent.temperature}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-500">ä¸¥è°¨</span>
                                <input type="range" class="custom-range flex-1" min="0" max="1" step="0.1" value="${agent.temperature}" data-agent-id="${agent.id}">
                                <span class="text-[10px] text-slate-500">å‘æ•£</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="agent-content bg-slate-900/50 rounded-lg p-3 min-h-[250px] max-h-[500px] overflow-y-auto text-sm text-white leading-relaxed" style="font-family: 'Microsoft YaHei', sans-serif;">
                        <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-slate-700/50">
                        <p class="text-xs text-slate-500 leading-relaxed">${getAgentDescription(agent.id)}</p>
                    </div>
                `;
                
                // æ ¹æ®ç´¢å¼•åˆ†é…åˆ°ä¸åŒé˜¶æ®µ
                if (index < 5) {
                    stage1Grid.appendChild(card); // ç¬¬ä¸€é˜¶æ®µï¼š5ä¸ªåˆ†æå¸ˆ
                } else if (index < 7) {
                    stage2Grid.appendChild(card); // ç¬¬äºŒé˜¶æ®µï¼š2ä¸ªç»ç†
                } else if (index < 9) {
                    stage3Grid.appendChild(card);
                } else {
                    stage4Grid.appendChild(card);
                }
            });
            
            // ç»‘å®šæ¨¡å‹é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.model-select').forEach(select => {
                select.addEventListener('change', function(e) {
                    const agentId = e.target.dataset.agentId;
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    const modelName = selectedOption.value;
                    const modelProvider = selectedOption.dataset.provider;
                    const agentConfig = appState.agentConfigs.find(c => c.id === agentId);
                    if (agentConfig) {
                        agentConfig.modelName = modelName;
                        agentConfig.modelProvider = modelProvider;
                        saveAgentConfigs();
                    }
                });
            });
            
            // ç»‘å®šæ¸©åº¦æ»‘å—äº‹ä»¶
            document.querySelectorAll('.custom-range').forEach(tempSlider => {
                const tempDisplay = tempSlider.previousElementSibling?.querySelector('.temp-display');
                tempSlider.addEventListener('input', function(e) {
                    const agentId = e.target.dataset.agentId;
                    const value = parseFloat(e.target.value);
                    tempDisplay.textContent = value.toFixed(1);
                    const agentConfig = appState.agentConfigs.find(c => c.id === agentId);
                    if (agentConfig) {
                        agentConfig.temperature = value;
                        saveAgentConfigs();
                    }
                });
            });
            
            console.log('âœ… 10ä¸ªæ™ºèƒ½ä½“å¡ç‰‡å·²åˆ›å»ºï¼ˆç²¾ç¾ç‰ˆï¼‰');
            
            // åŠ è½½åç«¯é…ç½®å’Œæ¨¡å‹
            loadBackendConfig();
            loadSiliconFlowModels();
            
            // åŠ è½½ä¿å­˜çš„é…ç½®
            loadAgentConfigs();
            
            // ç»‘å®šæ¨¡å‹æœç´¢
            document.getElementById('modelSearch')?.addEventListener('input', renderModelList);
        });
        
        // é‡å†™çŠ¶æ€æ›´æ–°å‡½æ•°ä»¥é€‚é…æ–°æ ·å¼
        function updateAgentStatus(agentId, status, content = null, usage = null) {
            const card = document.getElementById(`agent-${agentId}`);
            if (!card) return;

            const statusEl = card.querySelector('.status-badge');
            const contentEl = card.querySelector('.agent-content');
            const tokenEl = card.querySelector('.token-usage');
            const modelSelect = card.querySelector('.model-select');
            const tempSlider = card.querySelector('.custom-range');

            const statusConfig = {
                idle: { class: 'bg-slate-700 text-slate-300', text: 'å¾…å‘½' },
                loading: { class: 'bg-yellow-500/20 text-yellow-400 animate-pulse', text: 'åˆ†æä¸­...' },
                success: { class: 'bg-green-500/20 text-green-400', text: 'å®Œæˆ' },
                error: { class: 'bg-red-500/20 text-red-400', text: 'é”™è¯¯' }
            };

            const config = statusConfig[status];
            statusEl.className = `status-badge px-2 py-1 rounded-full text-xs font-medium ${config.class}`;
            statusEl.textContent = config.text;
            
            // åˆ†ææ—¶ç¦ç”¨æ¨¡å‹å’Œæ¸©åº¦ä¿®æ”¹
            if (status === 'loading') {
                if (modelSelect) modelSelect.disabled = true;
                if (tempSlider) tempSlider.disabled = true;
            } else if (status === 'success' || status === 'error' || status === 'idle') {
                if (modelSelect) modelSelect.disabled = false;
                if (tempSlider) tempSlider.disabled = false;
            }

            // æ›´æ–°tokenæ˜¾ç¤º
            if (usage && tokenEl) {
                tokenEl.innerHTML = `ğŸ“Š ${usage.total_tokens} tokens`;
                tokenEl.title = `è¾“å…¥: ${usage.prompt_tokens} | è¾“å‡º: ${usage.completion_tokens}`;
            }
            
            // æ›´æ–°å†…å®¹åŒºåŸŸ
            if (status === 'loading' && !content) {
                // æ˜¾ç¤ºéª¨æ¶å±åŠ è½½åŠ¨ç”»
                contentEl.innerHTML = `
                    <div class="skeleton skeleton-line" style="width: 100%;"></div>
                    <div class="skeleton skeleton-line" style="width: 95%;"></div>
                    <div class="skeleton skeleton-line" style="width: 90%;"></div>
                    <div class="skeleton skeleton-line" style="width: 85%;"></div>
                    <div class="skeleton skeleton-line" style="width: 95%;"></div>
                    <div class="skeleton skeleton-line" style="width: 80%;"></div>
                    <div class="skeleton skeleton-line" style="width: 88%;"></div>
                    <div class="skeleton skeleton-line" style="width: 92%;"></div>
                    <div class="skeleton skeleton-line" style="width: 75%;"></div>
                    <div class="skeleton skeleton-line" style="width: 96%;"></div>
                    <div class="skeleton skeleton-line" style="width: 82%;"></div>
                    <div class="skeleton skeleton-line" style="width: 90%;"></div>
                `;
            } else if (content !== null && content !== '') {
                if (status === 'success') {
                    if (!typeWriters[agentId]) typeWriters[agentId] = new TypeWriter(contentEl, content, 15);
                    else { typeWriters[agentId].text = content; typeWriters[agentId].index = 0; }
                    typeWriters[agentId].start();
                } else {
                    contentEl.innerHTML = content;
                }
            }
        }
    </script>
</body>
</html>
